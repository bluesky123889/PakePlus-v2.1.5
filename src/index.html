<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>精简笔记应用 - 您的私人知识库</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        :root {
            --primary-color: #4f46e5;
            --primary-light: #e0e7ff;
            --primary-dark: #4338ca;
            --secondary-color: #f8fafc;
            --text-color: #334155;
            --text-light: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --radius: 8px;
            --completed-color: #10b981;
            --error-color: #ef4444;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --login-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        body {
            background-color: #f1f5f9;
            color: var(--text-color);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }
        
        /* 登录页面样式 */
        .login-container {
            display: flex;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }
        
        /* 左侧介绍区 */
        .login-info {
            flex: 1;
            background: var(--login-bg);
            color: white;
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        
        .login-info::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            opacity: 0.3;
            animation: float 20s linear infinite;
        }
        
        .login-info-content {
            position: relative;
            z-index: 2;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .app-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 40px;
        }
        
        .app-logo-icon {
            font-size: 3rem;
            background: rgba(255, 255, 255, 0.2);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .app-logo-text h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            font-weight: 700;
        }
        
        .app-logo-text p {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .features-list {
            margin: 40px 0;
        }
        
        .feature-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            font-size: 1rem;
        }
        
        .feature-icon {
            background: rgba(255, 255, 255, 0.2);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .feature-text h4 {
            font-size: 1.1rem;
            margin-bottom: 3px;
            font-weight: 600;
        }
        
        .feature-text p {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        .login-footer {
            margin-top: 50px;
            font-size: 0.8rem;
            opacity: 0.8;
            text-align: center;
        }
        
        /* 右侧登录区 */
        .login-form-container {
            flex: 1;
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 40px;
            position: relative;
            overflow-y: auto;
        }
        
        .login-form-wrapper {
            max-width: 400px;
            width: 100%;
            margin: 0 auto;
            animation: slideInRight 0.6s ease;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .login-header h2 {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .form-input {
            width: 100%;
            padding: 14px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.2s;
            background-color: #f9fafb;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: white;
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        /* 自定义文件上传样式 */
        .file-upload-container {
            position: relative;
            width: 100%;
        }
        
        .file-upload-input {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }
        
        .file-upload-label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background-color: #f9fafb;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-upload-label:hover {
            background-color: var(--secondary-color);
            border-color: var(--primary-color);
        }
        
        .file-upload-label.drag-over {
            background-color: var(--primary-light);
            border-color: var(--primary-color);
            border-style: dashed;
        }
        
        .file-upload-text {
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        .file-upload-button {
            background-color: var(--primary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .file-name {
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--primary-color);
            font-weight: 500;
            padding-left: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 15px 0;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        
        .custom-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            margin-right: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .checkbox-label input:checked + .custom-checkbox {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .checkbox-label input:checked + .custom-checkbox::after {
            content: '✓';
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .checkbox-label input {
            display: none;
        }
        
        .login-btn {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 16px;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .login-btn:hover:not(:disabled) {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .login-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
        
        .login-btn-loading .btn-text {
            visibility: hidden;
        }
        
        .login-btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .login-links {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            font-size: 0.85rem;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .login-link {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .login-link:hover {
            text-decoration: underline;
            color: var(--primary-dark);
        }
        
        .error-message {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            padding: 12px 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .success-message {
            background-color: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            padding: 12px 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            font-size: 0.9rem;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        /* 主应用容器 */
        .app-container {
            display: flex;
            height: 100%;
            max-width: 1600px;
            margin: 0 auto;
            overflow: hidden;
            display: none;
        }
        
        /* 侧边栏样式 */
        .sidebar {
            width: 300px;
            background-color: white;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 10;
            flex-shrink: 0;
        }
        
        .sidebar-hidden .sidebar {
            transform: translateX(-100%);
            margin-left: -300px;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--primary-color);
            color: white;
            position: relative;
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sidebar-header h1 i {
            font-size: 1.8rem;
        }
        
        /* 新增：侧边栏控制按钮 */
        .sidebar-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sidebar-toggle-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .sidebar-toggle-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: white;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .user-details {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .logout-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .new-note-btn {
            background-color: white;
            color: var(--primary-color);
            border: none;
            padding: 12px 20px;
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            margin-top: 15px;
            transition: all 0.2s;
            box-shadow: var(--shadow);
        }
        
        .new-note-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 20px -5px rgba(0, 0, 0, 0.1);
        }
        
        .notes-list-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* 搜索框样式 */
        .search-container {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            background-color: white;
            position: relative;
        }
        
        .search-box {
            position: relative;
            width: 100%;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 10px;
            color: var(--text-light);
            font-size: 0.9rem;
            height: 20px;
            width: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }
        
        .clear-search {
            position: absolute;
            right: 38px;
            top: 10px;
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }
        
        .clear-search.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .clear-search:hover {
            color: var(--error-color);
            background-color: rgba(239, 68, 68, 0.1);
            border-radius: 50%;
        }
        
        .search-stats {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 8px;
            text-align: center;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .search-stats.visible {
            display: block;
        }
        
        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .note-item {
            padding: 15px;
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            background-color: var(--secondary-color);
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .note-item:hover {
            background-color: var(--primary-light);
            border-left-color: var(--primary-color);
        }
        
        .note-item.active {
            background-color: var(--primary-light);
            border-left-color: var(--primary-color);
            font-weight: 600;
        }
        
        .note-title {
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.7rem;
            color: var(--text-light);
        }
        
        .note-date {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .edit-time {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .note-word-count {
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--primary-color);
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.65rem;
            white-space: nowrap;
        }
        
        /* 主内容区域样式 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: margin-left 0.3s ease;
        }
        
        /* 新增：侧边栏隐藏时的工具栏样式 */
        .sidebar-hidden .toolbar {
            padding-left: 20px;
        }
        
        .sidebar-hidden .main-content {
            margin-left: 0;
        }
        
        /* 新增：侧边栏显示按钮 */
        .show-sidebar-btn {
            display: none;
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            position: absolute;
            left: 20px;
            top: 20px;
            z-index: 10;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }
        
        .show-sidebar-btn:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }
        
        .sidebar-hidden .show-sidebar-btn {
            display: flex;
        }
        
        .toolbar {
            padding: 12px 20px 12px 60px;
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
            position: relative;
        }
        
        .note-title-input {
            border: none;
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-color);
            width: 100%;
            padding: 5px 10px;
            background-color: transparent;
            transition: all 0.2s;
            margin-left: 40px;
        }
        
        .note-title-input:focus {
            outline: none;
            background-color: var(--primary-light);
            border-radius: var(--radius);
        }
        
        .toolbar-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .toolbar-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }
        
        .toolbar-btn:hover:not(:disabled) {
            background-color: var(--secondary-color);
            color: var(--primary-color);
        }
        
        .toolbar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .toolbar-btn.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .about-btn, .help-btn, .settings-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .about-btn:hover, .help-btn:hover, .settings-btn:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
        }
        
        .editor-container {
            flex: 1;
            padding: 15px 20px;
            overflow-y: auto;
            position: relative;
        }
        
        .note-editor {
            width: 100%;
            height: 100%;
            border: none;
            font-size: 1rem;
            line-height: 1.7;
            resize: none;
            background-color: transparent;
            color: var(--text-color);
            padding: 5px;
            font-family: 'Segoe UI', system-ui, monospace;
            transition: all 0.2s;
        }
        
        .note-editor:focus {
            outline: none;
        }
        
        .preview-container {
            width: 100%;
            height: 100%;
            padding: 10px;
            overflow-y: auto;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .preview-container h1 {
            margin-top: 0.5em;
            margin-bottom: 0.3em;
            font-size: 1.8rem;
        }
        
        .preview-container h2 {
            margin-top: 0.5em;
            margin-bottom: 0.3em;
            font-size: 1.5rem;
        }
        
        .preview-container h3 {
            margin-top: 0.5em;
            margin-bottom: 0.3em;
            font-size: 1.2rem;
        }
        
        .preview-container p {
            margin-bottom: 0.4em;
            line-height: 1.5;
        }
        
        .preview-container ul:not(.task-list), 
        .preview-container ol {
            margin-left: 1.5em;
            margin-bottom: 0.5em;
        }
        
        .preview-container ul:not(.task-list) li,
        .preview-container ol li {
            margin-bottom: 0.1em;
        }
        
        .preview-container blockquote {
            border-left: 4px solid var(--primary-color);
            padding-left: 1em;
            margin-left: 0;
            color: var(--text-light);
            font-style: italic;
            margin-bottom: 0.5em;
        }
        
        .preview-container code {
            background-color: var(--secondary-color);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9em;
        }
        
        .preview-container pre {
            background-color: var(--secondary-color);
            padding: 10px;
            border-radius: var(--radius);
            overflow-x: auto;
            margin-bottom: 0.5em;
            font-size: 0.9em;
        }
        
        /* 任务清单样式 */
        .task-list {
            list-style-type: none;
            margin-left: 0;
            padding-left: 0;
            margin-bottom: 0.5em;
        }
        
        .task-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            padding: 2px 0;
            min-height: 24px;
        }
        
        .task-checkbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            min-width: 18px;
            accent-color: var(--completed-color);
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.2s;
        }
        
        .task-text {
            flex: 1;
            padding-right: 8px;
            line-height: 1.5;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            min-height: 22px;
            transition: all 0.2s;
        }
        
        .task-text.completed {
            text-decoration: line-through;
            color: var(--text-light);
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-light);
            text-align: center;
            padding: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        .empty-state i {
            font-size: 3.5rem;
            margin-bottom: 15px;
            color: var(--border-color);
            animation: pulse 2s infinite;
        }
        
        .empty-state h2 {
            margin-bottom: 8px;
            color: var(--text-color);
            font-size: 1.3rem;
        }
        
        /* 移动端适配 */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.3rem;
            color: white;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .mobile-menu-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        @media (max-width: 1024px) {
            .login-info {
                display: none;
            }
            
            .login-form-container {
                padding: 20px;
            }
            
            .login-form-wrapper {
                max-width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                position: relative;
            }
            
            .sidebar {
                position: absolute;
                top: 0;
                left: 0;
                bottom: 0;
                width: 85%;
                max-width: 320px;
                transform: translateX(-100%);
                box-shadow: var(--shadow);
                z-index: 1000;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .note-title-input {
                font-size: 1.2rem;
                margin-left: 0;
            }
            
            .editor-container {
                padding: 12px;
            }
            
            .note-meta {
                flex-direction: column;
                align-items: flex-start;
                gap: 3px;
            }
            
            .toolbar-actions {
                gap: 4px;
            }
            
            .search-icon {
                right: 12px;
                top: 10px;
            }
            
            .clear-search {
                right: 35px;
                top: 10px;
            }
            
            .sidebar-controls {
                display: none;
            }
            
            .show-sidebar-btn {
                left: 10px;
                top: 10px;
            }
            
            .sidebar-hidden .toolbar {
                padding-left: 60px;
            }
            
            .toolbar {
                padding: 12px 10px 12px 60px;
            }
        }
        
        /* 状态消息 */
        .status-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(10px);
            background-color: var(--primary-color);
            color: white;
            padding: 12px 24px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            opacity: 0;
            transition: all 0.3s;
            z-index: 1100;
            text-align: center;
            min-width: 200px;
            max-width: 80%;
            pointer-events: none;
        }
        
        .status-message.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* 对话框通用样式 */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(2px);
        }
        
        .dialog-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .dialog-content {
            background-color: white;
            padding: 30px;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            position: relative;
            animation: slideIn 0.3s ease;
        }
        
        .dialog-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .dialog-header h3 {
            font-size: 1.4rem;
            color: var(--primary-color);
        }
        
        .dialog-close-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        
        .dialog-close-btn:hover {
            background-color: var(--secondary-color);
            color: var(--primary-color);
        }
        
        .dialog-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 25px;
        }
        
        .dialog-btn {
            padding: 8px 16px;
            border-radius: var(--radius);
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .dialog-btn.primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .dialog-btn.primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .dialog-btn.secondary {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }
        
        .dialog-btn.secondary:hover {
            background-color: #e2e8f0;
        }
        
        .dialog-btn.danger {
            background-color: var(--error-color);
            color: white;
        }
        
        .dialog-btn.danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        
        .dialog-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 重新设计的设置对话框样式 */
        .settings-dialog {
            max-width: 800px;
            max-height: 85vh;
            padding: 20px;
        }
        
        .settings-layout {
            display: flex;
            gap: 20px;
            height: 500px;
        }
        
        .settings-nav {
            width: 200px;
            border-right: 1px solid var(--border-color);
            padding-right: 15px;
            overflow-y: auto;
        }
        
        .settings-nav-item {
            padding: 12px 15px;
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .settings-nav-item:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }
        
        .settings-nav-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .settings-nav-item.active .nav-icon {
            color: white;
        }
        
        .nav-icon {
            color: var(--primary-color);
            width: 20px;
            text-align: center;
        }
        
        .settings-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .settings-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .settings-section.active {
            display: block;
        }
        
        .settings-section h4 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-light);
        }
        
        .setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 12px;
            background-color: var(--secondary-color);
            border-radius: var(--radius);
            transition: all 0.2s;
        }
        
        .setting-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 10px -3px rgba(0, 0, 0, 0.1);
        }
        
        .setting-info {
            flex: 1;
        }
        
        .setting-title {
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .setting-description {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        /* 开关样式 */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            margin-left: 15px;
        }
        
        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .toggle-checkbox:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        .toggle-checkbox:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        /* 重新设计的帮助对话框样式 */
        .help-dialog {
            max-width: 900px;
            max-height: 85vh;
            padding: 20px;
        }
        
        .help-layout {
            display: flex;
            gap: 20px;
            height: 500px;
        }
        
        .help-nav {
            width: 200px;
            border-right: 1px solid var(--border-color);
            padding-right: 15px;
            overflow-y: auto;
        }
        
        .help-nav-item {
            padding: 12px 15px;
            border-radius: var(--radius);
            margin-bottom: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .help-nav-item:hover {
            background-color: var(--primary-light);
            color: var(--primary-color);
        }
        
        .help-nav-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .help-nav-item.active .nav-icon {
            color: white;
        }
        
        .help-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        .help-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .help-section.active {
            display: block;
        }
        
        .help-section h4 {
            color: var(--primary-color);
            margin-bottom: 20px;
            font-size: 1.3rem;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-light);
        }
        
        .help-item {
            margin-bottom: 15px;
            font-size: 0.95rem;
            display: flex;
            align-items: flex-start;
            transition: all 0.2s;
            padding: 8px 0;
        }
        
        .help-item:hover {
            transform: translateX(5px);
        }
        
        .help-icon {
            color: var(--primary-color);
            margin-right: 10px;
            margin-top: 2px;
            min-width: 20px;
        }
        
        .shortcut-key {
            display: inline-block;
            background-color: var(--secondary-color);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85rem;
            margin: 0 4px;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .symbol-examples {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .symbol-example {
            background-color: var(--secondary-color);
            padding: 10px;
            border-radius: var(--radius);
            border-left: 3px solid var(--primary-color);
            transition: all 0.2s;
        }
        
        .symbol-example:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px -3px rgba(0, 0, 0, 0.1);
        }
        
        .symbol-example code {
            font-family: monospace;
            background-color: white;
            padding: 2px 4px;
            border-radius: 3px;
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .symbol-example .description {
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        /* 无笔记时隐藏工具栏 */
        .toolbar.hidden {
            display: none;
        }
        
        /* 符号选择器样式 */
        .symbol-selector {
            position: fixed;
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            max-height: 250px;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            min-width: 300px;
            animation: fadeIn 0.2s ease;
        }
        
        .symbol-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s;
        }
        
        .symbol-item:last-child {
            border-bottom: none;
        }
        
        .symbol-item:hover {
            background-color: var(--primary-light);
        }
        
        .symbol-item.active {
            background-color: var(--primary-color);
            color: white;
        }
        
        .symbol-item.active .symbol-icon {
            color: white;
        }
        
        .symbol-icon {
            color: var(--primary-color);
            width: 20px;
            text-align: center;
        }
        
        .symbol-text {
            flex: 1;
            font-family: 'Segoe UI', system-ui, monospace;
            font-size: 0.9rem;
        }
        
        .symbol-desc {
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        .symbol-item.active .symbol-desc {
            color: rgba(255, 255, 255, 0.8);
        }
        
        /* 字数统计样式 */
        .word-count {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.85rem;
            color: var(--text-light);
            padding: 8px 15px;
            border-top: 1px solid var(--border-color);
            background-color: white;
        }
        
        .word-count-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .word-count-label {
            font-weight: 500;
        }
        
        .word-count-value {
            font-weight: 600;
            color: var(--primary-color);
            min-width: 40px;
            text-align: right;
        }
        
        /* 搜索结果高亮 */
        .search-highlight {
            background-color: rgba(255, 255, 0, 0.3);
            padding: 0 2px;
            border-radius: 2px;
        }
        
        /* 滚动条优化 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--secondary-color);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--text-light);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary-color);
        }
        
        /* 清除账号对话框 */
        .clear-users-dialog {
            max-width: 450px;
        }
        
        .user-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 10px;
        }
        
        .user-list-item {
            padding: 10px;
            border-radius: var(--radius);
            margin-bottom: 8px;
            background-color: var(--secondary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info-small {
            font-size: 0.9rem;
        }
        
        .user-name-small {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .delete-user-btn {
            background: none;
            border: 1px solid var(--error-color);
            color: var(--error-color);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        
        .delete-user-btn:hover {
            background-color: var(--error-color);
            color: white;
        }
        
        /* 导入导出按钮样式 */
        .import-export-buttons {
            display: flex;
            gap: 8px;
        }
        
        /* 导出格式选择样式 */
        .export-format-selector {
            margin: 15px 0;
            padding: 15px;
            background-color: var(--secondary-color);
            border-radius: var(--radius);
        }
        
        .export-format-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .export-format-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .format-option {
            flex: 1;
            min-width: 120px;
        }
        
        .format-radio {
            display: none;
        }
        
        .format-label {
            display: block;
            padding: 12px 15px;
            background-color: white;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .format-radio:checked + .format-label {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .format-label:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px -3px rgba(0, 0, 0, 0.1);
        }
        
        .format-icon {
            font-size: 1.2rem;
            margin-bottom: 5px;
            display: block;
        }
        
        .format-text {
            font-size: 0.9rem;
        }
        
        /* 导出选项对话框 - 提高z-index确保不被遮挡 */
        .export-dialog {
            max-width: 450px;
            z-index: 1001;
        }
        
        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes pulse {
            0% { opacity: 0.8; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
            100% { opacity: 0.8; transform: scale(1); }
        }
        
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(20px, 20px) rotate(360deg); }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 删除确认对话框 */
        .delete-dialog {
            max-width: 400px;
        }
        
        .delete-dialog h3 {
            margin-bottom: 12px;
            font-size: 1.2rem;
        }
        
        .delete-dialog p {
            margin-bottom: 20px;
            color: var(--text-light);
            font-size: 0.95rem;
        }
        
        /* 关于对话框 - 简化版 */
        .about-features {
            margin: 20px 0;
        }
        
        .feature-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }
        
        .feature-item:hover {
            transform: translateX(5px);
        }
        
        .feature-icon {
            color: var(--primary-color);
            margin-right: 10px;
            margin-top: 2px;
            min-width: 20px;
        }
        
        .about-footer {
            margin-top: 25px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
            color: var(--text-light);
            text-align: center;
        }
        
        /* 导入进度条样式 */
        .import-progress {
            margin-top: 15px;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: var(--secondary-color);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-light);
        }
        
        /* 导入结果样式 */
        .import-results {
            margin-top: 15px;
            padding: 12px;
            border-radius: var(--radius);
            background-color: var(--secondary-color);
            display: none;
        }
        
        .import-results.success {
            background-color: rgba(16, 185, 129, 0.1);
            border-left: 3px solid var(--success-color);
        }
        
        .import-results.error {
            background-color: rgba(239, 68, 68, 0.1);
            border-left: 3px solid var(--error-color);
        }
        
        .results-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-color);
        }
        
        .results-list {
            list-style-type: none;
            font-size: 0.85rem;
            color: var(--text-light);
        }
        
        .results-list li {
            margin-bottom: 4px;
            padding-left: 15px;
            position: relative;
        }
        
        .results-list li:before {
            content: "•";
            position: absolute;
            left: 0;
        }
        
        /* 侧边栏隐藏状态 */
        .sidebar-hidden .sidebar {
            transform: translateX(-100%);
            margin-left: -300px;
        }
        
        .sidebar-hidden .sidebar-toggle-btn i {
            transform: rotate(180deg);
        }
        
        .sidebar-hidden .main-content {
            margin-left: 0;
        }
        
        /* 主内容区域扩展 */
        .main-content.expanded {
            margin-left: 0;
        }
        
        /* 导入文件预览 */
        .file-preview {
            margin-top: 10px;
            padding: 10px;
            background-color: var(--secondary-color);
            border-radius: var(--radius);
            border: 1px dashed var(--border-color);
            font-size: 0.85rem;
            color: var(--text-light);
            display: none;
        }
        
        .file-preview h5 {
            margin-bottom: 5px;
            color: var(--primary-color);
        }
        
        .file-preview-content {
            max-height: 100px;
            overflow-y: auto;
            padding: 5px;
            background-color: white;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.8rem;
        }
        
        /* 导入进度指示器 */
        .import-loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .import-loading i {
            font-size: 2rem;
            color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body>
    <!-- 登录页面 -->
    <div class="login-container" id="loginContainer">
        <!-- 左侧介绍区 -->
        <div class="login-info">
            <div class="login-info-content">
                <div class="app-logo">
                    <div class="app-logo-icon">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="app-logo-text">
                        <h1>精简笔记</h1>
                        <p>您的私人知识库</p>
                    </div>
                </div>
                
                <div class="features-list">
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div class="feature-text">
                            <h4>智能输入</h4>
                            <p>支持Markdown符号自动补全，提升编辑效率</p>
                        </div>
                    </div>
                    
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="feature-text">
                            <h4>数据安全</h4>
                            <p>本地存储、账号隔离与注销功能，全面保护隐私</p>
                        </div>
                    </div>
                    
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="feature-text">
                            <h4>任务管理</h4>
                            <p>预览模式支持直接勾选，高效管理待办事项</p>
                        </div>
                    </div>
                    
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <div class="feature-text">
                            <h4>跨端适配</h4>
                            <p>响应式设计完美兼容桌面和移动设备</p>
                        </div>
                    </div>
                    
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="feature-text">
                            <h4>一键预览</h4>
                            <p>实时切换编辑与预览模式，所见即所得</p>
                        </div>
                    </div>
                    
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-keyboard"></i>
                        </div>
                        <div class="feature-text">
                            <h4>快捷操作</h4>
                            <p>完整快捷键和符号选择器，简化编辑流程</p>
                        </div>
                    </div>
                </div>
                
                <div class="login-footer">
                    <p>© 2026 精简笔记应用 v2.0 | 本地存储，安全可靠</p>
                </div>
            </div>
        </div>
        
        <!-- 右侧登录区 -->
        <div class="login-form-container">
            <div class="login-form-wrapper">
                <div class="login-header">
                    <h2>欢迎回来</h2>
                    <p>登录以访问您的私人笔记库</p>
                </div>
                
                <div class="error-message" id="loginError"></div>
                <div class="success-message" id="loginSuccess"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="username">
                            <i class="fas fa-user" style="margin-right: 8px;"></i>账号
                        </label>
                        <input type="text" class="form-input" id="username" placeholder="请输入您的账号" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="password">
                            <i class="fas fa-lock" style="margin-right: 8px;"></i>密码
                        </label>
                        <input type="password" class="form-input" id="password" placeholder="请输入您的密码" required>
                    </div>
                    
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="rememberMe">
                            <span class="custom-checkbox"></span>
                            记住我
                        </label>
                    </div>
                    
                    <button type="submit" class="login-btn" id="loginBtn">
                        <span class="btn-text">登录</span>
                        <i class="fas fa-sign-in-alt"></i>
                    </button>
                    
                    <div class="login-links">
                        <a class="login-link" id="registerLink">
                            <i class="fas fa-user-plus"></i>注册账号
                        </a>
                        <a class="login-link" id="forgotPasswordLink">
                            <i class="fas fa-key"></i>忘记密码
                        </a>
                        <a class="login-link" id="deleteAccountLink">
                            <i class="fas fa-trash-alt"></i>注销账号
                        </a>
                        <a class="login-link" id="clearUsersLink">
                            <i class="fas fa-users-slash"></i>清除已登出账号
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 主应用界面 -->
    <div class="app-container" id="appContainer">
        <!-- 侧边栏显示按钮 -->
        <button class="show-sidebar-btn" id="showSidebarBtn" title="显示侧边栏">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- 侧边栏 -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <h1><i class="fas fa-book"></i> 精简笔记</h1>
                
                <!-- 新增：侧边栏控制按钮 -->
                <div class="sidebar-controls">
                    <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="隐藏/显示侧边栏">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
                
                <!-- 用户信息 -->
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar"></div>
                    <div class="user-details">
                        <div class="user-name" id="userName">用户</div>
                    </div>
                    <button class="logout-btn" id="logoutBtn" title="退出登录">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
                
                <button class="new-note-btn" id="newNoteBtn">
                    <i class="fas fa-plus"></i> 新建笔记
                </button>
            </div>
            
            <div class="notes-list-container">
                <!-- 搜索框 -->
                <div class="search-container">
                    <div class="search-box">
                        <input type="text" class="search-input" id="searchInput" placeholder="搜索笔记标题和内容...">
                        <button class="clear-search" id="clearSearchBtn" title="清除搜索">
                            <i class="fas fa-times"></i>
                        </button>
                        <i class="fas fa-search search-icon"></i>
                        <div class="search-stats" id="searchStats"></div>
                    </div>
                </div>
                
                <!-- 笔记列表 -->
                <div class="notes-list" id="notesList">
                    <!-- 笔记列表将通过JS动态生成 -->
                </div>
                
                <!-- 字数统计 -->
                <div class="word-count" id="wordCount">
                    <div class="word-count-item">
                        <span class="word-count-label">笔记总数:</span>
                        <span class="word-count-value" id="totalNotes">0</span>
                    </div>
                    <div class="word-count-item">
                        <span class="word-count-label">总字数:</span>
                        <span class="word-count-value" id="totalWords">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 主内容区域 -->
        <div class="main-content">
            <div class="toolbar" id="toolbar">
                <input type="text" class="note-title-input" id="noteTitleInput" placeholder="笔记标题">
                <div class="toolbar-actions">
                    <button class="toolbar-btn" id="viewToggleBtn" title="切换视图 (Ctrl+E)">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="toolbar-btn" id="deleteNoteBtn" title="删除笔记 (Ctrl+D)">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="toolbar-btn" id="saveNoteBtn" title="保存笔记 (Ctrl+S)">
                        <i class="fas fa-save"></i>
                    </button>
                    <button class="settings-btn" id="settingsBtn" title="设置 (Ctrl+Comma)">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="help-btn" id="helpBtn" title="使用说明 (Ctrl+H)">
                        <i class="fas fa-question-circle"></i>
                    </button>
                    <button class="about-btn" id="aboutBtn" title="关于 (Ctrl+I)">
                        <i class="fas fa-info-circle"></i>
                    </button>
                </div>
            </div>
            
            <div class="editor-container" id="editorContainer">
                <textarea class="note-editor" id="noteEditor" placeholder="开始输入笔记内容... 支持Markdown格式和任务清单"></textarea>
                <div class="preview-container" id="previewContainer"></div>
            </div>
            
            <!-- 空状态 -->
            <div class="empty-state" id="emptyState">
                <i class="fas fa-sticky-note"></i>
                <h2>还没有笔记</h2>
                <p>点击"新建笔记"按钮创建你的第一个笔记</p>
                <p style="margin-top: 15px; font-size: 0.85rem;">提示：按Ctrl+E切换编辑/预览模式，Ctrl+S保存，Ctrl+F搜索</p>
            </div>
        </div>
    </div>
    
    <!-- 符号选择器 -->
    <div class="symbol-selector" id="symbolSelector"></div>
    
    <!-- 状态消息 -->
    <div class="status-message" id="statusMessage"></div>
    
    <!-- 导出选项对话框 - 提高z-index确保不被遮挡 -->
    <div class="dialog-overlay" id="exportDialog" style="z-index: 1001;">
        <div class="dialog-content export-dialog">
            <button class="dialog-close-btn" id="closeExportBtn" title="关闭">
                <i class="fas fa-times"></i>
            </button>
            <div class="dialog-header">
                <h3><i class="fas fa-download" style="margin-right: 10px;"></i>导出选项</h3>
            </div>
            
            <p style="margin-bottom: 15px; color: var(--text-color); font-size: 0.95rem;">
                请选择导出的文件格式：
            </p>
            
            <div class="export-format-selector">
                <div class="export-format-title">导出格式</div>
                <div class="export-format-options">
                    <div class="format-option">
                        <input type="radio" id="format-json" name="exportFormat" value="json" class="format-radio" checked>
                        <label for="format-json" class="format-label">
                            <i class="fas fa-code format-icon"></i>
                            <span class="format-text">JSON</span>
                        </label>
                    </div>
                    <div class="format-option">
                        <input type="radio" id="format-txt" name="exportFormat" value="txt" class="format-radio">
                        <label for="format-txt" class="format-label">
                            <i class="fas fa-file-alt format-icon"></i>
                            <span class="format-text">TXT</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div style="margin: 20px 0; padding: 12px; background-color: var(--secondary-color); border-radius: var(--radius); font-size: 0.85rem;">
                <p><strong>格式说明：</strong></p>
                <p style="margin-top: 8px;">• <strong>JSON</strong>: 完整备份，包含所有元数据，可用于导入恢复</p>
                <p>• <strong>TXT</strong>: 纯文本格式，仅包含笔记内容，适合阅读和分享</p>
            </div>
            
            <div class="dialog-actions">
                <button type="button" class="dialog-btn secondary" id="cancelExportBtn">
                    <i class="fas fa-times" style="margin-right: 5px;"></i>取消
                </button>
                <button type="button" class="dialog-btn primary" id="confirmExportBtn">
                    <i class="fas fa-download" style="margin-right: 5px;"></i>导出
                </button>
            </div>
        </div>
    </div>
    
    <!-- 注册对话框 -->
    <div class="dialog-overlay" id="registerDialog">
        <div class="dialog-content">
            <button class="dialog-close-btn" id="closeRegisterBtn" title="关闭">
                <i class="fas fa-times"></i>
            </button>
            <div class="dialog-header">
                <h3><i class="fas fa-user-plus" style="margin-right: 10px;"></i>注册账号</h3>
            </div>
            
            <form id="registerForm">
                <div class="form-group">
                    <label class="form-label" for="registerUsername">
                        <i class="fas fa-user" style="margin-right: 8px;"></i>账号
                    </label>
                    <input type="text" class="form-input" id="registerUsername" placeholder="请输入账号（4-20位字符）" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="registerPassword">
                        <i class="fas fa-lock" style="margin-right: 8px;"></i>密码
                    </label>
                    <input type="password" class="form-input" id="registerPassword" placeholder="请输入密码（至少6位）" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="registerConfirmPassword">
                        <i class="fas fa-lock" style="margin-right: 8px;"></i>确认密码
                    </label>
                    <input type="password" class="form-input" id="registerConfirmPassword" placeholder="请再次输入密码" required>
                </div>
                
                <div class="dialog-actions">
                    <button type="button" class="dialog-btn secondary" id="cancelRegisterBtn">
                        <i class="fas fa-times" style="margin-right: 5px;"></i>取消
                    </button>
                    <button type="submit" class="dialog-btn primary" id="confirmRegisterBtn">
                        <i class="fas fa-check" style="margin-right: 5px;"></i>注册
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 忘记密码对话框 -->
    <div class="dialog-overlay" id="forgotPasswordDialog">
        <div class="dialog-content">
            <button class="dialog-close-btn" id="closeForgotPasswordBtn" title="关闭">
                <i class="fas fa-times"></i>
            </button>
            <div class="dialog-header">
                <h3><i class="fas fa-key" style="margin-right: 10px;"></i>重置密码</h3>
            </div>
            
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label class="form-label" for="forgotUsername">
                        <i class="fas fa-user" style="margin-right: 8px;"></i>账号
                    </label>
                    <input type="text" class="form-input" id="forgotUsername" placeholder="请输入要重置密码的账号" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="newPassword">
                        <i class="fas fa-lock" style="margin-right: 8px;"></i>新密码
                    </label>
                    <input type="password" class="form-input" id="newPassword" placeholder="请输入新密码（至少6位）" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="confirmNewPassword">
                        <i class="fas fa-lock" style="margin-right: 8px;"></i>确认新密码
                    </label>
                    <input type="password" class="form-input" id="confirmNewPassword" placeholder="请再次输入新密码" required>
                </div>
                
                <div class="error-message" id="forgotPasswordError"></div>
                
                <div class="dialog-actions">
                    <button type="button" class="dialog-btn secondary" id="cancelForgotPasswordBtn">
                        <i class="fas fa-times" style="margin-right: 5px;"></i>取消
                    </button>
                    <button type="submit" class="dialog-btn primary" id="confirmForgotPasswordBtn">
                        <i class="fas fa-check" style="margin-right: 5px;"></i>重置密码
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 注销账号对话框 -->
    <div class="dialog-overlay" id="deleteAccountDialog">
        <div class="dialog-content">
            <button class="dialog-close-btn" id="closeDeleteAccountBtn" title="关闭">
                <i class="fas fa-times"></i>
            </button>
            <div class="dialog-header">
                <h3><i class="fas fa-exclamation-triangle" style="margin-right: 10px; color: var(--error-color);"></i>注销账号</h3>
            </div>
            
            <div class="error-message" id="deleteAccountError"></div>
            
            <p style="margin-bottom: 15px; color: var(--text-color); font-size: 0.95rem;">
                您即将注销账号 <strong id="deleteAccountName"></strong>。此操作将：
            </p>
            
            <ul style="margin-bottom: 20px; padding-left: 20px; color: var(--text-light); font-size: 0.95rem;">
                <li style="margin-bottom: 8px;">永久删除该账号下的所有笔记数据</li>
                <li style="margin-bottom: 8px;">清除所有个人设置和偏好</li>
                <li>账号将无法再登录使用</li>
            </ul>
            
            <p style="margin-bottom: 20px; color: var(--error-color); font-size: 0.9rem; font-weight: 600;">
                <i class="fas fa-exclamation-circle" style="margin-right: 5px;"></i>
                警告：此操作不可撤销！请谨慎操作。
            </p>
            
            <form id="deleteAccountForm">
                <div class="form-group">
                    <label class="form-label" for="deleteAccountPassword">
                        <i class="fas fa-lock" style="margin-right: 8px;"></i>请输入密码确认
                    </label>
                    <input type="password" class="form-input" id="deleteAccountPassword" placeholder="请输入账号密码以确认注销" required>
                </div>
                
                <div class="dialog-actions">
                    <button type="button" class="dialog-btn secondary" id="cancelDeleteAccountBtn">
                        <i class="fas fa-times" style="margin-right: 5px;"></i>取消
                    </button>
                    <button type="submit" class="dialog-btn danger" id="confirmDeleteAccountBtn">
                        <i class="fas fa-trash-alt" style="margin-right: 5px;"></i>确认注销
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 清除已登出账号对话框 -->
    <div class="dialog-overlay" id="clearUsersDialog">
        <div class="dialog-content clear-users-dialog">
            <button class="dialog-close-btn" id="closeClearUsersBtn" title="关闭">
                <i class="fas fa-times"></i>
            </button>
            <div class="dialog-header">
                <h3><i class="fas fa-users-slash" style="margin-right: 10px;"></i>清除已登出账号</h3>
            </div>
            
            <p style="margin-bottom: 15px; color: var(--text-light); font-size: 0.9rem;">
                以下账号当前未登录，可以安全清除。清除后这些账号的所有数据将被永久删除。
            </p>
            
            <div id="usersList" class="user-list">
                <!-- 用户列表将动态生成 -->
            </div>
            
            <div class="dialog-actions">
                <button type="button" class="dialog-btn secondary" id="cancelClearUsersBtn">
                    <i class="fas fa-times" style="margin-right: 5px;"></i>取消
                </button>
                    <button type="button" class="dialog-btn danger" id="confirmClearAllBtn">
                    <i class="fas fa-trash-alt" style="margin-right: 5px;"></i>清除所有未登录账号
                </button>
            </div>
            
            <p style="margin-top: 20px; color: var(--warning-color); font-size: 0.8rem; text-align: center;">
                <i class="fas fa-exclamation-triangle" style="margin-right: 5px;"></i>
                注意：此操作不可撤销，请谨慎操作
            </p>
        </div>
    </div>
    
    <!-- 删除笔记确认对话框 -->
    <div class="dialog-overlay" id="deleteConfirm">
        <div class="dialog-content delete-dialog">
            <h3><i class="fas fa-trash" style="margin-right: 10px;"></i>删除笔记</h3>
            <p>确定要删除这个笔记吗？此操作无法撤销。</p>
            <div class="dialog-actions">
                <button class="dialog-btn secondary" id="cancelDeleteBtn">
                    <i class="fas fa-times" style="margin-right: 5px;"></i>取消
                </button>
                <button class="dialog-btn danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash-alt" style="margin-right: 5px;"></i>删除
                </button>
            </div>
        </div>
    </div>
    
    <!-- 关于对话框 - 简化版 -->
    <div class="dialog-overlay" id="aboutDialog">
        <div class="dialog-content">
            <button class="dialog-close-btn" id="closeAboutBtn" title="关闭">
                <i class="fas fa-times"></i>
            </button>
            <div class="dialog-header">
                <h3><i class="fas fa-info-circle" style="margin-right: 10px;"></i>精简笔记应用 v2.0</h3>
            </div>
            
            <p style="margin-bottom: 20px;">一款简洁高效的跨平台笔记应用，支持Markdown、任务清单、智能输入等功能。</p>
            
            <!-- 简化的功能列表 -->
            <div class="about-features">
                <div class="feature-item">
                    <div class="feature-icon"><i class="fas fa-check-circle"></i></div>
                    <div><strong>智能输入</strong> - 支持Markdown符号自动补全，提升编辑效率</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon"><i class="fas fa-check-circle"></i></div>
                    <div><strong>数据安全</strong> - 本地存储、账号隔离与注销功能，全面保护隐私</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon"><i class="fas fa-check-circle"></i></div>
                    <div><strong>多格式导出</strong> - 支持JSON、TXT格式导出</div>
                </div>
                <div class="feature-item">
                    <div class="feature-icon"><i class="fas fa-check-circle"></i></div>
                    <div><strong>跨端适配</strong> - 响应式设计完美兼容桌面和移动设备</div>
                </div>
            </div>
            
            <div class="about-footer">
                <p>© 2026 精简笔记应用 v2.0</p>
                <p style="margin-top: 8px; font-size: 0.8rem;">提示：所有数据存储在本地浏览器，请定期使用导出功能备份重要笔记</p>
            </div>
        </div>
    </div>
    
    <!-- 设置对话框 -->
    <div class="dialog-overlay" id="settingsDialog">
        <div class="dialog-content settings-dialog">
            <button class="dialog-close-btn" id="closeSettingsBtn" title="关闭">
                <i class="fas fa-times"></i>
            </button>
            <div class="dialog-header">
                <h3><i class="fas fa-cog" style="margin-right: 10px;"></i>设置</h3>
            </div>
            
            <!-- 设置布局 -->
            <div class="settings-layout" id="settingsLayout">
                <!-- 左侧导航 -->
                <div class="settings-nav" id="settingsNav">
                    <div class="settings-nav-item active" data-tab="editor">
                        <i class="fas fa-edit nav-icon"></i> 编辑设置
                    </div>
                    <div class="settings-nav-item" data-tab="input">
                        <i class="fas fa-keyboard nav-icon"></i> 输入设置
                    </div>
                    <div class="settings-nav-item" data-tab="security">
                        <i class="fas fa-shield-alt nav-icon"></i> 安全设置
                    </div>
                    <div class="settings-nav-item" data-tab="search">
                        <i class="fas fa-search nav-icon"></i> 搜索设置
                    </div>
                    <div class="settings-nav-item" data-tab="account">
                        <i class="fas fa-user nav-icon"></i> 账户设置
                    </div>
                    <div class="settings-nav-item" data-tab="export">
                        <i class="fas fa-download nav-icon"></i> 导出设置
                    </div>
                </div>
                
                <!-- 右侧内容 -->
                <div class="settings-content" id="settingsContent">
                    <!-- 编辑设置部分 -->
                    <div class="settings-section active" id="editor-section">
                        <h4>编辑设置</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">智能输入</div>
                                <div class="setting-description">启用后，在新行输入特定符号会自动补全为完整格式</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="smartInputToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">自动保存</div>
                                <div class="setting-description">编辑内容自动保存，无需手动操作</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="autoSaveToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">Tab键符号选择器</div>
                                <div class="setting-description">启用后，按Tab键可调出符号列表进行选择</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="tabSymbolSelectorToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">独立笔记视图状态</div>
                                <div class="setting-description">每个笔记独立保存编辑/预览模式状态</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="independentViewToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 输入设置部分 -->
                    <div class="settings-section" id="input-section">
                        <h4>智能输入符号</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">标题符号 (#, ##, ###)</div>
                                <div class="setting-description">输入 # 后按空格自动补全为标题</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="headingSymbolsToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">列表符号 (-, *, 1.)</div>
                                <div class="setting-description">输入 - 或 1. 后按空格自动补全为列表</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="listSymbolsToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">任务符号 (- [)</div>
                                <div class="setting-description">输入 - [ 后按空格自动补全为任务项</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="taskSymbolsToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">引用符号 (>)</div>
                                <div class="setting-description">输入 > 后按空格自动补全为引用块</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="quoteSymbolsToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 安全设置部分 -->
                    <div class="settings-section" id="security-section">
                        <h4>安全设置</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">自动登出</div>
                                <div class="setting-description">30分钟无操作后自动登出</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="autoLogoutToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">记住登录信息</div>
                                <div class="setting-description">记住登录账号，下次自动填充</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="rememberLoginToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">自动清除未登录账号</div>
                                <div class="setting-description">30天后自动清除未登录账号数据</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="autoClearUsersToggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 搜索设置部分 -->
                    <div class="settings-section" id="search-section">
                        <h4>搜索设置</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">实时搜索</div>
                                <div class="setting-description">输入时实时显示搜索结果</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="realTimeSearchToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">搜索高亮</div>
                                <div class="setting-description">搜索结果中高亮显示匹配文本</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="searchHighlightToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">搜索历史</div>
                                <div class="setting-description">保存最近搜索的关键词</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="searchHistoryToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- 账户设置部分 -->
                    <div class="settings-section" id="account-section">
                        <h4>账户设置</h4>
                        
                        <!-- 导入导出按钮 -->
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">数据导入导出</div>
                                <div class="setting-description">备份或恢复笔记数据</div>
                            </div>
                            <div class="import-export-buttons">
                                <button class="dialog-btn secondary" id="exportDataBtn" style="margin-right: 8px;">
                                    <i class="fas fa-download" style="margin-right: 5px;"></i>导出
                                </button>
                                <button class="dialog-btn primary" id="importDataBtn">
                                    <i class="fas fa-upload" style="margin-right: 5px;"></i>导入
                                </button>
                            </div>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">自动保存间隔</div>
                                <div class="setting-description">自动保存笔记的时间间隔</div>
                            </div>
                            <select id="saveIntervalSelect" style="padding: 6px 12px; border-radius: var(--radius); border: 1px solid var(--border-color); background: white;">
                                <option value="60000">1分钟</option>
                                <option value="180000" selected>3分钟</option>
                                <option value="300000">5分钟</option>
                                <option value="600000">10分钟</option>
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">主题颜色</div>
                                <div class="setting-description">选择应用的主题颜色</div>
                            </div>
                            <select id="themeColorSelect" style="padding: 6px 12px; border-radius: var(--radius); border: 1px solid var(--border-color); background: white;">
                                <option value="#4f46e5">默认蓝色</option>
                                <option value="#10b981">绿色</option>
                                <option value="#f59e0b">橙色</option>
                                <option value="#ef4444">红色</option>
                                <option value="#8b5cf6">紫色</option>
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">编辑器字体大小</div>
                                <div class="setting-description">调整编辑器文本大小</div>
                            </div>
                            <select id="fontSizeSelect" style="padding: 6px 12px; border-radius: var(--radius); border: 1px solid var(--border-color); background: white;">
                                <option value="14px">小</option>
                                <option value="16px" selected>中</option>
                                <option value="18px">大</option>
                                <option value="20px">特大</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 导出设置部分 -->
                    <div class="settings-section" id="export-section">
                        <h4>导出设置</h4>
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">默认导出格式</div>
                                <div class="setting-description">选择点击导出按钮时的默认格式</div>
                            </div>
                            <select id="defaultExportFormatSelect" style="padding: 6px 12px; border-radius: var(--radius); border: 1px solid var(--border-color); background: white;">
                                <option value="json">JSON (完整备份)</option>
                                <option value="txt">TXT (纯文本)</option>
                            </select>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">TXT导出包含元数据</div>
                                <div class="setting-description">TXT格式导出时包含创建时间和标题</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" class="toggle-checkbox" id="txtIncludeMetadataToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-title">导出文件名前缀</div>
                                <div class="setting-description">导出文件的自定义前缀</div>
                            </div>
                            <input type="text" id="exportFilenamePrefix" class="form-input" value="精简笔记" placeholder="文件名前缀" style="width: 200px; padding: 6px 12px;">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 导入对话框 - 简化版 -->
    <div class="dialog-overlay" id="importDialog">
        <div class="dialog-content">
            <button class="dialog-close-btn" id="closeImportBtn" title="关闭">
                <i class="fas fa-times"></i>
            </button>
            <div class="dialog-header">
                <h3><i class="fas fa-file-import" style="margin-right: 10px;"></i>导入数据</h3>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>注意事项
                </label>
                <div style="background-color: var(--secondary-color); padding: 12px; border-radius: var(--radius); margin-bottom: 15px; font-size: 0.9rem;">
                    <p style="margin-bottom: 8px;">1. 请确保导入的文件是之前从此应用导出的备份文件</p>
                    <p style="margin-bottom: 8px;">2. <strong>仅支持增量导入</strong>，不会覆盖现有笔记</p>
                    <p>3. 导入过程会显示详细结果</p>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="importFile">
                    <i class="fas fa-file" style="margin-right: 8px;"></i>选择备份文件
                </label>
                <div class="file-upload-container">
                    <input type="file" class="file-upload-input" id="importFile" accept=".json">
                    <label class="file-upload-label" for="importFile" id="fileUploadLabel">
                        <span class="file-upload-text" id="fileUploadText">选择文件...</span>
                        <span class="file-upload-button">浏览</span>
                    </label>
                    <div class="file-name" id="fileName" style="display: none;">
                        <i class="fas fa-file-alt" style="color: var(--primary-color);"></i>
                        <span id="selectedFileName"></span>
                    </div>
                </div>
            </div>
            
            <!-- 文件预览 -->
            <div class="file-preview" id="filePreview">
                <h5>文件预览</h5>
                <div class="file-preview-content" id="filePreviewContent"></div>
            </div>
            
            <!-- 导入进度 -->
            <div class="import-progress" id="importProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">正在导入...</div>
            </div>
            
            <!-- 导入结果 -->
            <div class="import-results" id="importResults"></div>
            
            <div class="error-message" id="importError"></div>
            
            <!-- 导入加载指示器 -->
            <div class="import-loading" id="importLoading">
                <i class="fas fa-spinner"></i>
                <p style="margin-top: 10px;">正在处理文件...</p>
            </div>
            
            <div class="dialog-actions">
                <button type="button" class="dialog-btn secondary" id="cancelImportBtn">
                    <i class="fas fa-times" style="margin-right: 5px;"></i>取消
                </button>
                <button type="button" class="dialog-btn primary" id="confirmImportBtn" disabled>
                    <i class="fas fa-upload" style="margin-right: 5px;"></i>导入数据
                </button>
            </div>
        </div>
    </div>
    
    <!-- 使用说明对话框 -->
    <div class="dialog-overlay" id="helpDialog">
        <div class="dialog-content help-dialog">
            <button class="dialog-close-btn" id="closeHelpBtn" title="关闭">
                <i class="fas fa-times"></i>
            </button>
            <div class="dialog-header">
                <h3><i class="fas fa-question-circle" style="margin-right: 10px;"></i>使用说明</h3>
            </div>
            
            <!-- 帮助布局 -->
            <div class="help-layout" id="helpLayout">
                <!-- 左侧导航 -->
                <div class="help-nav" id="helpNav">
                    <div class="help-nav-item active" data-tab="shortcuts">
                        <i class="fas fa-keyboard nav-icon"></i> 快捷键
                    </div>
                    <div class="help-nav-item" data-tab="search">
                        <i class="fas fa-search nav-icon"></i> 搜索功能
                    </div>
                    <div class="help-nav-item" data-tab="wordcount">
                        <i class="fas fa-chart-bar nav-icon"></i> 字数统计
                    </div>
                    <div class="help-nav-item" data-tab="smart-input">
                        <i class="fas fa-magic nav-icon"></i> 智能输入
                    </div>
                    <div class="help-nav-item" data-tab="symbol-selector">
                        <i class="fas fa-list nav-icon"></i> 符号选择器
                    </div>
                    <div class="help-nav-item" data-tab="markdown">
                        <i class="fas fa-code nav-icon"></i> Markdown语法
                    </div>
                    <div class="help-nav-item" data-tab="import-export">
                        <i class="fas fa-exchange-alt nav-icon"></i> 导入导出
                    </div>
                    <div class="help-nav-item" data-tab="user-management">
                        <i class="fas fa-users nav-icon"></i> 用户管理
                    </div>
                    <div class="help-nav-item" data-tab="sidebar-control">
                        <i class="fas fa-columns nav-icon"></i> 侧边栏控制
                    </div>
                    <div class="help-nav-item" data-tab="export-formats">
                        <i class="fas fa-file-export nav-icon"></i> 导出格式
                    </div>
                </div>
                
                <!-- 右侧内容 -->
                <div class="help-content" id="helpContent">
                    <!-- 快捷键部分 -->
                    <div class="help-section active" id="shortcuts-section">
                        <h4>快捷键</h4>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">F</span> - 快速聚焦到搜索框</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">E</span> - 切换编辑/预览模式</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">S</span> - 保存当前笔记</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">H</span> - 打开使用说明</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">Shift</span> + <span class="shortcut-key">N</span> - 新建笔记</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">D</span> - 删除当前笔记</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">,</span> - 打开设置</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">I</span> - 打开关于信息</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><span class="shortcut-key">Tab</span> - 打开符号选择器</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><span class="shortcut-key">Esc</span> - 关闭当前对话框或符号选择器</div>
                        </div>
                    </div>
                    
                    <!-- 搜索功能部分 -->
                    <div class="help-section" id="search-section">
                        <h4>搜索功能</h4>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-search"></i></div>
                            <div><strong>快速搜索</strong> - 在侧边栏底部的搜索框中输入关键词，实时搜索所有笔记</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-keyboard"></i></div>
                            <div><strong>快捷键</strong> - 按 <span class="shortcut-key">Ctrl</span> + <span class="shortcut-key">F</span> 快速聚焦到搜索框</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-bolt"></i></div>
                            <div><strong>实时搜索</strong> - 输入时实时显示搜索结果，无需按回车</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-highlighter"></i></div>
                            <div><strong>高亮显示</strong> - 搜索结果中高亮显示匹配的文本</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-filter"></i></div>
                            <div><strong>搜索范围</strong> - 同时搜索笔记标题和内容</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-chart-bar"></i></div>
                            <div><strong>统计信息</strong> - 显示搜索到的笔记数量和匹配结果</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-times"></i></div>
                            <div><strong>清除搜索</strong> - 点击搜索框右侧的X按钮清除搜索关键词</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-cog"></i></div>
                            <div><strong>设置选项</strong> - 在设置中可以启用/禁用实时搜索和高亮功能</div>
                        </div>
                    </div>
                    
                    <!-- 字数统计部分 -->
                    <div class="help-section" id="wordcount-section">
                        <h4>字数统计功能</h4>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-chart-bar"></i></div>
                            <div><strong>全局统计</strong> - 在侧边栏底部显示笔记总数和总字数</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-file-alt"></i></div>
                            <div><strong>单篇统计</strong> - 在笔记列表中显示每个笔记的单独字数</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-sync"></i></div>
                            <div><strong>实时更新</strong> - 编辑笔记时字数统计实时更新</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-calculator"></i></div>
                            <div><strong>计算规则</strong> - 字数统计包括汉字、字母、数字和标点符号</div>
                        </div>
                    </div>
                    
                    <!-- 智能输入部分 -->
                    <div class="help-section" id="smart-input-section">
                        <h4>智能输入功能</h4>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-magic"></i></div>
                            <div>启用智能输入后，在新行开头输入特定字符会自动补全为完整符号</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-cog"></i></div>
                            <div>在设置中可自定义启用/禁用特定符号的智能输入</div>
                        </div>
                        
                        <div class="symbol-examples">
                            <div class="symbol-example">
                                <code>1.</code>
                                <div class="description">输入"1."然后按空格 → 自动开始有序列表</div>
                            </div>
                            <div class="symbol-example">
                                <code>-</code>
                                <div class="description">输入"-"然后按空格 → 自动开始无序列表</div>
                            </div>
                            <div class="symbol-example">
                                <code>*</code>
                                <div class="description">输入"*"然后按空格 → 自动开始无序列表</div>
                            </div>
                            <div class="symbol-example">
                                <code>- [</code>
                                <div class="description">输入"- ["然后按空格 → 自动补全为任务项</div>
                            </div>
                            <div class="symbol-example">
                                <code>></code>
                                <div class="description">输入">"然后按空格 → 自动开始引用块</div>
                            </div>
                            <div class="symbol-example">
                                <code>#</code>
                                <div class="description">输入"#"然后按空格 → 自动开始一级标题</div>
                            </div>
                            <div class="symbol-example">
                                <code>##</code>
                                <div class="description">输入"##"然后按空格 → 自动开始二级标题</div>
                            </div>
                            <div class="symbol-example">
                                <code>###</code>
                                <div class="description">输入"###"然后按空格 → 自动开始三级标题</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 符号选择器部分 -->
                    <div class="help-section" id="symbol-selector-section">
                        <h4>符号选择器功能</h4>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-list"></i></div>
                            <div><strong>打开选择器：</strong>在编辑器中按<span class="shortcut-key">Tab</span>键打开符号选择器</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-arrow-up"></i></div>
                            <div><strong>导航选择：</strong>使用<span class="shortcut-key">Tab</span>键在符号列表中向下切换选择</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-arrow-down"></i></div>
                            <div><strong>反向导航：</strong>使用<span class="shortcut-key">Shift</span> + <span class="shortcut-key">Tab</span>在符号列表中向上切换选择</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-space-shuttle"></i></div>
                            <div><strong>插入符号：</strong>按<span class="shortcut-key">空格</span>键插入当前选中的符号</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-times"></i></div>
                            <div><strong>关闭选择器：</strong>按<span class="shortcut-key">Esc</span>键或点击编辑器其他位置关闭选择器</div>
                        </div>
                        
                        <div class="symbol-examples">
                            <div class="symbol-example">
                                <code># 一级标题</code>
                                <div class="description">Markdown一级标题</div>
                            </div>
                            <div class="symbol-example">
                                <code>- 无序列表</code>
                                <div class="description">无序列表项</div>
                            </div>
                            <div class="symbol-example">
                                <code>1. 有序列表</code>
                                <div class="description">有序列表项（数字自动递增）</div>
                            </div>
                            <div class="symbol-example">
                                <code>- [ ] 任务</code>
                                <div class="description">未完成任务项</div>
                            </div>
                            <div class="symbol-example">
                                <code>> 引用</code>
                                <div class="description">引用块内容</div>
                            </div>
                            <div class="symbol-example">
                                <code>**粗体**</code>
                                <div class="description">粗体文本标记</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Markdown基础部分 -->
                    <div class="help-section" id="markdown-section">
                        <h4>Markdown基础语法</h4>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-heading"></i></div>
                            <div>标题: <code># 一级标题</code>, <code>## 二级标题</code>, <code>### 三级标题</code></div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-list"></i></div>
                            <div>列表: <code>- 无序列表</code>, <code>1. 有序列表</code></div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-tasks"></i></div>
                            <div>任务: <code>- [ ] 未完成</code>, <code>- [x] 已完成</code></div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-bold"></i></div>
                            <div>粗体: <code>**粗体文字**</code></div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-italic"></i></div>
                            <div>斜体: <code>*斜体文字*</code></div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-quote-right"></i></div>
                            <div>引用: <code>> 引用文字</code></div>
                        </div>
                    </div>
                    
                    <!-- 导入导出部分 -->
                    <div class="help-section" id="import-export-section">
                        <h4>数据导入导出功能</h4>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-download"></i></div>
                            <div><strong>导出数据</strong> - 将当前账号的所有笔记导出为多种格式文件</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-upload"></i></div>
                            <div><strong>导入数据</strong> - 从备份文件恢复笔记数据，仅支持增量导入</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-cog"></i></div>
                            <div><strong>导入模式</strong> - 仅支持增量导入模式，不会覆盖现有笔记</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-search"></i></div>
                            <div><strong>文件预览</strong> - 导入前可预览备份文件内容</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-sync-alt"></i></div>
                            <div><strong>数据迁移</strong> - 可用于在不同设备间迁移笔记数据</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-shield-alt"></i></div>
                            <div><strong>数据安全</strong> - 导出文件仅包含笔记内容，不包含密码等敏感信息</div>
                        </div>
                    </div>
                    
                    <!-- 用户管理部分 -->
                    <div class="help-section" id="user-management-section">
                        <h4>用户管理功能</h4>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-user-plus"></i></div>
                            <div><strong>注册账号</strong> - 支持多用户创建，每个用户数据独立存储</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-lock"></i></div>
                            <div><strong>记住我</strong> - 登录时勾选"记住我"，下次自动填充账号</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-trash-alt"></i></div>
                            <div><strong>注销账号</strong> - 支持安全注销当前账号，保护数据隐私</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-users-slash"></i></div>
                            <div><strong>清除已登出账号</strong> - 可以查看和清除已登出账号的数据</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-key"></i></div>
                            <div><strong>重置密码</strong> - 忘记密码时可以重置账号密码</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-file-export"></i></div>
                            <div><strong>数据备份</strong> - 使用导入导出功能定期备份重要笔记</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-exclamation-triangle"></i></div>
                            <div><strong>数据安全</strong> - 所有用户数据存储在浏览器本地，完全保护隐私</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-shield-alt"></i></div>
                            <div><strong>安全保护</strong> - 自动登出功能保护账号安全</div>
                        </div>
                    </div>
                    
                    <!-- 侧边栏控制部分 -->
                    <div class="help-section" id="sidebar-control-section">
                        <h4>侧边栏控制功能</h4>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-columns"></i></div>
                            <div><strong>隐藏/显示侧边栏</strong> - 点击侧边栏右上角的按钮隐藏或显示侧边栏</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-expand"></i></div>
                            <div><strong>最大化编辑区域</strong> - 隐藏侧边栏可获得更大的编辑空间</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-mobile-alt"></i></div>
                            <div><strong>移动端适配</strong> - 在移动设备上自动优化侧边栏显示</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-bars"></i></div>
                            <div><strong>移动端菜单</strong> - 在移动设备上点击菜单按钮打开侧边栏</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-arrows-alt-h"></i></div>
                            <div><strong>状态记忆</strong> - 侧边栏显示状态会记住，下次打开保持相同状态</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-compress-alt"></i></div>
                            <div><strong>显示侧边栏按钮</strong> - 侧边栏隐藏时，标题区最左侧会显示按钮用于重新显示侧边栏</div>
                        </div>
                    </div>
                    
                    <!-- 导出格式部分 -->
                    <div class="help-section" id="export-formats-section">
                        <h4>多格式导出功能</h4>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-code"></i></div>
                            <div><strong>JSON格式</strong> - 完整备份格式，包含所有笔记数据和元信息，可用于数据恢复</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-file-alt"></i></div>
                            <div><strong>TXT格式</strong> - 纯文本格式，适合阅读和分享，可包含元数据信息</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-cog"></i></div>
                            <div><strong>导出设置</strong> - 可在设置中配置默认导出格式和导出选项</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-history"></i></div>
                            <div><strong>批量导出</strong> - 一次导出所有笔记，按选择格式生成文件</div>
                        </div>
                        <div class="help-item">
                            <div class="help-icon"><i class="fas fa-filter"></i></div>
                            <div><strong>选择性导出</strong> - 当前仅支持全量导出，未来版本将支持按标签筛选导出</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 应用状态
        const state = {
            notes: [],
            activeNoteId: null,
            isPreviewMode: false,
            sidebarVisible: window.innerWidth > 768,
            sidebarHidden: false,
            version: '2.0',
            currentUser: null,
            settings: {
                smartInputEnabled: true,
                autoSaveEnabled: true,
                tabSymbolSelector: true,
                headingSymbols: true,
                listSymbols: true,
                taskSymbols: true,
                quoteSymbols: true,
                realTimeSearch: true,
                searchHighlight: true,
                independentView: true,
                autoLogout: true,
                rememberLogin: true,
                autoClearUsers: false,
                searchHistory: true,
                autoSaveInterval: 180000,
                themeColor: '#4f46e5',
                fontSize: '16px',
                // 更新导出设置
                defaultExportFormat: 'json',
                txtIncludeMetadata: true,
                exportFilenamePrefix: '精简笔记'
            },
            searchQuery: '',
            searchResults: [],
            // 符号选择器状态
            symbolSelector: {
                visible: false,
                selectedIndex: 0,
                symbols: [
                    { symbol: '# ', description: '一级标题', icon: 'fas fa-heading' },
                    { symbol: '## ', description: '二级标题', icon: 'fas fa-heading' },
                    { symbol: '### ', description: '三级标题', icon: 'fas fa-heading' },
                    { symbol: '- ', description: '无序列表', icon: 'fas fa-list' },
                    { symbol: '* ', description: '无序列表(星号)', icon: 'fas fa-list' },
                    { symbol: '1. ', description: '有序列表(自动递增)', icon: 'fas fa-list-ol' },
                    { symbol: '- [ ] ', description: '未完成任务', icon: 'fas fa-square' },
                    { symbol: '- [x] ', description: '已完成任务', icon: 'fas fa-check-square' },
                    { symbol: '> ', description: '引用块', icon: 'fas fa-quote-right' },
                    { symbol: '**', description: '粗体文本', icon: 'fas fa-bold' },
                    { symbol: '*', description: '斜体文本', icon: 'fas fa-italic' },
                    { symbol: '---', description: '水平分割线', icon: 'fas fa-minus' }
                ]
            },
            // 用户数据
            users: {},
            // 自动登出计时器
            autoLogoutTimer: null,
            // 记住的登录信息
            rememberedUser: null,
            // 导入相关状态
            importData: null
        };
        
        // 符号映射表（用于智能输入）
        const symbolMap = {
            '1.': { text: '1. ', enabled: () => state.settings.listSymbols },
            '-': { text: '- ', enabled: () => state.settings.listSymbols },
            '*': { text: '* ', enabled: () => state.settings.listSymbols },
            '- [': { text: '- [ ] ', enabled: () => state.settings.taskSymbols },
            '>': { text: '> ', enabled: () => state.settings.quoteSymbols },
            '#': { text: '# ', enabled: () => state.settings.headingSymbols },
            '##': { text: '## ', enabled: () => state.settings.headingSymbols },
            '###': { text: '### ', enabled: () => state.settings.headingSymbols },
            '####': { text: '#### ', enabled: () => state.settings.headingSymbols },
            '#####': { text: '##### ', enabled: () => state.settings.headingSymbols },
            '######': { text: '###### ', enabled: () => state.settings.headingSymbols }
        };
        
        // DOM 元素
        const elements = {
            // 登录页面元素
            loginContainer: document.getElementById('loginContainer'),
            appContainer: document.getElementById('appContainer'),
            loginForm: document.getElementById('loginForm'),
            username: document.getElementById('username'),
            password: document.getElementById('password'),
            rememberMe: document.getElementById('rememberMe'),
            loginBtn: document.getElementById('loginBtn'),
            loginError: document.getElementById('loginError'),
            loginSuccess: document.getElementById('loginSuccess'),
            registerLink: document.getElementById('registerLink'),
            forgotPasswordLink: document.getElementById('forgotPasswordLink'),
            deleteAccountLink: document.getElementById('deleteAccountLink'),
            clearUsersLink: document.getElementById('clearUsersLink'),
            
            // 导出对话框元素 - 提高z-index确保不被遮挡
            exportDialog: document.getElementById('exportDialog'),
            closeExportBtn: document.getElementById('closeExportBtn'),
            formatJson: document.getElementById('format-json'),
            formatTxt: document.getElementById('format-txt'),
            cancelExportBtn: document.getElementById('cancelExportBtn'),
            confirmExportBtn: document.getElementById('confirmExportBtn'),
            
            // 注册对话框元素
            registerDialog: document.getElementById('registerDialog'),
            closeRegisterBtn: document.getElementById('closeRegisterBtn'),
            registerForm: document.getElementById('registerForm'),
            registerUsername: document.getElementById('registerUsername'),
            registerPassword: document.getElementById('registerPassword'),
            registerConfirmPassword: document.getElementById('registerConfirmPassword'),
            cancelRegisterBtn: document.getElementById('cancelRegisterBtn'),
            confirmRegisterBtn: document.getElementById('confirmRegisterBtn'),
            
            // 忘记密码对话框元素
            forgotPasswordDialog: document.getElementById('forgotPasswordDialog'),
            closeForgotPasswordBtn: document.getElementById('closeForgotPasswordBtn'),
            forgotPasswordForm: document.getElementById('forgotPasswordForm'),
            forgotUsername: document.getElementById('forgotUsername'),
            newPassword: document.getElementById('newPassword'),
            confirmNewPassword: document.getElementById('confirmNewPassword'),
            forgotPasswordError: document.getElementById('forgotPasswordError'),
            cancelForgotPasswordBtn: document.getElementById('cancelForgotPasswordBtn'),
            confirmForgotPasswordBtn: document.getElementById('confirmForgotPasswordBtn'),
            
            // 注销账号对话框元素
            deleteAccountDialog: document.getElementById('deleteAccountDialog'),
            closeDeleteAccountBtn: document.getElementById('closeDeleteAccountBtn'),
            deleteAccountForm: document.getElementById('deleteAccountForm'),
            deleteAccountName: document.getElementById('deleteAccountName'),
            deleteAccountPassword: document.getElementById('deleteAccountPassword'),
            deleteAccountError: document.getElementById('deleteAccountError'),
            cancelDeleteAccountBtn: document.getElementById('cancelDeleteAccountBtn'),
            confirmDeleteAccountBtn: document.getElementById('confirmDeleteAccountBtn'),
            
            // 清除已登出账号对话框元素
            clearUsersDialog: document.getElementById('clearUsersDialog'),
            closeClearUsersBtn: document.getElementById('closeClearUsersBtn'),
            usersList: document.getElementById('usersList'),
            cancelClearUsersBtn: document.getElementById('cancelClearUsersBtn'),
            confirmClearAllBtn: document.getElementById('confirmClearAllBtn'),
            
            // 主应用元素
            sidebar: document.getElementById('sidebar'),
            mobileMenuBtn: document.getElementById('mobileMenuBtn'),
            newNoteBtn: document.getElementById('newNoteBtn'),
            notesList: document.getElementById('notesList'),
            noteTitleInput: document.getElementById('noteTitleInput'),
            noteEditor: document.getElementById('noteEditor'),
            viewToggleBtn: document.getElementById('viewToggleBtn'),
            deleteNoteBtn: document.getElementById('deleteNoteBtn'),
            saveNoteBtn: document.getElementById('saveNoteBtn'),
            editorContainer: document.getElementById('editorContainer'),
            previewContainer: document.getElementById('previewContainer'),
            emptyState: document.getElementById('emptyState'),
            statusMessage: document.getElementById('statusMessage'),
            deleteConfirm: document.getElementById('deleteConfirm'),
            cancelDeleteBtn: document.getElementById('cancelDeleteBtn'),
            confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
            aboutBtn: document.getElementById('aboutBtn'),
            aboutDialog: document.getElementById('aboutDialog'),
            closeAboutBtn: document.getElementById('closeAboutBtn'),
            settingsBtn: document.getElementById('settingsBtn'),
            settingsDialog: document.getElementById('settingsDialog'),
            closeSettingsBtn: document.getElementById('closeSettingsBtn'),
            helpBtn: document.getElementById('helpBtn'),
            helpDialog: document.getElementById('helpDialog'),
            closeHelpBtn: document.getElementById('closeHelpBtn'),
            toolbar: document.getElementById('toolbar'),
            // 搜索相关元素
            searchInput: document.getElementById('searchInput'),
            clearSearchBtn: document.getElementById('clearSearchBtn'),
            searchStats: document.getElementById('searchStats'),
            // 字数统计元素
            wordCount: document.getElementById('wordCount'),
            totalNotes: document.getElementById('totalNotes'),
            totalWords: document.getElementById('totalWords'),
            // 用户相关元素
            userAvatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            logoutBtn: document.getElementById('logoutBtn'),
            // 设置导航和内容
            settingsNav: document.getElementById('settingsNav'),
            settingsContent: document.getElementById('settingsContent'),
            // 帮助导航和内容
            helpNav: document.getElementById('helpNav'),
            helpContent: document.getElementById('helpContent'),
            // 设置选项
            smartInputToggle: document.getElementById('smartInputToggle'),
            autoSaveToggle: document.getElementById('autoSaveToggle'),
            tabSymbolSelectorToggle: document.getElementById('tabSymbolSelectorToggle'),
            headingSymbolsToggle: document.getElementById('headingSymbolsToggle'),
            listSymbolsToggle: document.getElementById('listSymbolsToggle'),
            taskSymbolsToggle: document.getElementById('taskSymbolsToggle'),
            quoteSymbolsToggle: document.getElementById('quoteSymbolsToggle'),
            realTimeSearchToggle: document.getElementById('realTimeSearchToggle'),
            searchHighlightToggle: document.getElementById('searchHighlightToggle'),
            independentViewToggle: document.getElementById('independentViewToggle'),
            autoLogoutToggle: document.getElementById('autoLogoutToggle'),
            rememberLoginToggle: document.getElementById('rememberLoginToggle'),
            autoClearUsersToggle: document.getElementById('autoClearUsersToggle'),
            searchHistoryToggle: document.getElementById('searchHistoryToggle'),
            // 导出设置选项
            defaultExportFormatSelect: document.getElementById('defaultExportFormatSelect'),
            txtIncludeMetadataToggle: document.getElementById('txtIncludeMetadataToggle'),
            exportFilenamePrefix: document.getElementById('exportFilenamePrefix'),
            // 设置选项
            saveIntervalSelect: document.getElementById('saveIntervalSelect'),
            themeColorSelect: document.getElementById('themeColorSelect'),
            fontSizeSelect: document.getElementById('fontSizeSelect'),
            // 导入导出按钮
            exportDataBtn: document.getElementById('exportDataBtn'),
            importDataBtn: document.getElementById('importDataBtn'),
            // 导入对话框元素
            importDialog: document.getElementById('importDialog'),
            closeImportBtn: document.getElementById('closeImportBtn'),
            importFile: document.getElementById('importFile'),
            fileUploadLabel: document.getElementById('fileUploadLabel'),
            fileUploadText: document.getElementById('fileUploadText'),
            fileName: document.getElementById('fileName'),
            selectedFileName: document.getElementById('selectedFileName'),
            importError: document.getElementById('importError'),
            cancelImportBtn: document.getElementById('cancelImportBtn'),
            confirmImportBtn: document.getElementById('confirmImportBtn'),
            // 导入相关元素
            filePreview: document.getElementById('filePreview'),
            filePreviewContent: document.getElementById('filePreviewContent'),
            importProgress: document.getElementById('importProgress'),
            progressFill: document.getElementById('progressFill'),
            progressText: document.getElementById('progressText'),
            importResults: document.getElementById('importResults'),
            importLoading: document.getElementById('importLoading'),
            // 符号选择器元素
            symbolSelector: document.getElementById('symbolSelector'),
            // 侧边栏控制按钮
            sidebarToggleBtn: document.getElementById('sidebarToggleBtn'),
            showSidebarBtn: document.getElementById('showSidebarBtn')
        };
        
        // ==================== 用户管理函数 ====================
        
        // 加载用户数据
        function loadUsers() {
            try {
                const usersData = localStorage.getItem('noteUsers');
                if (usersData) {
                    state.users = JSON.parse(usersData);
                }
            } catch (error) {
                console.error('加载用户数据失败:', error);
                state.users = {};
            }
        }
        
        // 保存用户数据
        function saveUsers() {
            localStorage.setItem('noteUsers', JSON.stringify(state.users));
        }
        
        // 加载记住的登录信息
        function loadRememberedUser() {
            try {
                const remembered = localStorage.getItem('rememberedUser');
                if (remembered) {
                    state.rememberedUser = JSON.parse(remembered);
                    if (state.rememberedUser && state.rememberedUser.username) {
                        elements.username.value = state.rememberedUser.username;
                        elements.rememberMe.checked = true;
                        elements.password.focus();
                    }
                }
            } catch (error) {
                console.error('加载记住的用户失败:', error);
                state.rememberedUser = null;
            }
        }
        
        // 保存记住的登录信息
        function saveRememberedUser() {
            if (elements.rememberMe.checked && elements.username.value.trim()) {
                state.rememberedUser = {
                    username: elements.username.value.trim(),
                    rememberDate: new Date().toISOString()
                };
                localStorage.setItem('rememberedUser', JSON.stringify(state.rememberedUser));
            } else {
                state.rememberedUser = null;
                localStorage.removeItem('rememberedUser');
            }
        }
        
        // 清除记住的登录信息
        function clearRememberedUser() {
            state.rememberedUser = null;
            localStorage.removeItem('rememberedUser');
            elements.rememberMe.checked = false;
        }
        
        // 注册新用户
        function registerUser(username, password) {
            if (username.length < 4 || username.length > 20) {
                return { success: false, message: '账号长度需在4-20位之间' };
            }
            
            if (state.users[username]) {
                return { success: false, message: '账号已存在' };
            }
            
            if (password.length < 6) {
                return { success: false, message: '密码长度不能少于6位' };
            }
            
            // 创建用户数据
            state.users[username] = {
                password: hashPassword(password),
                createdAt: new Date().toISOString(),
                lastLogin: null,
                notes: [],
                settings: {
                    smartInputEnabled: true,
                    autoSaveEnabled: true,
                    tabSymbolSelector: true,
                    headingSymbols: true,
                    listSymbols: true,
                    taskSymbols: true,
                    quoteSymbols: true,
                    realTimeSearch: true,
                    searchHighlight: true,
                    independentView: true,
                    autoLogout: true,
                    rememberLogin: true,
                    autoClearUsers: false,
                    searchHistory: true,
                    autoSaveInterval: 180000,
                    themeColor: '#4f46e5',
                    fontSize: '16px',
                    defaultExportFormat: 'json',
                    txtIncludeMetadata: true,
                    exportFilenamePrefix: '精简笔记'
                },
                sidebarHidden: false
            };
            
            saveUsers();
            return { success: true, message: '注册成功' };
        }
        
        // 登录用户
        function loginUser(username, password) {
            const user = state.users[username];
            
            if (!user) {
                return { success: false, message: '账号不存在' };
            }
            
            if (user.password !== hashPassword(password)) {
                return { success: false, message: '密码错误' };
            }
            
            // 更新最后登录时间
            user.lastLogin = new Date().toISOString();
            saveUsers();
            
            state.currentUser = username;
            
            // 加载用户的侧边栏隐藏状态
            if (user.sidebarHidden !== undefined) {
                state.sidebarHidden = user.sidebarHidden;
            }
            
            return { success: true, message: '登录成功' };
        }
        
        // 重置密码
        function resetPassword(username, newPassword) {
            const user = state.users[username];
            
            if (!user) {
                return { success: false, message: '账号不存在' };
            }
            
            if (newPassword.length < 6) {
                return { success: false, message: '密码长度不能少于6位' };
            }
            
            user.password = hashPassword(newPassword);
            saveUsers();
            return { success: true, message: '密码重置成功' };
        }
        
        // 注销账号（删除账号）
        function deleteAccount(username, password) {
            const user = state.users[username];
            
            if (!user) {
                return { success: false, message: '账号不存在' };
            }
            
            if (user.password !== hashPassword(password)) {
                return { success: false, message: '密码错误' };
            }
            
            // 删除用户数据
            delete state.users[username];
            saveUsers();
            
            // 如果当前用户是该账号，登出
            if (state.currentUser === username) {
                logoutUser();
            }
            
            return { success: true, message: '账号已成功注销' };
        }
        
        // 清除未登录的账号
        function clearLoggedOutUsers() {
            const loggedOutUsers = [];
            
            for (const username in state.users) {
                if (username !== state.currentUser) {
                    loggedOutUsers.push(username);
                }
            }
            
            // 删除未登录账号
            loggedOutUsers.forEach(username => {
                delete state.users[username];
            });
            
            saveUsers();
            return loggedOutUsers.length;
        }
        
        // 获取未登录账号列表
        function getLoggedOutUsers() {
            const loggedOutUsers = [];
            
            for (const username in state.users) {
                if (username !== state.currentUser) {
                    const user = state.users[username];
                    loggedOutUsers.push({
                        username: username,
                        createdAt: user.createdAt,
                        lastLogin: user.lastLogin,
                        noteCount: user.notes ? user.notes.length : 0
                    });
                }
            }
            
            return loggedOutUsers;
        }
        
        // 简单密码哈希函数
        function hashPassword(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString(36);
        }
        
        // 更新用户头像
        function updateUserAvatar() {
            if (!state.currentUser) return;
            
            const firstChar = state.currentUser.charAt(0).toUpperCase();
            elements.userAvatar.textContent = firstChar;
        }
        
        // 更新用户信息显示
        function updateUserInfo() {
            if (!state.currentUser) return;
            
            elements.userName.textContent = state.currentUser;
            updateUserAvatar();
        }
        
        // 登出用户
        function logoutUser() {
            // 保存当前用户数据
            saveCurrentUserData();
            
            // 清除记住的登录信息
            clearRememberedUser();
            
            // 清除用户状态
            state.currentUser = null;
            state.notes = [];
            state.activeNoteId = null;
            
            // 停止自动登出计时器
            if (state.autoLogoutTimer) {
                clearTimeout(state.autoLogoutTimer);
                state.autoLogoutTimer = null;
            }
            
            // 切换到登录界面
            elements.appContainer.style.display = 'none';
            elements.loginContainer.style.display = 'flex';
            
            // 清空登录表单
            elements.username.value = '';
            elements.password.value = '';
            elements.rememberMe.checked = false;
            elements.loginError.style.display = 'none';
            elements.loginSuccess.style.display = 'none';
            
            showStatus('已成功登出');
        }
        
        // 重置自动登出计时器
        function resetAutoLogoutTimer() {
            if (!state.settings.autoLogout || !state.currentUser) return;
            
            if (state.autoLogoutTimer) {
                clearTimeout(state.autoLogoutTimer);
            }
            
            // 设置30分钟后自动登出
            state.autoLogoutTimer = setTimeout(() => {
                if (state.currentUser) {
                    logoutUser();
                    showStatus('由于长时间无操作，已自动登出');
                }
            }, 30 * 60 * 1000); // 30分钟
        }
        
        // ==================== 用户数据管理 ====================
        
        // 加载当前用户数据
        function loadCurrentUserData() {
            if (!state.currentUser) return;
            
            const user = state.users[state.currentUser];
            if (!user) return;
            
            // 加载笔记
            state.notes = user.notes || [];
            
            // 加载用户设置
            if (user.settings) {
                state.settings = { ...state.settings, ...user.settings };
            }
            
            // 加载侧边栏状态
            if (user.sidebarHidden !== undefined) {
                state.sidebarHidden = user.sidebarHidden;
                updateSidebarVisibility();
            }
        }
        
        // 保存当前用户数据
        function saveCurrentUserData() {
            if (!state.currentUser) return;
            
            const user = state.users[state.currentUser];
            if (!user) return;
            
            // 保存笔记
            user.notes = state.notes;
            
            // 保存用户设置
            user.settings = state.settings;
            
            // 保存侧边栏状态
            user.sidebarHidden = state.sidebarHidden;
            
            saveUsers();
        }
        
        // ==================== 侧边栏控制函数 ====================
        
        // 切换侧边栏显示/隐藏
        function toggleSidebar() {
            // 移动端使用原来的切换逻辑
            if (window.innerWidth <= 768) {
                state.sidebarVisible = !state.sidebarVisible;
                updateSidebarVisibility();
                return;
            }
            
            // 桌面端：切换隐藏状态
            state.sidebarHidden = !state.sidebarHidden;
            updateSidebarVisibility();
            
            // 更新按钮图标
            const icon = elements.sidebarToggleBtn.querySelector('i');
            if (state.sidebarHidden) {
                icon.className = 'fas fa-chevron-right';
                elements.sidebarToggleBtn.title = '显示侧边栏';
                showStatus('侧边栏已隐藏');
            } else {
                icon.className = 'fas fa-chevron-left';
                elements.sidebarToggleBtn.title = '隐藏侧边栏';
                showStatus('侧边栏已显示');
            }
            
            // 保存状态
            saveCurrentUserData();
        }
        
        // 显示侧边栏
        function showSidebar() {
            if (window.innerWidth <= 768) {
                state.sidebarVisible = true;
            } else {
                state.sidebarHidden = false;
            }
            updateSidebarVisibility();
            
            // 更新按钮图标
            const icon = elements.sidebarToggleBtn.querySelector('i');
            icon.className = 'fas fa-chevron-left';
            elements.sidebarToggleBtn.title = '隐藏侧边栏';
            
            // 保存状态
            saveCurrentUserData();
        }
        
        // 更新侧边栏可见性
        function updateSidebarVisibility() {
            if (window.innerWidth <= 768) {
                // 移动端逻辑
                if (state.sidebarVisible) {
                    elements.sidebar.classList.add('active');
                    elements.appContainer.classList.remove('sidebar-hidden');
                } else {
                    elements.sidebar.classList.remove('active');
                    elements.appContainer.classList.remove('sidebar-hidden');
                }
            } else {
                // 桌面端逻辑
                if (state.sidebarHidden) {
                    elements.appContainer.classList.add('sidebar-hidden');
                } else {
                    elements.appContainer.classList.remove('sidebar-hidden');
                }
                
                // 移动端菜单按钮在桌面端隐藏
                elements.mobileMenuBtn.style.display = 'none';
            }
        }
        
        // ==================== 多格式导出功能 ====================
        
        // 显示导出选项对话框
        function showExportDialog() {
            // 设置默认选中项
            const defaultFormat = state.settings.defaultExportFormat || 'json';
            document.querySelector(`#format-${defaultFormat}`).checked = true;
            
            showDialog(elements.exportDialog);
        }
        
        // 导出数据 - 支持多种格式
        function exportDataWithFormat() {
            if (!state.currentUser) return;
            
            const user = state.users[state.currentUser];
            if (!user) return;
            
            // 获取选中的导出格式
            const exportFormat = document.querySelector('input[name="exportFormat"]:checked').value;
            
            // 准备导出的数据
            const exportData = {
                version: state.version,
                exportDate: new Date().toISOString(),
                username: state.currentUser,
                notes: user.notes || [],
                settings: user.settings || {}
            };
            
            // 根据格式调用不同的导出函数
            switch (exportFormat) {
                case 'json':
                    exportAsJSON(exportData);
                    break;
                case 'txt':
                    exportAsTXT(exportData);
                    break;
            }
            
            // 关闭对话框
            hideDialog(elements.exportDialog);
            showStatus(`${exportFormat.toUpperCase()}格式数据导出成功`);
        }
        
        // 导出为JSON格式
        function exportAsJSON(exportData) {
            // 转换为JSON字符串
            const dataStr = JSON.stringify(exportData, null, 2);
            
            // 使用现代浏览器的File System Access API
            if ('showSaveFilePicker' in window) {
                exportWithFileSystemAPI(dataStr, 'json');
            } else {
                // 回退到传统方法
                exportWithTraditionalMethod(dataStr, 'json');
            }
        }
        
        // 导出为TXT格式
        function exportAsTXT(exportData) {
            let txtContent = '';
            
            // 添加标题和日期
            if (state.settings.txtIncludeMetadata) {
                txtContent += `= 精简笔记导出 =\n`;
                txtContent += `导出时间: ${new Date(exportData.exportDate).toLocaleString()}\n`;
                txtContent += `用户: ${exportData.username}\n`;
                txtContent += `笔记数量: ${exportData.notes.length}\n`;
                txtContent += '='.repeat(40) + '\n\n';
            }
            
            // 添加每个笔记
            exportData.notes.forEach((note, index) => {
                if (state.settings.txtIncludeMetadata) {
                    txtContent += `笔记 ${index + 1}: ${note.title || '无标题'}\n`;
                    txtContent += `创建时间: ${new Date(note.createdAt).toLocaleString()}\n`;
                    txtContent += `最后更新: ${new Date(note.updatedAt).toLocaleString()}\n`;
                    txtContent += '-'.repeat(40) + '\n';
                }
                
                txtContent += note.content + '\n\n';
                txtContent += '='.repeat(40) + '\n\n';
            });
            
            // 使用现代浏览器的File System Access API
            if ('showSaveFilePicker' in window) {
                exportWithFileSystemAPI(txtContent, 'txt');
            } else {
                // 回退到传统方法
                exportWithTraditionalMethod(txtContent, 'txt');
            }
        }
        
        // 使用File System Access API导出（现代浏览器）
        async function exportWithFileSystemAPI(dataStr, format) {
            try {
                const formatInfo = {
                    json: { extension: '.json', mimeType: 'application/json', description: 'JSON文件' },
                    txt: { extension: '.txt', mimeType: 'text/plain', description: '文本文件' }
                };
                
                const info = formatInfo[format];
                const prefix = state.settings.exportFilenamePrefix || '精简笔记';
                const dateStr = new Date().toISOString().split('T')[0];
                
                const options = {
                    suggestedName: `${prefix}_${state.currentUser}_${dateStr}${info.extension}`,
                    types: [{
                        description: info.description,
                        accept: {
                            [info.mimeType]: [info.extension]
                        }
                    }]
                };
                
                const fileHandle = await window.showSaveFilePicker(options);
                const writable = await fileHandle.createWritable();
                await writable.write(dataStr);
                await writable.close();
                
                showStatus(`${format.toUpperCase()}格式数据导出成功`);
            } catch (err) {
                // 用户取消或发生错误，回退到传统方法
                if (err.name !== 'AbortError') {
                    console.error('文件系统API错误:', err);
                    exportWithTraditionalMethod(dataStr, format);
                } else {
                    showStatus('导出已取消');
                }
            }
        }
        
        // 使用传统方法导出（兼容旧浏览器）
        function exportWithTraditionalMethod(dataStr, format) {
            const formatInfo = {
                json: { extension: '.json', mimeType: 'application/json' },
                txt: { extension: '.txt', mimeType: 'text/plain' }
            };
            
            const info = formatInfo[format];
            const prefix = state.settings.exportFilenamePrefix || '精简笔记';
            const dateStr = new Date().toISOString().split('T')[0];
            
            const dataBlob = new Blob([dataStr], { type: info.mimeType });
            
            // 创建下载链接
            const downloadLink = document.createElement('a');
            downloadLink.href = URL.createObjectURL(dataBlob);
            downloadLink.download = `${prefix}_${state.currentUser}_${dateStr}${info.extension}`;
            
            // 触发下载
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
            
            // 清理URL
            setTimeout(() => URL.revokeObjectURL(downloadLink.href), 100);
            
            showStatus(`${format.toUpperCase()}格式数据导出成功`);
        }
        
        // 显示导入对话框
        function showImportDialog() {
            // 清空文件输入
            elements.importFile.value = '';
            elements.importError.style.display = 'none';
            elements.confirmImportBtn.disabled = true;
            elements.fileName.style.display = 'none';
            elements.filePreview.style.display = 'none';
            elements.importProgress.style.display = 'none';
            elements.importResults.style.display = 'none';
            elements.importLoading.style.display = 'none';
            elements.fileUploadText.textContent = '选择文件...';
            
            // 重置导入状态
            state.importData = null;
            
            showDialog(elements.importDialog);
        }
        
        // 处理导入文件选择
        function handleImportFileChange() {
            const file = elements.importFile.files[0];
            if (!file) {
                elements.confirmImportBtn.disabled = true;
                elements.fileName.style.display = 'none';
                elements.filePreview.style.display = 'none';
                elements.fileUploadText.textContent = '选择文件...';
                return;
            }
            
            // 验证文件类型
            if (!file.name.endsWith('.json')) {
                elements.importError.textContent = '请选择JSON格式的文件';
                elements.importError.style.display = 'block';
                elements.confirmImportBtn.disabled = true;
                return;
            }
            
            elements.confirmImportBtn.disabled = false;
            elements.selectedFileName.textContent = file.name;
            elements.fileName.style.display = 'flex';
            elements.fileUploadText.textContent = '已选择文件';
            elements.importError.style.display = 'none';
            
            // 显示加载指示器
            elements.importLoading.style.display = 'block';
            
            // 预览文件内容
            const reader = new FileReader();
            reader.onload = function(e) {
                elements.importLoading.style.display = 'none';
                
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // 验证导入数据格式
                    if (!importData.notes || !Array.isArray(importData.notes)) {
                        throw new Error('无效的备份文件格式');
                    }
                    
                    // 保存导入数据
                    state.importData = importData;
                    
                    // 显示文件预览
                    showFilePreview(importData);
                    
                } catch (error) {
                    console.error('解析文件失败:', error);
                    elements.importError.textContent = `文件格式错误: ${error.message}`;
                    elements.importError.style.display = 'block';
                    elements.confirmImportBtn.disabled = true;
                }
            };
            
            reader.onerror = function() {
                elements.importLoading.style.display = 'none';
                elements.importError.textContent = '读取文件失败';
                elements.importError.style.display = 'block';
                elements.confirmImportBtn.disabled = true;
            };
            
            reader.readAsText(file);
        }
        
        // 显示文件预览
        function showFilePreview(importData) {
            elements.filePreview.style.display = 'block';
            
            const previewContent = `
                <div>版本: ${importData.version || '未知'}</div>
                <div>导出时间: ${new Date(importData.exportDate).toLocaleString()}</div>
                <div>用户名: ${importData.username || '未知'}</div>
                <div>笔记数量: ${importData.notes.length}</div>
            `;
            
            elements.filePreviewContent.innerHTML = previewContent;
        }
        
        // 设置文件拖放功能
        function setupFileDragDrop() {
            const label = elements.fileUploadLabel;
            
            // 防止默认拖放行为
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                label.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // 高亮拖放区域
            ['dragenter', 'dragover'].forEach(eventName => {
                label.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                label.addEventListener(eventName, unhighlight, false);
            });
            
            // 处理文件放置
            label.addEventListener('drop', handleDrop, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight() {
                label.classList.add('drag-over');
            }
            
            function unhighlight() {
                label.classList.remove('drag-over');
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    // 创建一个新的FileList对象（模拟）
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(files[0]);
                    elements.importFile.files = dataTransfer.files;
                    
                    // 触发change事件
                    const event = new Event('change', { bubbles: true });
                    elements.importFile.dispatchEvent(event);
                }
            }
        }
        
        // 导入数据 - 简化版，只支持增量导入
        function importData() {
            if (!state.importData || !state.currentUser) return;
            
            const importNotes = state.importData.notes;
            
            // 禁用导入按钮
            elements.confirmImportBtn.disabled = true;
            elements.cancelImportBtn.disabled = true;
            
            // 显示进度条
            elements.importProgress.style.display = 'block';
            elements.progressText.textContent = '正在导入...';
            
            // 统计信息
            let importedCount = 0;
            let totalCount = importNotes.length;
            
            // 模拟进度更新
            const progressInterval = setInterval(() => {
                if (importedCount >= totalCount) {
                    clearInterval(progressInterval);
                    finishImport(importedCount);
                } else {
                    const progress = (importedCount / totalCount) * 100;
                    elements.progressFill.style.width = progress + '%';
                    elements.progressText.textContent = `正在导入 ${importedCount}/${totalCount}...`;
                }
            }, 100);
            
            // 模拟导入过程
            setTimeout(() => {
                // 增量导入：仅添加新笔记
                importNotes.forEach((note, index) => {
                    // 创建新笔记对象，确保有唯一ID
                    const newNote = { ...note };
                    newNote.id = Date.now().toString() + index + Math.random().toString(36).substr(2, 9);
                    
                    // 添加到笔记列表开头
                    state.notes.unshift(newNote);
                    importedCount++;
                });
                
                // 完成导入
                clearInterval(progressInterval);
                finishImport(importedCount);
                
            }, 1500);
        }
        
        // 完成导入
        function finishImport(importedCount) {
            // 更新进度条
            elements.progressFill.style.width = '100%';
            elements.progressText.textContent = '导入完成';
            
            // 保存数据
            saveCurrentUserData();
            
            // 更新UI
            renderNotesList();
            updateWordCount();
            
            // 如果有笔记，显示第一个
            if (state.notes.length > 0) {
                setActiveNote(state.notes[0].id);
            } else {
                showEmptyState();
            }
            
            // 显示导入结果
            showImportResults(importedCount);
            
            // 3秒后关闭对话框
            setTimeout(() => {
                hideDialog(elements.importDialog);
                showStatus(`成功导入 ${importedCount} 篇笔记`);
            }, 3000);
        }
        
        // 显示导入结果
        function showImportResults(importedCount) {
            const resultsHtml = `
                <div class="results-title">导入结果</div>
                <ul class="results-list">
                    <li>成功导入: ${importedCount} 篇笔记</li>
                    <li>当前总计: ${state.notes.length} 篇笔记</li>
                </ul>
            `;
            
            elements.importResults.innerHTML = resultsHtml;
            elements.importResults.classList.add('success');
            elements.importResults.style.display = 'block';
        }
        
        // ==================== 登录界面函数 ====================
        
        // 显示登录消息
        function showLoginMessage(message, type = 'error') {
            if (type === 'error') {
                elements.loginError.textContent = message;
                elements.loginError.style.display = 'block';
                elements.loginSuccess.style.display = 'none';
            } else {
                elements.loginSuccess.textContent = message;
                elements.loginSuccess.style.display = 'block';
                elements.loginError.style.display = 'none';
            }
            
            // 3秒后自动隐藏消息
            setTimeout(() => {
                elements.loginError.style.display = 'none';
                elements.loginSuccess.style.display = 'none';
            }, 3000);
        }
        
        // 显示加载动画
        function showLoginLoading(show) {
            if (show) {
                elements.loginBtn.disabled = true;
                elements.loginBtn.classList.add('login-btn-loading');
            } else {
                elements.loginBtn.disabled = false;
                elements.loginBtn.classList.remove('login-btn-loading');
            }
        }
        
        // 显示对话框
        function showDialog(dialog) {
            dialog.classList.add('active');
        }
        
        // 隐藏对话框
        function hideDialog(dialog) {
            dialog.classList.remove('active');
        }
        
        // ==================== 核心功能函数 ====================
        
        // 字数统计函数
        function countWords(text) {
            if (!text) return 0;
            return text.replace(/\s+/g, '').length;
        }
        
        function updateWordCount() {
            // 全局统计
            const totalNotes = state.notes.length;
            let totalWords = 0;
            
            state.notes.forEach(note => {
                totalWords += countWords(note.title) + countWords(note.content);
            });
            
            elements.totalNotes.textContent = totalNotes;
            elements.totalWords.textContent = totalWords.toLocaleString();
        }
        
        // 搜索功能函数
        function performSearch(query) {
            state.searchQuery = query.trim();
            
            if (!state.searchQuery) {
                state.searchResults = [];
                elements.clearSearchBtn.classList.remove('visible');
                elements.searchStats.classList.remove('visible');
                renderNotesList();
                return;
            }
            
            const results = [];
            const lowerQuery = state.searchQuery.toLowerCase();
            
            state.notes.forEach((note, index) => {
                const inTitle = note.title && note.title.toLowerCase().includes(lowerQuery);
                const inContent = note.content && note.content.toLowerCase().includes(lowerQuery);
                
                if (inTitle || inContent) {
                    results.push({
                        note,
                        index,
                        inTitle,
                        inContent
                    });
                }
            });
            
            state.searchResults = results;
            elements.clearSearchBtn.classList.add('visible');
            elements.searchStats.classList.add('visible');
            elements.searchStats.textContent = `找到 ${results.length} 个笔记`;
            
            renderNotesList();
        }
        
        function highlightText(text, query) {
            if (!state.settings.searchHighlight || !query || !text) return text;
            
            // 转义特殊字符
            const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedQuery})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }
        
        function clearSearch() {
            state.searchQuery = '';
            elements.searchInput.value = '';
            state.searchResults = [];
            elements.clearSearchBtn.classList.remove('visible');
            elements.searchStats.classList.remove('visible');
            renderNotesList();
            elements.searchInput.focus();
        }
        
        // 初始化应用
        async function initApp() {
            // 加载用户数据
            loadUsers();
            
            // 加载记住的登录信息
            loadRememberedUser();
            
            // 设置登录事件监听器
            setupLoginEventListeners();
            
            // 设置文件拖放功能
            setupFileDragDrop();
            
            // 初始显示登录界面
            elements.loginContainer.style.display = 'flex';
            elements.appContainer.style.display = 'none';
        }
        
        // 初始化主应用
        function initMainApp() {
            // 加载当前用户数据
            loadCurrentUserData();
            
            // 应用设置
            applySettings();
            
            renderNotesList();
            updateWordCount();
            updateUserInfo();
            
            // 更新侧边栏控制按钮图标
            const icon = elements.sidebarToggleBtn.querySelector('i');
            if (state.sidebarHidden) {
                icon.className = 'fas fa-chevron-right';
                elements.sidebarToggleBtn.title = '显示侧边栏';
            } else {
                icon.className = 'fas fa-chevron-left';
                elements.sidebarToggleBtn.title = '隐藏侧边栏';
            }
            
            // 如果存在笔记，显示第一个
            if (state.notes.length > 0) {
                setActiveNote(state.notes[0].id);
            } else {
                showEmptyState();
            }
            
            setupEventListeners();
            setupResponsiveBehavior();
            setupKeyboardShortcuts();
            loadSettings();
            
            // 添加页面卸载时的保存监听
            window.addEventListener('beforeunload', saveAllData);
            window.addEventListener('pagehide', saveAllData);
            
            // 初始显示状态消息
            setTimeout(() => {
                showStatus('应用已加载完成 ✓');
            }, 1000);
            
            // 启动自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 应用设置到UI
        function applySettings() {
            // 应用主题颜色
            document.documentElement.style.setProperty('--primary-color', state.settings.themeColor);
            
            // 应用字体大小
            document.querySelectorAll('.note-editor, .preview-container').forEach(el => {
                el.style.fontSize = state.settings.fontSize;
            });
        }
        
        // 保存所有数据
        function saveAllData() {
            saveCurrentUserData();
        }
        
        // 保存设置
        function saveSettings() {
            // 设置保存在用户数据中，通过saveCurrentUserData保存
        }
        
        // 设置登录事件监听器
        function setupLoginEventListeners() {
            // 登录表单提交
            elements.loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleLogin();
            });
            
            // 注册链接
            elements.registerLink.addEventListener('click', () => {
                showDialog(elements.registerDialog);
                elements.registerUsername.focus();
            });
            
            // 忘记密码链接
            elements.forgotPasswordLink.addEventListener('click', () => {
                showDialog(elements.forgotPasswordDialog);
                elements.forgotUsername.focus();
            });
            
            // 注销账号链接
            elements.deleteAccountLink.addEventListener('click', () => {
                const username = elements.username.value.trim();
                if (!username) {
                    showLoginMessage('请先输入要注销的账号');
                    return;
                }
                
                elements.deleteAccountName.textContent = username;
                showDialog(elements.deleteAccountDialog);
                elements.deleteAccountPassword.focus();
            });
            
            // 清除已登出账号链接
            elements.clearUsersLink.addEventListener('click', () => {
                showClearUsersDialog();
            });
            
            // 导出对话框 - 确保不被遮挡
            elements.closeExportBtn.addEventListener('click', () => hideDialog(elements.exportDialog));
            elements.cancelExportBtn.addEventListener('click', () => hideDialog(elements.exportDialog));
            elements.confirmExportBtn.addEventListener('click', exportDataWithFormat);
            
            // 注册对话框
            elements.closeRegisterBtn.addEventListener('click', () => hideDialog(elements.registerDialog));
            elements.cancelRegisterBtn.addEventListener('click', () => hideDialog(elements.registerDialog));
            elements.registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleRegister();
            });
            
            // 忘记密码对话框
            elements.closeForgotPasswordBtn.addEventListener('click', () => hideDialog(elements.forgotPasswordDialog));
            elements.cancelForgotPasswordBtn.addEventListener('click', () => hideDialog(elements.forgotPasswordDialog));
            elements.forgotPasswordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleForgotPassword();
            });
            
            // 注销账号对话框
            elements.closeDeleteAccountBtn.addEventListener('click', () => hideDialog(elements.deleteAccountDialog));
            elements.cancelDeleteAccountBtn.addEventListener('click', () => hideDialog(elements.deleteAccountDialog));
            elements.deleteAccountForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleDeleteAccount();
            });
            
            // 清除已登出账号对话框
            elements.closeClearUsersBtn.addEventListener('click', () => hideDialog(elements.clearUsersDialog));
            elements.cancelClearUsersBtn.addEventListener('click', () => hideDialog(elements.clearUsersDialog));
            elements.confirmClearAllBtn.addEventListener('click', handleClearAllUsers);
            
            // 导入对话框事件
            elements.closeImportBtn.addEventListener('click', () => hideDialog(elements.importDialog));
            elements.cancelImportBtn.addEventListener('click', () => hideDialog(elements.importDialog));
            elements.importFile.addEventListener('change', handleImportFileChange);
            elements.confirmImportBtn.addEventListener('click', importData);
            
            // 点击对话框外部关闭对话框
            document.querySelectorAll('.dialog-overlay').forEach(dialog => {
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        dialog.classList.remove('active');
                    }
                });
            });
        }
        
        // 处理登录
        function handleLogin() {
            const username = elements.username.value.trim();
            const password = elements.password.value.trim();
            
            if (!username || !password) {
                showLoginMessage('请输入账号和密码');
                return;
            }
            
            // 显示加载动画
            showLoginLoading(true);
            
            // 模拟登录延迟
            setTimeout(() => {
                const result = loginUser(username, password);
                
                if (result.success) {
                    // 保存记住的登录信息
                    saveRememberedUser();
                    
                    // 切换到主应用界面
                    elements.loginContainer.style.display = 'none';
                    elements.appContainer.style.display = 'flex';
                    
                    // 初始化主应用
                    initMainApp();
                    
                    showStatus('登录成功 ✓');
                } else {
                    showLoginMessage(result.message);
                }
                
                // 隐藏加载动画
                showLoginLoading(false);
            }, 800);
        }
        
        // 处理注册
        function handleRegister() {
            const username = elements.registerUsername.value.trim();
            const password = elements.registerPassword.value.trim();
            const confirmPassword = elements.registerConfirmPassword.value.trim();
            
            if (!username || !password || !confirmPassword) {
                elements.loginError.textContent = '请填写所有必填项';
                elements.loginError.style.display = 'block';
                return;
            }
            
            if (password !== confirmPassword) {
                elements.loginError.textContent = '两次输入的密码不一致';
                elements.loginError.style.display = 'block';
                return;
            }
            
            const result = registerUser(username, password);
            
            if (result.success) {
                hideDialog(elements.registerDialog);
                showLoginMessage(result.message, 'success');
                
                // 自动填充登录表单
                elements.username.value = username;
                elements.password.value = password;
                elements.loginBtn.focus();
                
                // 清空注册表单
                elements.registerUsername.value = '';
                elements.registerPassword.value = '';
                elements.registerConfirmPassword.value = '';
            } else {
                elements.loginError.textContent = result.message;
                elements.loginError.style.display = 'block';
            }
        }
        
        // 处理忘记密码
        function handleForgotPassword() {
            const username = elements.forgotUsername.value.trim();
            const newPassword = elements.newPassword.value.trim();
            const confirmNewPassword = elements.confirmNewPassword.value.trim();
            
            if (!username || !newPassword || !confirmNewPassword) {
                elements.forgotPasswordError.textContent = '请填写所有必填项';
                elements.forgotPasswordError.style.display = 'block';
                return;
            }
            
            if (newPassword !== confirmNewPassword) {
                elements.forgotPasswordError.textContent = '两次输入的密码不一致';
                elements.forgotPasswordError.style.display = 'block';
                return;
            }
            
            const result = resetPassword(username, newPassword);
            
            if (result.success) {
                hideDialog(elements.forgotPasswordDialog);
                showLoginMessage(result.message, 'success');
                
                // 如果重置的是当前登录用户的密码，自动登出
                if (state.currentUser === username) {
                    logoutUser();
                    showLoginMessage('密码已重置，请重新登录', 'success');
                }
                
                // 清空表单
                elements.forgotUsername.value = '';
                elements.newPassword.value = '';
                elements.confirmNewPassword.value = '';
            } else {
                elements.forgotPasswordError.textContent = result.message;
                elements.forgotPasswordError.style.display = 'block';
            }
        }
        
        // 处理注销账号
        function handleDeleteAccount() {
            const username = elements.deleteAccountName.textContent;
            const password = elements.deleteAccountPassword.value.trim();
            
            if (!password) {
                elements.deleteAccountError.textContent = '请输入密码确认';
                elements.deleteAccountError.style.display = 'block';
                return;
            }
            
            const result = deleteAccount(username, password);
            
            if (result.success) {
                hideDialog(elements.deleteAccountDialog);
                showLoginMessage(result.message, 'success');
                
                // 清空登录表单
                elements.username.value = '';
                elements.password.value = '';
                
                // 清空注销表单
                elements.deleteAccountPassword.value = '';
            } else {
                elements.deleteAccountError.textContent = result.message;
                elements.deleteAccountError.style.display = 'block';
            }
        }
        
        // 显示清除已登出账号对话框
        function showClearUsersDialog() {
            const loggedOutUsers = getLoggedOutUsers();
            
            // 修复：无论是否有用户都显示对话框，但提供不同的提示
            if (loggedOutUsers.length === 0) {
                // 渲染空状态
                renderUsersList([]);
                // 禁用清除所有按钮
                elements.confirmClearAllBtn.disabled = true;
            } else {
                // 渲染用户列表
                renderUsersList(loggedOutUsers);
                // 启用清除所有按钮
                elements.confirmClearAllBtn.disabled = false;
            }
            
            showDialog(elements.clearUsersDialog);
        }
        
        // 渲染用户列表（修复版）
        function renderUsersList(users) {
            if (users.length === 0) {
                elements.usersList.innerHTML = '<div style="text-align: center; color: var(--text-light); padding: 20px;">没有已登出的账号</div>';
                return;
            }
            
            elements.usersList.innerHTML = users.map(user => {
                const createdDate = formatDate(user.createdAt);
                const lastLogin = user.lastLogin ? formatDate(user.lastLogin) : '从未登录';
                
                return `
                    <div class="user-list-item">
                        <div class="user-info-small">
                            <div class="user-name-small">${user.username}</div>
                            <div class="user-email-small">${user.noteCount}篇笔记</div>
                            <div style="font-size: 0.7rem; color: var(--text-light); margin-top: 2px;">
                                创建于: ${createdDate} • 最后登录: ${lastLogin}
                            </div>
                        </div>
                        <button class="delete-user-btn" data-username="${user.username}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
            
            // 添加删除按钮事件（修复事件委托问题）
            elements.usersList.querySelectorAll('.delete-user-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const username = btn.dataset.username;
                    showCustomConfirm(
                        '删除账号',
                        `确定要删除账号 "${username}" 的所有数据吗？此操作不可撤销。`,
                        () => {
                            delete state.users[username];
                            saveUsers();
                            // 重新加载列表
                            const loggedOutUsers = getLoggedOutUsers();
                            renderUsersList(loggedOutUsers);
                            // 如果删除后没有用户了，禁用清除所有按钮
                            if (loggedOutUsers.length === 0) {
                                elements.confirmClearAllBtn.disabled = true;
                            }
                            showStatus(`已删除账号: ${username}`);
                        }
                    );
                });
            });
        }
        
        // 自定义确认对话框（修复版）
        function showCustomConfirm(title, message, onConfirm) {
            // 先移除已存在的对话框
            const existingDialog = document.getElementById('customConfirmDialog');
            if (existingDialog) {
                existingDialog.remove();
            }
            
            // 创建对话框HTML
            const confirmHtml = `
                <div class="dialog-overlay active" id="customConfirmDialog" style="display: flex;">
                    <div class="dialog-content" style="max-width: 400px;">
                        <div class="dialog-header">
                            <h3><i class="fas fa-exclamation-triangle" style="margin-right: 10px; color: var(--warning-color);"></i>${title}</h3>
                        </div>
                        <p style="margin-bottom: 20px; color: var(--text-color);">${message}</p>
                        <div class="dialog-actions">
                            <button type="button" class="dialog-btn secondary" id="customConfirmCancel">
                                <i class="fas fa-times" style="margin-right: 5px;"></i>取消
                            </button>
                            <button type="button" class="dialog-btn danger" id="customConfirmOk">
                                <i class="fas fa-check" style="margin-right: 5px;"></i>确认
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // 添加到页面
            document.body.insertAdjacentHTML('beforeend', confirmHtml);
            
            const dialog = document.getElementById('customConfirmDialog');
            
            // 添加事件监听器
            const cancelBtn = document.getElementById('customConfirmCancel');
            const okBtn = document.getElementById('customConfirmOk');
            
            const closeDialog = () => {
                if (dialog && dialog.parentNode) {
                    dialog.remove();
                }
            };
            
            cancelBtn.addEventListener('click', closeDialog);
            
            okBtn.addEventListener('click', () => {
                closeDialog();
                onConfirm();
            });
            
            // 点击外部关闭
            dialog.addEventListener('click', (e) => {
                if (e.target === dialog) {
                    closeDialog();
                }
            });
            
            // Esc键关闭
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    closeDialog();
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }
        
        // 处理清除所有已登出账号（修复版）
        function handleClearAllUsers() {
            const loggedOutUsers = getLoggedOutUsers();
            const userCount = loggedOutUsers.length;
            
            if (userCount <= 0) {
                hideDialog(elements.clearUsersDialog);
                showLoginMessage('没有可清除的已登出账号', 'success');
                return;
            }
            
            showCustomConfirm(
                '清除所有已登出账号',
                `确定要清除所有 ${userCount} 个已登出账号的数据吗？此操作不可撤销。`,
                () => {
                    const clearedCount = clearLoggedOutUsers();
                    hideDialog(elements.clearUsersDialog);
                    showStatus(`已成功清除 ${clearedCount} 个已登出账号的数据`);
                }
            );
        }
        
        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '未知';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }
        
        // 格式化日期时间为完整格式
        function formatDateTime(dateString) {
            if (!dateString) return '未知';
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }).replace(/\//g, '-');
        }
        
        // 格式化相对时间（用于编辑时间）
        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                if (diffMins < 60) {
                    return diffMins <= 1 ? '刚刚' : `${diffMins}分钟前`;
                }
                return `${diffHours}小时前`;
            }
            
            if (diffDays === 1) {
                return '昨天';
            }
            
            if (diffDays < 7) {
                return `${diffDays}天前`;
            }
            
            return date.toLocaleDateString('zh-CN', {
                month: 'short',
                day: 'numeric'
            });
        }
        
        // ==================== 符号选择器修复函数 ====================
        
        // 显示符号选择器（修复版）
        function showSymbolSelector() {
            const textarea = elements.noteEditor;
            
            // 检查编辑器是否获得焦点
            if (document.activeElement !== textarea) {
                textarea.focus();
                setTimeout(() => {
                    showSymbolSelector();
                }, 10);
                return;
            }
            
            state.symbolSelector.visible = true;
            state.symbolSelector.selectedIndex = 0;
            renderSymbolSelector();
            
            // 显示选择器
            elements.symbolSelector.style.display = 'block';
            
            // 获取光标位置
            const cursorPos = getCursorCoordinatesFixed();
            
            // 设置位置
            elements.symbolSelector.style.left = cursorPos.x + 'px';
            elements.symbolSelector.style.top = cursorPos.y + 'px';
            
            // 确保在视口内
            adjustSelectorPosition();
        }
        
        // 修复版：获取光标坐标
        function getCursorCoordinatesFixed() {
            const textarea = elements.noteEditor;
            
            // 获取textarea在视口中的位置
            const textareaRect = textarea.getBoundingClientRect();
            
            // 创建临时div来测量光标位置
            const tempDiv = document.createElement('div');
            const textBeforeCursor = textarea.value.substring(0, textarea.selectionStart);
            
            // 获取textarea的样式
            const textareaStyle = window.getComputedStyle(textarea);
            
            // 复制textarea的样式到临时div
            tempDiv.style.cssText = `
                position: absolute;
                top: -9999px;
                left: -9999px;
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow-wrap: break-word;
                font-family: ${textareaStyle.fontFamily};
                font-size: ${textareaStyle.fontSize};
                line-height: ${textareaStyle.lineHeight};
                padding: ${textareaStyle.padding};
                border: ${textareaStyle.border};
                width: ${textarea.clientWidth}px;
            `;
            
            // 处理文本：将换行符转换为<br>，空格转换为&nbsp;
            let htmlContent = '';
            const lines = textBeforeCursor.split('\n');
            
            for (let i = 0; i < lines.length; i++) {
                if (i > 0) htmlContent += '<br>';
                htmlContent += lines[i].replace(/ /g, '&nbsp;').replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
            }
            
            tempDiv.innerHTML = htmlContent;
            document.body.appendChild(tempDiv);
            
            // 获取临时div的尺寸
            const tempDivRect = tempDiv.getBoundingClientRect();
            
            // 计算光标位置
            let x = textareaRect.left + (tempDivRect.width % textarea.clientWidth);
            let y = textareaRect.top + Math.floor(tempDivRect.height / parseInt(textareaStyle.lineHeight)) * parseInt(textareaStyle.lineHeight);
            
            // 添加滚动偏移
            x += textarea.scrollLeft;
            y += textarea.scrollTop;
            
            // 清理临时元素
            document.body.removeChild(tempDiv);
            
            // 添加边距
            x += 5;
            y += parseInt(textareaStyle.lineHeight) + 5;
            
            // 确保位置在视口内
            x = Math.max(10, Math.min(x, window.innerWidth - 320));
            y = Math.max(10, Math.min(y, window.innerHeight - 250));
            
            return { x: Math.round(x), y: Math.round(y) };
        }
        
        // 调整选择器位置，确保在视口内
        function adjustSelectorPosition() {
            const selectorRect = elements.symbolSelector.getBoundingClientRect();
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let left = parseInt(elements.symbolSelector.style.left);
            let top = parseInt(elements.symbolSelector.style.top);
            
            // 检查是否超出右边界
            if (selectorRect.right > viewportWidth - 10) {
                left -= (selectorRect.right - viewportWidth + 20);
            }
            
            // 检查是否超出下边界
            if (selectorRect.bottom > viewportHeight - 10) {
                top -= (selectorRect.bottom - viewportHeight + 20);
            }
            
            // 检查是否超出左边界
            if (selectorRect.left < 10) {
                left = 10;
            }
            
            // 检查是否超出上边界
            if (selectorRect.top < 10) {
                top = 10;
            }
            
            elements.symbolSelector.style.left = left + 'px';
            elements.symbolSelector.style.top = top + 'px';
        }
        
        // 隐藏符号选择器
        function hideSymbolSelector() {
            state.symbolSelector.visible = false;
            elements.symbolSelector.style.display = 'none';
        }
        
        // 渲染符号选择器
        function renderSymbolSelector() {
            const symbols = state.symbolSelector.symbols;
            
            elements.symbolSelector.innerHTML = symbols.map((symbol, index) => {
                const isActive = index === state.symbolSelector.selectedIndex;
                return `
                    <div class="symbol-item ${isActive ? 'active' : ''}" data-index="${index}">
                        <i class="${symbol.icon} symbol-icon"></i>
                        <div class="symbol-text">${symbol.symbol.replace(/\n/g, '↵')}</div>
                        <div class="symbol-desc">${symbol.description}</div>
                    </div>
                `;
            }).join('');
            
            // 添加点击事件
            document.querySelectorAll('.symbol-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    state.symbolSelector.selectedIndex = index;
                    renderSymbolSelector();
                    insertSelectedSymbol();
                });
            });
        }
        
        // 导航符号选择器
        function navigateSymbolSelector(direction) {
            const symbols = state.symbolSelector.symbols;
            const newIndex = state.symbolSelector.selectedIndex + direction;
            
            if (newIndex >= symbols.length) {
                state.symbolSelector.selectedIndex = 0;
            } else if (newIndex < 0) {
                state.symbolSelector.selectedIndex = symbols.length - 1;
            } else {
                state.symbolSelector.selectedIndex = newIndex;
            }
            
            renderSymbolSelector();
            
            // 滚动到选中项
            const selectedItem = elements.symbolSelector.querySelector('.symbol-item.active');
            if (selectedItem) {
                selectedItem.scrollIntoView({ block: 'nearest' });
            }
        }
        
        // 插入选中的符号
        function insertSelectedSymbol() {
            const symbols = state.symbolSelector.symbols;
            const selectedSymbol = symbols[state.symbolSelector.selectedIndex];
            
            const textarea = elements.noteEditor;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            
            textarea.value = textarea.value.substring(0, start) + selectedSymbol.symbol + textarea.value.substring(end);
            
            // 设置光标位置
            const newCursorPos = start + selectedSymbol.symbol.length;
            textarea.selectionStart = textarea.selectionEnd = newCursorPos;
            
            // 更新笔记内容
            updateNoteContent();
            updateWordCount();
            
            // 隐藏选择器
            hideSymbolSelector();
            
            // 重新聚焦到编辑器
            textarea.focus();
            
            showStatus(`已插入: ${selectedSymbol.description}`);
        }
        
        // 键盘事件处理（修复版）
        function handleKeydownFixed(e) {
            // 如果符号选择器可见，处理选择器导航
            if (state.symbolSelector.visible) {
                switch(e.key) {
                    case 'Tab':
                        e.preventDefault();
                        if (e.shiftKey) {
                            navigateSymbolSelector(-1);
                        } else {
                            navigateSymbolSelector(1);
                        }
                        return;
                    
                    case ' ':
                        e.preventDefault();
                        insertSelectedSymbol();
                        return;
                    
                    case 'Escape':
                        e.preventDefault();
                        hideSymbolSelector();
                        return;
                    
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateSymbolSelector(-1);
                        return;
                    
                    case 'ArrowDown':
                        e.preventDefault();
                        navigateSymbolSelector(1);
                        return;
                    
                    case 'Enter':
                        e.preventDefault();
                        insertSelectedSymbol();
                        return;
                }
            }
            
            // 如果符号选择器不可见且按下了Tab键
            else if (e.key === 'Tab' && !e.ctrlKey && !e.metaKey && !e.altKey) {
                // 检查是否在编辑器中
                if (document.activeElement === elements.noteEditor) {
                    if (state.settings.tabSymbolSelector) {
                        e.preventDefault();
                        showSymbolSelector();
                        return;
                    }
                }
            }
            
            // 原有的智能输入处理
            if (state.settings.smartInputEnabled) {
                handleSmartInput(e);
            }
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // ==================== 事件监听器设置 ====================
        
        // 设置事件监听器
        function setupEventListeners() {
            // 新建笔记按钮
            elements.newNoteBtn.addEventListener('click', createNewNote);
            
            // 标题输入
            elements.noteTitleInput.addEventListener('input', updateNoteTitle);
            
            // 内容输入
            elements.noteEditor.addEventListener('input', handleEditorInput);
            
            // 键盘事件处理
            elements.noteEditor.addEventListener('keydown', handleKeydownFixed);
            
            // 工具栏按钮
            elements.viewToggleBtn.addEventListener('click', togglePreviewMode);
            elements.deleteNoteBtn.addEventListener('click', showDeleteConfirm);
            elements.saveNoteBtn.addEventListener('click', saveNote);
            elements.aboutBtn.addEventListener('click', showAboutDialog);
            elements.settingsBtn.addEventListener('click', showSettingsDialog);
            elements.helpBtn.addEventListener('click', showHelpDialog);
            
            // 登出按钮
            elements.logoutBtn.addEventListener('click', logoutUser);
            
            // 侧边栏控制按钮
            elements.sidebarToggleBtn.addEventListener('click', toggleSidebar);
            elements.showSidebarBtn.addEventListener('click', showSidebar);
            
            // 设置选项监听
            elements.smartInputToggle.addEventListener('change', () => updateSetting('smartInputEnabled', elements.smartInputToggle.checked));
            elements.autoSaveToggle.addEventListener('change', () => updateSetting('autoSaveEnabled', elements.autoSaveToggle.checked));
            elements.tabSymbolSelectorToggle.addEventListener('change', () => updateSetting('tabSymbolSelector', elements.tabSymbolSelectorToggle.checked));
            elements.headingSymbolsToggle.addEventListener('change', () => updateSetting('headingSymbols', elements.headingSymbolsToggle.checked));
            elements.listSymbolsToggle.addEventListener('change', () => updateSetting('listSymbols', elements.listSymbolsToggle.checked));
            elements.taskSymbolsToggle.addEventListener('change', () => updateSetting('taskSymbols', elements.taskSymbolsToggle.checked));
            elements.quoteSymbolsToggle.addEventListener('change', () => updateSetting('quoteSymbols', elements.quoteSymbolsToggle.checked));
            elements.realTimeSearchToggle.addEventListener('change', () => updateSetting('realTimeSearch', elements.realTimeSearchToggle.checked));
            elements.searchHighlightToggle.addEventListener('change', () => updateSetting('searchHighlight', elements.searchHighlightToggle.checked));
            elements.independentViewToggle.addEventListener('change', () => updateSetting('independentView', elements.independentViewToggle.checked));
            elements.autoLogoutToggle.addEventListener('change', () => updateSetting('autoLogout', elements.autoLogoutToggle.checked));
            elements.rememberLoginToggle.addEventListener('change', () => updateSetting('rememberLogin', elements.rememberLoginToggle.checked));
            elements.autoClearUsersToggle.addEventListener('change', () => updateSetting('autoClearUsers', elements.autoClearUsersToggle.checked));
            elements.searchHistoryToggle.addEventListener('change', () => updateSetting('searchHistory', elements.searchHistoryToggle.checked));
            
            // 导出设置选项监听
            elements.defaultExportFormatSelect.addEventListener('change', () => updateSetting('defaultExportFormat', elements.defaultExportFormatSelect.value));
            elements.txtIncludeMetadataToggle.addEventListener('change', () => updateSetting('txtIncludeMetadata', elements.txtIncludeMetadataToggle.checked));
            elements.exportFilenamePrefix.addEventListener('input', () => updateSetting('exportFilenamePrefix', elements.exportFilenamePrefix.value));
            
            // 设置选项监听
            elements.saveIntervalSelect.addEventListener('change', () => updateSetting('autoSaveInterval', parseInt(elements.saveIntervalSelect.value)));
            elements.themeColorSelect.addEventListener('change', () => updateSetting('themeColor', elements.themeColorSelect.value));
            elements.fontSizeSelect.addEventListener('change', () => updateSetting('fontSize', elements.fontSizeSelect.value));
            
            // 导入导出按钮监听
            elements.exportDataBtn.addEventListener('click', showExportDialog);
            elements.importDataBtn.addEventListener('click', showImportDialog);
            
            // 设置导航点击事件
            elements.settingsNav.addEventListener('click', (e) => {
                const navItem = e.target.closest('.settings-nav-item');
                if (navItem) {
                    const tabId = navItem.dataset.tab;
                    switchSettingsTab(tabId);
                }
            });
            
            // 帮助导航点击事件
            elements.helpNav.addEventListener('click', (e) => {
                const navItem = e.target.closest('.help-nav-item');
                if (navItem) {
                    const tabId = navItem.dataset.tab;
                    switchHelpTab(tabId);
                }
            });
            
            // 对话框按钮
            elements.cancelDeleteBtn.addEventListener('click', hideDeleteConfirm);
            elements.confirmDeleteBtn.addEventListener('click', deleteActiveNote);
            elements.closeAboutBtn.addEventListener('click', hideAboutDialog);
            elements.closeSettingsBtn.addEventListener('click', hideSettingsDialog);
            elements.closeHelpBtn.addEventListener('click', hideHelpDialog);
            
            // 搜索相关事件
            let searchTimeout;
            elements.searchInput.addEventListener('input', (e) => {
                const query = e.target.value;
                
                if (state.settings.realTimeSearch) {
                    // 防抖处理，避免频繁搜索
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performSearch(query);
                    }, 300);
                }
                
                // 更新清除按钮状态
                if (query.trim()) {
                    elements.clearSearchBtn.classList.add('visible');
                } else {
                    elements.clearSearchBtn.classList.remove('visible');
                }
                
                // 重置自动登出计时器
                resetAutoLogoutTimer();
            });
            
            elements.searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !state.settings.realTimeSearch) {
                    performSearch(e.target.value);
                }
                if (e.key === 'Escape') {
                    clearSearch();
                }
                
                // 重置自动登出计时器
                resetAutoLogoutTimer();
            });
            
            elements.clearSearchBtn.addEventListener('click', clearSearch);
            
            // 移动端菜单按钮
            elements.mobileMenuBtn.addEventListener('click', toggleSidebar);
            
            // 点击编辑器外部关闭符号选择器
            document.addEventListener('click', (e) => {
                if (state.symbolSelector.visible && 
                    !elements.symbolSelector.contains(e.target) && 
                    e.target !== elements.noteEditor) {
                    hideSymbolSelector();
                }
                
                // 重置自动登出计时器
                resetAutoLogoutTimer();
            });
            
            // 点击侧边栏外部关闭侧边栏（移动端）
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 768 && 
                    state.sidebarVisible && 
                    !elements.sidebar.contains(e.target) && 
                    e.target !== elements.mobileMenuBtn) {
                    toggleSidebar();
                }
            });
            
            // 预览模式下任务勾选事件委托
            elements.previewContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('task-checkbox')) {
                    toggleTaskCompletion(e.target);
                }
            });
            
            // 用户活动监听（用于自动登出）
            document.addEventListener('mousemove', resetAutoLogoutTimer);
            document.addEventListener('keydown', resetAutoLogoutTimer);
            document.addEventListener('click', resetAutoLogoutTimer);
        }
        
        // 编辑器输入处理
        function handleEditorInput() {
            updateNoteContent();
            updateWordCount();
            
            // 自动保存功能 - 使用设置的间隔时间
            if (!state.settings.autoSaveEnabled) return;
            
            clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(() => {
                saveNote();
            }, state.settings.autoSaveInterval || 180000);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 设置键盘快捷键
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ctrl+F 聚焦搜索框
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
                    e.preventDefault();
                    elements.searchInput.focus();
                    elements.searchInput.select();
                    return;
                }
                
                // Ctrl+Shift+N 新建笔记（修复浏览器冲突）
                if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key.toLowerCase() === 'n') {
                    e.preventDefault();
                    createNewNote();
                    return;
                }
                
                // 忽略在输入框中的快捷键（除了全局快捷键）
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    // 只处理全局快捷键
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key.toLowerCase()) {
                            case 'e':
                                e.preventDefault();
                                togglePreviewMode();
                                break;
                            case 's':
                                e.preventDefault();
                                saveNote();
                                break;
                            case 'h':
                                e.preventDefault();
                                toggleHelpDialog();
                                break;
                            case 'd':
                                e.preventDefault();
                                showDeleteConfirm();
                                break;
                            case 'i':
                                e.preventDefault();
                                toggleAboutDialog();
                                break;
                        }
                    }
                    
                    return;
                }
                
                // 全局快捷键
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key.toLowerCase()) {
                        case 'e':
                            e.preventDefault();
                            togglePreviewMode();
                            break;
                        case 's':
                            e.preventDefault();
                            saveNote();
                            break;
                        case 'h':
                            e.preventDefault();
                            toggleHelpDialog();
                            break;
                        case 'd':
                            e.preventDefault();
                            showDeleteConfirm();
                            break;
                        case ',':
                            e.preventDefault();
                            toggleSettingsDialog();
                            break;
                        case 'i':
                            e.preventDefault();
                            toggleAboutDialog();
                            break;
                    }
                }
                
                // 重置自动登出计时器
                resetAutoLogoutTimer();
            });
        }
        
        // 切换设置标签页
        function switchSettingsTab(tabId) {
            // 更新导航项状态
            elements.settingsNav.querySelectorAll('.settings-nav-item').forEach(item => {
                if (item.dataset.tab === tabId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // 更新内容区显示
            elements.settingsContent.querySelectorAll('.settings-section').forEach(section => {
                if (section.id === `${tabId}-section`) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }
        
        // 切换帮助标签页
        function switchHelpTab(tabId) {
            // 更新导航项状态
            elements.helpNav.querySelectorAll('.help-nav-item').forEach(item => {
                if (item.dataset.tab === tabId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            
            // 更新内容区显示
            elements.helpContent.querySelectorAll('.help-section').forEach(section => {
                if (section.id === `${tabId}-section`) {
                    section.classList.add('active');
                } else {
                    section.classList.remove('active');
                }
            });
        }
        
        // 响应式行为设置
        function setupResponsiveBehavior() {
            updateSidebarVisibility();
            
            window.addEventListener('resize', () => {
                const wasMobile = window.innerWidth <= 768;
                const isMobile = window.innerWidth <= 768;
                
                if (wasMobile !== isMobile) {
                    if (isMobile) {
                        // 切换到移动端模式
                        state.sidebarVisible = false;
                        elements.mobileMenuBtn.style.display = 'block';
                    } else {
                        // 切换到桌面端模式
                        state.sidebarVisible = true;
                        elements.mobileMenuBtn.style.display = 'none';
                    }
                    updateSidebarVisibility();
                }
            });
        }
        
        // 渲染笔记列表
        function renderNotesList() {
            if (state.notes.length === 0) {
                elements.notesList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-light); font-size: 0.9rem; animation: fadeIn 0.3s;">暂无笔记，点击上方按钮创建</div>';
                return;
            }
            
            const notesToShow = state.searchResults.length > 0 ? 
                state.searchResults.map(r => r.note) : 
                state.notes;
            
            elements.notesList.innerHTML = notesToShow.map(note => {
                const isActive = note.id === state.activeNoteId;
                const createdDate = formatDateTime(note.createdAt);
                const updatedDate = formatRelativeTime(note.updatedAt);
                
                let noteClass = 'note-item';
                if (isActive) noteClass += ' active';
                
                // 处理标题高亮
                let displayTitle = note.title || '无标题';
                if (state.searchQuery && state.settings.searchHighlight) {
                    displayTitle = highlightText(displayTitle, state.searchQuery);
                }
                
                // 计算当前笔记的字数
                const noteWordCount = countWords(note.title) + countWords(note.content);
                
                // 获取笔记的预览模式状态
                const isNoteInPreview = note.previewMode || false;
                
                return `
                    <div class="${noteClass}" data-id="${note.id}">
                        <div class="note-title">${displayTitle}</div>
                        <div class="note-meta">
                            <div class="note-date">
                                <span>${createdDate}</span>
                                <span class="edit-time">${updatedDate} 
                                    <i class="fas fa-${isNoteInPreview ? 'eye' : 'edit'}" style="margin-left: 4px; font-size: 0.6rem;"></i>
                                </span>
                            </div>
                            <div class="note-word-count">${noteWordCount.toLocaleString()}字</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 为每个笔记项添加点击事件
            document.querySelectorAll('.note-item').forEach(item => {
                item.addEventListener('click', () => {
                    const noteId = item.dataset.id;
                    setActiveNote(noteId);
                    
                    if (window.innerWidth <= 768) {
                        toggleSidebar();
                    }
                    
                    // 重置自动登出计时器
                    resetAutoLogoutTimer();
                });
            });
        }
        
        // 创建新笔记
        function createNewNote() {
            const now = new Date().toISOString();
            const newNote = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                title: '',
                content: '',
                createdAt: now,
                updatedAt: now,
                previewMode: false
            };
            
            state.notes.unshift(newNote);
            setActiveNote(newNote.id);
            renderNotesList();
            updateWordCount();
            saveCurrentUserData();
            showStatus('已创建新笔记');
            
            setTimeout(() => {
                elements.noteTitleInput.focus();
            }, 100);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 设置活动笔记
        function setActiveNote(noteId) {
            state.activeNoteId = noteId;
            const note = state.notes.find(n => n.id === noteId);
            
            if (note) {
                elements.noteTitleInput.value = note.title;
                elements.noteEditor.value = note.content;
                
                // 设置预览模式状态
                if (state.settings.independentView) {
                    // 每个笔记独立保存视图状态
                    state.isPreviewMode = note.previewMode || false;
                }
                
                // 更新UI状态
                updateViewUI();
                updatePreview();
                
                elements.emptyState.style.display = 'none';
                elements.editorContainer.style.display = 'flex';
                elements.toolbar.classList.remove('hidden');
                
                renderNotesList();
                updateWordCount();
                
                // 滚动到编辑器顶部
                elements.editorContainer.scrollTop = 0;
            }
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 更新笔记标题
        function updateNoteTitle() {
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if (note) {
                note.title = elements.noteTitleInput.value;
                note.updatedAt = new Date().toISOString();
                renderNotesList();
                updateWordCount();
                saveCurrentUserData();
            }
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 更新笔记内容
        function updateNoteContent() {
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if (note) {
                note.content = elements.noteEditor.value;
                note.updatedAt = new Date().toISOString();
                
                if (state.isPreviewMode) {
                    updatePreview();
                }
                
                renderNotesList();
                saveCurrentUserData();
            }
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 智能输入处理
        function handleSmartInput(e) {
            if (!state.settings.smartInputEnabled) return;
            
            const textarea = elements.noteEditor;
            const cursorPos = textarea.selectionStart;
            const textBeforeCursor = textarea.value.substring(0, cursorPos);
            const lines = textBeforeCursor.split('\n');
            const currentLine = lines[lines.length - 1];
            
            if (e.key === ' ' && !e.shiftKey) {
                for (const [symbol, data] of Object.entries(symbolMap)) {
                    if (currentLine === symbol && data.enabled()) {
                        e.preventDefault();
                        
                        const textAfterCursor = textarea.value.substring(cursorPos);
                        const newText = textBeforeCursor.slice(0, -symbol.length) + data.text + textAfterCursor;
                        
                        textarea.value = newText;
                        textarea.selectionStart = textarea.selectionEnd = cursorPos - symbol.length + data.text.length;
                        
                        updateNoteContent();
                        updateWordCount();
                        break;
                    }
                }
            }
            
            if (e.key === 'Enter' && !e.shiftKey) {
                const listMatch = currentLine.match(/^(\s*)([-*+]|\d+\.)\s+(.*)/);
                const taskMatch = currentLine.match(/^(\s*)([-*+])\s+\[([ x])\]\s+(.*)/);
                
                if (taskMatch) {
                    e.preventDefault();
                    const indent = taskMatch[1];
                    const symbol = taskMatch[2];
                    const textAfterCursor = textarea.value.substring(cursorPos);
                    const newText = `${indent}${symbol} [ ] `;
                    
                    textarea.value = textBeforeCursor + '\n' + newText + textAfterCursor;
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + 1 + newText.length;
                    
                    updateNoteContent();
                    updateWordCount();
                } else if (listMatch) {
                    e.preventDefault();
                    const indent = listMatch[1];
                    let symbol = listMatch[2];
                    
                    if (/^\d+\.$/.test(symbol)) {
                        const num = parseInt(symbol);
                        symbol = (num + 1) + '.';
                    }
                    
                    const textAfterCursor = textarea.value.substring(cursorPos);
                    const newText = `${indent}${symbol} `;
                    
                    textarea.value = textBeforeCursor + '\n' + newText + textAfterCursor;
                    textarea.selectionStart = textarea.selectionEnd = cursorPos + 1 + newText.length;
                    
                    updateNoteContent();
                    updateWordCount();
                }
            }
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 加载设置
        function loadSettings() {
            elements.smartInputToggle.checked = state.settings.smartInputEnabled;
            elements.autoSaveToggle.checked = state.settings.autoSaveEnabled;
            elements.tabSymbolSelectorToggle.checked = state.settings.tabSymbolSelector;
            elements.headingSymbolsToggle.checked = state.settings.headingSymbols;
            elements.listSymbolsToggle.checked = state.settings.listSymbols;
            elements.taskSymbolsToggle.checked = state.settings.taskSymbols;
            elements.quoteSymbolsToggle.checked = state.settings.quoteSymbols;
            elements.realTimeSearchToggle.checked = state.settings.realTimeSearch;
            elements.searchHighlightToggle.checked = state.settings.searchHighlight;
            elements.independentViewToggle.checked = state.settings.independentView;
            elements.autoLogoutToggle.checked = state.settings.autoLogout;
            elements.rememberLoginToggle.checked = state.settings.rememberLogin;
            elements.autoClearUsersToggle.checked = state.settings.autoClearUsers;
            elements.searchHistoryToggle.checked = state.settings.searchHistory;
            
            // 加载导出设置
            elements.defaultExportFormatSelect.value = state.settings.defaultExportFormat;
            elements.txtIncludeMetadataToggle.checked = state.settings.txtIncludeMetadata;
            elements.exportFilenamePrefix.value = state.settings.exportFilenamePrefix;
            
            // 加载其他设置
            elements.saveIntervalSelect.value = state.settings.autoSaveInterval;
            elements.themeColorSelect.value = state.settings.themeColor;
            elements.fontSizeSelect.value = state.settings.fontSize;
        }
        
        // 更新设置
        function updateSetting(key, value) {
            state.settings[key] = value;
            saveCurrentUserData();
            
            // 立即应用某些设置的更改
            if (key === 'themeColor' || key === 'fontSize') {
                applySettings();
            }
            
            // 如果关闭了自动登出，清除计时器
            if (key === 'autoLogout' && !value && state.autoLogoutTimer) {
                clearTimeout(state.autoLogoutTimer);
                state.autoLogoutTimer = null;
            }
            
            // 如果开启了自动登出，重置计时器
            if (key === 'autoLogout' && value) {
                resetAutoLogoutTimer();
            }
            
            // 如果关闭了记住登录，清除信息
            if (key === 'rememberLogin' && !value) {
                clearRememberedUser();
            }
            
            const settingNames = {
                smartInputEnabled: '智能输入',
                autoSaveEnabled: '自动保存',
                tabSymbolSelector: 'Tab键符号选择器',
                headingSymbols: '标题符号',
                listSymbols: '列表符号',
                taskSymbols: '任务符号',
                quoteSymbols: '引用符号',
                realTimeSearch: '实时搜索',
                searchHighlight: '搜索高亮',
                independentView: '独立笔记视图状态',
                autoLogout: '自动登出',
                rememberLogin: '记住登录',
                autoClearUsers: '自动清除未登录账号',
                searchHistory: '搜索历史',
                autoSaveInterval: '自动保存间隔',
                themeColor: '主题颜色',
                fontSize: '字体大小',
                defaultExportFormat: '默认导出格式',
                txtIncludeMetadata: 'TXT导出包含元数据',
                exportFilenamePrefix: '导出文件名前缀'
            };
            
            const status = typeof value === 'boolean' ? (value ? '启用' : '禁用') : '已更新';
            showStatus(`${settingNames[key]}${status}`);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 切换预览模式
        function togglePreviewMode() {
            state.isPreviewMode = !state.isPreviewMode;
            
            // 如果启用了独立视图状态，保存到当前笔记
            if (state.settings.independentView && state.activeNoteId) {
                const note = state.notes.find(n => n.id === state.activeNoteId);
                if (note) {
                    note.previewMode = state.isPreviewMode;
                    saveCurrentUserData();
                }
            }
            
            updateViewUI();
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 更新视图UI
        function updateViewUI() {
            if (state.isPreviewMode) {
                elements.noteEditor.style.display = 'none';
                elements.previewContainer.style.display = 'block';
                elements.viewToggleBtn.innerHTML = '<i class="fas fa-edit"></i>';
                elements.viewToggleBtn.title = '编辑模式 (Ctrl+E)';
                elements.viewToggleBtn.classList.add('active');
                updatePreview();
            } else {
                elements.noteEditor.style.display = 'block';
                elements.previewContainer.style.display = 'none';
                elements.viewToggleBtn.innerHTML = '<i class="fas fa-eye"></i>';
                elements.viewToggleBtn.title = '预览模式 (Ctrl+E)';
                elements.viewToggleBtn.classList.remove('active');
            }
        }
        
        // 更新预览
        function updatePreview() {
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if (note) {
                let html = convertMarkdownToHtml(note.content);
                elements.previewContainer.innerHTML = html;
            }
        }
        
        // 将Markdown转换为HTML
        function convertMarkdownToHtml(content) {
            if (!content) return '';
            
            let taskIndex = 0;
            const taskMap = new Map();
            
            // 首先处理任务项
            let processedContent = content
                // 处理未完成任务
                .replace(/^- \[ \] (.*$)/gm, (match, taskText) => {
                    taskIndex++;
                    taskMap.set(taskIndex, { text: taskText, completed: false });
                    return `<div class="task-item">
                        <input type="checkbox" class="task-checkbox" id="task-${taskIndex}" data-index="${taskIndex}">
                        <label for="task-${taskIndex}" class="task-text">${taskText}</label>
                    </div>`;
                })
                // 处理已完成任务
                .replace(/^- \[x\] (.*$)/gmi, (match, taskText) => {
                    taskIndex++;
                    taskMap.set(taskIndex, { text: taskText, completed: true });
                    return `<div class="task-item">
                        <input type="checkbox" class="task-checkbox" id="task-${taskIndex}" checked data-index="${taskIndex}">
                        <label for="task-${taskIndex}" class="task-text completed">${taskText}</label>
                    </div>`;
                });
            
            // 然后处理其他Markdown
            let html = processedContent
                // 普通无序列表
                .replace(/^\s*[-*] (?!\[[ x]\])(.*$)/gm, '<li>$1</li>')
                // 标题
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                // 粗体
                .replace(/\*\*(.*)\*\*/g, '<strong>$1</strong>')
                // 斜体
                .replace(/\*(.*)\*/g, '<em>$1</em>')
                // 引用
                .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
                // 有序列表
                .replace(/^\s*\d+\. (.*$)/gm, '<li>$1</li>')
                // 链接
                .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                // 换行
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
            
            // 包装段落
            html = html.replace(/(<\/h[1-3]>|<blockquote>|<\/blockquote>|<ul>|<\/ul>|<ol>|<\/ol>)/g, '</p>$1<p>');
            html = '<p>' + html + '</p>';
            html = html.replace(/<p><\/p>/g, '');
            
            // 处理任务列表
            if (html.includes('task-item')) {
                html = html.replace(/(<div class="task-item">.*<\/div>)/s, (match) => {
                    const tasks = match.match(/<div class="task-item">.*?<\/div>/gs) || [];
                    return '</p><div class="task-list">' + tasks.join('') + '</div><p>';
                });
            }
            
            // 处理列表
            html = html.replace(/<li>.*<\/li>/s, (match) => {
                if (match.includes('<ul>') || match.includes('<ol>')) {
                    return match;
                }
                return '</p><ul>' + match + '</ul><p>';
            });
            
            return html;
        }
        
        // 切换任务完成状态
        function toggleTaskCompletion(checkbox) {
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if (!note) return;
            
            const taskIndex = parseInt(checkbox.dataset.index);
            const isCompleted = checkbox.checked;
            
            const label = checkbox.nextElementSibling;
            if (isCompleted) {
                label.classList.add('completed');
            } else {
                label.classList.remove('completed');
            }
            
            const lines = note.content.split('\n');
            let taskCount = 0;
            let foundTask = false;
            
            for (let i = 0; i < lines.length; i++) {
                const taskMatch = lines[i].match(/^(\s*)([-*+])\s+\[([ x])\]\s+(.*)/);
                if (taskMatch) {
                    taskCount++;
                    
                    if (taskCount === taskIndex) {
                        foundTask = true;
                        if (isCompleted) {
                            lines[i] = lines[i].replace(/^- \[ \] /, '- [x] ');
                        } else {
                            lines[i] = lines[i].replace(/^- \[x\] /i, '- [ ] ');
                        }
                        break;
                    }
                }
            }
            
            if (foundTask) {
                note.content = lines.join('\n');
                note.updatedAt = new Date().toISOString();
                elements.noteEditor.value = note.content;
                saveCurrentUserData();
                renderNotesList();
                updateWordCount();
                showStatus(isCompleted ? '任务已完成 ✓' : '任务已取消完成');
            }
            
            // 重置自动登out计时器
            resetAutoLogoutTimer();
        }
        
        // 保存笔记
        function saveNote() {
            const note = state.notes.find(n => n.id === state.activeNoteId);
            if (note) {
                note.updatedAt = new Date().toISOString();
                saveCurrentUserData();
                renderNotesList();
                showStatus('笔记已保存 ✓');
            }
            
            // 重置自动登out计时器
            resetAutoLogoutTimer();
        }
        
        // 对话框控制函数
        function showDeleteConfirm() {
            if (!state.activeNoteId) return;
            showDialog(elements.deleteConfirm);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        function hideDeleteConfirm() {
            hideDialog(elements.deleteConfirm);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        function showAboutDialog() {
            showDialog(elements.aboutDialog);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        function hideAboutDialog() {
            hideDialog(elements.aboutDialog);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        function toggleAboutDialog() {
            elements.aboutDialog.classList.toggle('active');
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        function showSettingsDialog() {
            showDialog(elements.settingsDialog);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        function hideSettingsDialog() {
            hideDialog(elements.settingsDialog);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        function toggleSettingsDialog() {
            elements.settingsDialog.classList.toggle('active');
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        function showHelpDialog() {
            showDialog(elements.helpDialog);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        function hideHelpDialog() {
            hideDialog(elements.helpDialog);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        function toggleHelpDialog() {
            elements.helpDialog.classList.toggle('active');
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 删除活动笔记
        function deleteActiveNote() {
            if (!state.activeNoteId) return;
            
            const noteIndex = state.notes.findIndex(n => n.id === state.activeNoteId);
            if (noteIndex !== -1) {
                const deletedNote = state.notes[noteIndex];
                state.notes.splice(noteIndex, 1);
                saveCurrentUserData();
                renderNotesList();
                updateWordCount();
                hideDeleteConfirm();
                
                if (state.notes.length > 0) {
                    setActiveNote(state.notes[Math.min(noteIndex, state.notes.length - 1)].id);
                } else {
                    showEmptyState();
                }
                
                showStatus(`已删除: ${deletedNote.title || '无标题笔记'}`);
            }
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 显示空状态
        function showEmptyState() {
            elements.emptyState.style.display = 'flex';
            elements.editorContainer.style.display = 'none';
            elements.toolbar.classList.add('hidden');
            state.activeNoteId = null;
            state.isPreviewMode = false;
            elements.noteTitleInput.value = '';
            elements.noteEditor.value = '';
            updateWordCount();
        }
        
        // 显示状态消息
        function showStatus(message) {
            elements.statusMessage.textContent = message;
            elements.statusMessage.classList.add('show');
            
            setTimeout(() => {
                elements.statusMessage.classList.remove('show');
            }, 2000);
            
            // 重置自动登出计时器
            resetAutoLogoutTimer();
        }
        
        // 初始化应用
        initApp();
    </script>
</body>
</html>