<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MelodyBox 音乐播放器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 添加元数据解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/jsmediatags@3.9.7/dist/jsmediatags.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/music-metadata-browser@2.5.4/dist/index.min.js"></script>
    <!-- 添加JSZip库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* 基础样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            min-height: 100vh;
            overflow: hidden;
            background-color: #0F1A30;
            transition: background-image 0.5s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        
        /* 背景遮罩层，用于调整背景亮度 */
        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3);
            z-index: -1;
        }
        
        /* 波纹效果样式 */
        .ripple {
            position: absolute;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(0);
            animation: ripple-animation 0.6s linear;
            pointer-events: none;
        }
        
        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* 进度条小球样式 */
        .progress-ball {
            position: absolute;
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #9D4EDD, #00F5D4);
            border-radius: 50%;
            top: -4px;
            transform: translateX(-50%);
            box-shadow: 0 0 12px rgba(157, 78, 221, 0.8),
                        0 0 24px rgba(0, 245, 212, 0.4);
            z-index: 2;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .progress-ball.visible {
            opacity: 1;
        }
        
        /* 自定义对话框样式 - 更新为毛玻璃效果 */
        .custom-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .custom-dialog.closing {
            animation: fadeOut 0.3s ease forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .custom-dialog-content {
            background: rgba(15, 26, 48, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .custom-dialog.closing .custom-dialog-content {
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        @keyframes slideDown {
            from {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            to {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
        }
        
        .custom-dialog-title {
            font-size: 1.3rem;
            color: #fff;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .custom-dialog-message {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.5;
            font-size: 0.95rem;
        }
        
        .custom-dialog-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .custom-dialog-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .custom-dialog-btn.primary {
            background: rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .custom-dialog-btn.primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(157, 78, 221, 0.3) 0%, 
                rgba(0, 245, 212, 0.3) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .custom-dialog-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .custom-dialog-btn.primary:hover::before {
            opacity: 1;
        }
        
        .custom-dialog-btn:active {
            transform: translateY(0);
        }
        
        /* 壁纸选择模态框 */
        .wallpaper-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .wallpaper-modal.closing {
            animation: fadeOut 0.3s ease forwards;
        }
        
        .wallpaper-modal-content {
            background: rgba(15, 26, 48, 0.85);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 22px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .wallpaper-modal.closing .wallpaper-modal-content {
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .wallpaper-modal h3 {
            margin-bottom: 18px;
            color: #fff;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .wallpaper-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 5px;
        }
        
        .wallpaper-item {
            position: relative;
            cursor: pointer;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 16/9;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .wallpaper-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .wallpaper-item.active {
            border-color: #9D4EDD;
            box-shadow: 0 0 0 3px rgba(157, 78, 221, 0.3);
        }
        
        .wallpaper-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .wallpaper-item .wallpaper-check {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(15, 26, 48, 0.8);
            color: #9D4EDD;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .wallpaper-item.active .wallpaper-check {
            opacity: 1;
        }
        
        .wallpaper-item-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 8px;
            background: rgba(0, 0, 0, 0.7);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .wallpaper-item:hover .wallpaper-item-actions {
            opacity: 1;
        }
        
        .wallpaper-item-action-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .wallpaper-item-action-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .wallpaper-item-action-btn.delete {
            color: #FF6B6B;
        }
        
        .wallpaper-item-action-btn.delete:hover {
            color: #FF3B3B;
            background: rgba(255, 107, 107, 0.1);
        }
        
        /* 欢迎界面 */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(15, 26, 48, 0.9) 0%, rgba(29, 53, 87, 0.9) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
        
        .welcome-screen.hidden {
            opacity: 0;
            transform: translateY(-100%);
            pointer-events: none;
        }
        
        .welcome-logo {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .welcome-logo h1 {
            font-size: 2.8rem;
            margin-bottom: 8px;
            background: linear-gradient(90deg, #9D4EDD, #00F5D4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .welcome-logo p {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 300;
        }
        
        .welcome-animation {
            width: 240px;
            height: 240px;
            position: relative;
            margin-bottom: 40px;
        }
        
        .music-note {
            position: absolute;
            font-size: 2.2rem;
            color: #9D4EDD;
            opacity: 0;
            animation: floatNote 2s ease-in-out infinite;
        }
        
        .music-note:nth-child(1) { top: 30px; left: 30px; animation-delay: 0s; }
        .music-note:nth-child(2) { top: 30px; right: 30px; animation-delay: 0.2s; }
        .music-note:nth-child(3) { bottom: 30px; left: 30px; animation-delay: 0.4s; }
        .music-note:nth-child(4) { bottom: 30px; right: 30px; animation-delay: 0.6s; }
        .music-note:nth-child(5) { top: 90px; left: 90px; animation-delay: 0.8s; }
        
        @keyframes floatNote {
            0%, 100% { 
                opacity: 0; 
                transform: translateY(0) scale(0.8); 
            }
            50% { 
                opacity: 1; 
                transform: translateY(-12px) scale(1); 
            }
        }
        
        .press-any-key {
            text-align: center;
            animation: pulse 2s infinite;
        }
        
        .press-any-key h2 {
            font-size: 1.3rem;
            margin-bottom: 6px;
            color: #fff;
            font-weight: 600;
        }
        
        .press-any-key p {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* 播放器主容器 */
        .player-container {
            display: none;
            width: 100%;
            height: 100vh;
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
        
        .player-container.active {
            display: flex;
            opacity: 1;
            transform: translateY(0);
        }
        
        /* 左侧控制面板 - 毛玻璃效果 */
        .control-panel {
            width: 40%;
            height: 100vh;
            background: rgba(15, 26, 48, 0.3);
            backdrop-filter: var(--blur-intensity, blur(20px));
            padding: 25px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 10px 0 30px rgba(0, 0, 0, 0.3);
            overflow-y: auto;
        }
        
        /* 头部 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .header h1 {
            font-size: 1.6rem;
            background: linear-gradient(90deg, #9D4EDD, #00F5D4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
        }
        
        .settings-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.8);
            width: 38px;
            height: 38px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: rotate(30deg);
        }
        
        /* 主要内容区域 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-top: -40px;
        }
        
        /* 歌曲信息 */
        .song-info {
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
            height: 60px;
        }
        
        .song-title-container {
            position: relative;
            height: 36px;
            overflow: hidden;
        }
        
        .song-title-wrapper {
            position: absolute;
            white-space: nowrap;
            transition: transform 0.5s ease;
        }
        
        .song-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
            color: #fff;
            white-space: nowrap;
            text-overflow: ellipsis;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            display: inline-block;
        }
        
        .song-title.long {
            animation: scrollText 15s linear infinite;
        }
        
        @keyframes scrollText {
            0% { transform: translateX(0); }
            10% { transform: translateX(0); }
            90% { transform: translateX(calc(-100% + 300px)); }
            100% { transform: translateX(calc(-100% + 300px)); }
        }
        
        .song-artist {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 专辑封面 */
        .album-art-container {
            margin-bottom: 30px;
            position: relative;
        }
        
        .album-art {
            width: 220px;
            height: 220px;
            margin: 0 auto;
            border-radius: 18px;
            overflow: hidden;
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.05);
            position: relative;
            transition: transform 0.5s ease;
        }
        
        .album-art:hover {
            transform: scale(1.02);
        }
        
        .album-art.playing::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(157, 78, 221, 0.1));
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        
        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* 进度条区域 */
        .progress-area {
            margin-bottom: 30px;
            position: relative;
        }
        
        .progress-bar {
            height: 7px;
            width: 100%;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 7px;
            cursor: pointer;
            margin-bottom: 6px;
            position: relative;
            overflow: hidden;
        }
        
        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.03) 0%, 
                rgba(255, 255, 255, 0.1) 50%, 
                rgba(255, 255, 255, 0.03) 100%);
            animation: progressShine 3s infinite linear;
        }
        
        @keyframes progressShine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .progress {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #9D4EDD, #00F5D4);
            border-radius: 7px;
            transition: width 0.1s linear;
            position: relative;
            z-index: 1;
        }
        
        .time {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 300;
        }
        
        /* 控制按钮区域 */
        .controls-container {
            margin-bottom: 25px;
        }
        
        .main-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .playback-controls {
            display: flex;
            gap: 18px;
            align-items: center;
        }
        
        .control-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: #fff;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(157, 78, 221, 0.3) 0%, 
                rgba(0, 245, 212, 0.3) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        .control-btn:hover::before {
            opacity: 1;
        }
        
        .play-pause {
            background: rgba(255, 255, 255, 0.1);
            width: 58px;
            height: 58px;
            font-size: 1.6rem;
            box-shadow: 0 8px 20px rgba(157, 78, 221, 0.3);
        }
        
        .play-pause:hover {
            transform: scale(1.04) translateY(-2px);
            box-shadow: 0 12px 25px rgba(157, 78, 221, 0.4);
        }
        
        .play-pause::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(157, 78, 221, 0.3) 0%, 
                rgba(0, 245, 212, 0.3) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .play-pause:hover::before {
            opacity: 1;
        }
        
        /* 播放模式按钮样式 */
        .play-mode-btn {
            position: relative;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            font-size: 1.1rem;
        }
        
        .play-mode-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            transform: translateY(-2px);
        }
        
        .play-mode-btn.active {
            background: rgba(157, 78, 221, 0.2);
            color: #9D4EDD;
        }
        
        .play-mode-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 100;
        }
        
        .play-mode-btn:hover .play-mode-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        /* 辅助控制区域 - 重新调整布局 */
        .secondary-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
            overflow: visible;
        }
        
        /* 音量控制 */
        .volume-control {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .volume-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
            cursor: pointer;
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
            z-index: 2;
            position: relative;
            overflow: hidden;
        }
        
        .volume-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        
        .volume-slider-container {
            position: absolute;
            left: 50%;
            bottom: 100%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 1;
            background: rgba(15, 26, 48, 0.3);
            backdrop-filter: blur(10px);
            padding: 12px 6px;
            border-radius: 10px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .volume-control:hover .volume-slider-container {
            opacity: 1;
            visibility: visible;
        }
        
        .volume-slider {
            height: 100px;
            width: 5px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            writing-mode: bt-lr;
            -webkit-appearance: slider-vertical;
            transform: rotate(0deg);
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #9D4EDD;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: -5.5px;
        }
        
        .volume-slider::-webkit-slider-thumb:hover {
            background: #00F5D4;
            transform: scale(1.1);
        }
        
        /* 音量百分比显示 */
        .volume-percentage {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.75rem;
            white-space: nowrap;
            min-width: 40px;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 4px;
            pointer-events: none;
        }
        
        .playlist-btn {
            position: relative;
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: #fff;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 42px;
            height: 42px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            position: relative;
            overflow: visible;
        }
        
        .playlist-btn::after {
            content: attr(data-count);
            position: absolute;
            top: -6px;
            right: -6px;
            background: #FF9E00;
            color: #0F1A30;
            font-size: 0.65rem;
            font-weight: bold;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            pointer-events: none;           
        }
        
        .playlist-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }
        
        /* 右侧歌词面板 - 毛玻璃效果 */
        .lyrics-panel {
            width: 60%;
            height: 100vh;
            background: rgba(15, 26, 48, 0.3);
            backdrop-filter: var(--blur-intensity, blur(10px));
            padding: 25px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .lyrics-header {
            margin-bottom: 20px;
            text-align: center;
            position: relative;
        }
        
        .lyrics-header h2 {
            font-size: 1.6rem;
            background: linear-gradient(90deg, #9D4EDD, #00F5D4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
            margin-bottom: 6px;
        }
        
        .lyrics-header p {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .lyrics-actions {
            position: absolute;
            right: 0;
            top: 0;
            display: flex;
            gap: 8px;
        }
        
        .lyrics-action-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 6px 10px;
            border-radius: 6px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .lyrics-action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }
        
        .lyrics-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            position: relative;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        .lyrics-content {
            min-height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 12px 0;
        }
        
        /* 歌词文本布局 */
        .lyrics-line {
            font-size: 1.15rem;
            line-height: 1.4;
            margin-bottom: 16px;
            color: rgba(255, 255, 255, 0.5);
            transition: all 0.3s ease;
            text-align: center;
            padding: 6px 12px;
            border-radius: 8px;
            opacity: 0.7;
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .lyrics-line.past {
            opacity: 0.4;
            transform: scale(0.95);
            font-size: 1.05rem;
        }
        
        .lyrics-line.active {
            color: #fff;
            font-size: 1.3rem;
            font-weight: 600;
            opacity: 1;
            transform: scale(1.05);
            background: rgba(157, 78, 221, 0.15);
            text-shadow: 0 0 12px rgba(157, 78, 221, 0.5);
            line-height: 1.5;
            padding: 8px 15px;
            margin: 10px 0 18px 0;
        }
        
        .lyrics-line.future {
            opacity: 0.6;
            font-size: 1.1rem;
        }
        
        /* 无歌词显示文本 */
        .no-lyrics {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            padding: 70px 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .no-lyrics i {
            font-size: 3rem;
            opacity: 0.3;
            margin: 0;
            display: inline-block;
            vertical-align: middle;
        }
        
        .no-lyrics h3 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .no-lyrics p {
            font-size: 0.95rem;
            margin-bottom: 18px;
        }
        
        .upload-lrc-instruction {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 12px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* 设置页面 - 毛玻璃效果 - 重构为左右布局 */
        /* 主要修改部分：设置页面容器居中 */
        .settings-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 26, 48, 0.7);
            backdrop-filter: var(--blur-intensity, blur(20px));
            z-index: 1000;
            overflow-y: auto;
            padding: 25px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .settings-page.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .settings-container {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            gap: 25px;
            min-height: auto;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
        }
        
        /* 左侧导航栏 */
        .settings-sidebar {
            width: 220px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
            overflow-y: auto;
        }
        
        .settings-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border: none;
            background: transparent;
            text-align: left;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }
        
        .settings-nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
            transform: translateX(4px);
        }
        
        .settings-nav-item.active {
            background: rgba(157, 78, 221, 0.15);
            color: #9D4EDD;
            font-weight: 500;
        }
        
        .settings-nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
        }
        
        .settings-nav-item.danger {
            color: #FF6B6B;
        }
        
        .settings-nav-item.danger:hover {
            background: rgba(255, 107, 107, 0.1);
        }
        
        /* 右侧内容区 */
        .settings-content {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 25px;
            overflow-y: auto;
        }
        
        .settings-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .settings-section.active {
            display: block;
        }
        
        .settings-section h3 {
            font-size: 1.3rem;
            color: #fff;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .settings-section h3 i {
            color: #9D4EDD;
        }
        
        /* 优化设置头部布局 - 按照要求布局 */
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .back-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.8);
            width: 42px;
            height: 42px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .back-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-3px);
        }
        
        .settings-header h2 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, #9D4EDD, #00F5D4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
            text-align: center;
            flex: 1;
            margin: 0;
        }
        
        /* 标题居中容器 */
        .settings-title-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
        }
        
        /* 背景设置区域 */
        .background-settings {
            margin-bottom: 20px;
        }
        
        .background-preview {
            width: 100%;
            height: 200px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        .background-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .background-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .blur-control {
            margin-top: 20px;
        }
        
        .blur-control label {
            display: block;
            margin-bottom: 10px;
            color: #fff;
            font-size: 0.95rem;
        }
        
        .blur-slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            margin-top: 8px;
        }
        
        .blur-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #9D4EDD, #00F5D4);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .blur-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* 毛玻璃百分比显示 */
        .blur-percentage {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .blur-value {
            color: #9D4EDD;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        /* 音乐管理设置 */
        .music-settings {
            margin-bottom: 20px;
        }
        
        .settings-action-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .settings-action-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            border: none;
            background: rgba(255, 255, 255, 0.05);
            text-align: left;
            font-size: 0.95rem;
            position: relative;
            overflow: hidden;
        }
        
        .settings-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            transform: translateX(4px);
        }
        
        .settings-action-btn i {
            width: 20px;
            text-align: center;
            color: #9D4EDD;
            font-size: 1rem;
        }
        
        .settings-action-btn.danger {
            color: #FF6B6B;
        }
        
        .settings-action-btn.danger i {
            color: #FF6B6B;
        }
        
        .settings-action-btn.danger:hover {
            background: rgba(255, 107, 107, 0.1);
        }
        
        /* 数据管理设置 */
        .data-settings {
            margin-bottom: 20px;
        }
        
        /* 设置信息区域 - 优化布局 */
        .system-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            text-align: center;
            padding: 15px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .info-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
        }
        
        .info-value {
            font-size: 1.2rem;
            font-weight: 600;
            color: #9D4EDD;
        }
        
        /* 存储警告样式 */
        .info-value.storage-warning {
            color: #FF9E00 !important;
            animation: pulse 2s infinite;
        }
        
        .info-value.storage-critical {
            color: #FF6B6B !important;
            animation: pulse 1s infinite;
        }
        
        /* 播放列表页面 - 毛玻璃效果 */
        /* 同样修改播放列表页面居中 */
        .playlist-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 26, 48, 0.7);
            backdrop-filter: var(--blur-intensity, blur(20px));
            z-index: 1000;
            overflow-y: auto;
            padding: 25px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .playlist-page.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .playlist-container {
            max-width: 850px;
            margin: 0 auto;
        }
        
        /* 播放列表标题行 - 修改布局 */
        .playlist-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .playlist-header h2 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, #9D4EDD, #00F5D4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 700;
            text-align: center;
            flex: 1;
            margin: 0 20px;
        }
        
        /* 排序按钮位置调整到标题右侧 */
        .playlist-sort-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .sort-btn {
            background: rgba(255, 255, 255, 0.08);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 0.9rem;
            padding: 8px 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            min-width: 80px;
            justify-content: center;
        }
        
        .sort-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            transform: translateY(-2px);
        }
        
        .sort-btn.active {
            background: rgba(157, 78, 221, 0.2);
            color: #9D4EDD;
        }
        
        /* 播放列表统计 - 修改为一个统计项，移除总时长 */
        .playlist-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 22px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            position: relative;
        }
        
        .stats-item {
            text-align: center;
        }
        
        .stats-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #9D4EDD;
            margin-bottom: 4px;
            display: block;
        }
        
        .stats-label {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        /* 歌曲列表容器 */
        .song-list-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 16px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        /* 歌曲项 */
        .song-item {
            display: flex;
            align-items: center;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            background: rgba(255, 255, 255, 0.03);
            overflow: hidden;
        }
        
        .song-item:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: translateX(4px);
        }
        
        .song-item.active {
            background: linear-gradient(90deg, 
                rgba(157, 78, 221, 0.2) 0%, 
                rgba(0, 245, 212, 0.1) 100%);
            border-left: 4px solid #9D4EDD;
            box-shadow: 0 5px 12px rgba(157, 78, 221, 0.1);
        }
        
        /* 歌曲编号样式 */
        .song-number {
            width: 30px;
            text-align: center;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 600;
            margin-right: 12px;
            flex-shrink: 0;
        }
        
        .song-item.active .song-number {
            color: #9D4EDD;
        }
        
        .song-item img {
            width: 55px;
            height: 55px;
            border-radius: 8px;
            margin-right: 16px;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }
        
        .song-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .song-item-title {
            font-weight: 600;
            font-size: 1.05rem;
            color: #fff;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }
        
        .song-item-artist {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .song-item-meta {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }
        
        .song-item-duration {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.5);
            margin-right: 16px;
            font-weight: 500;
            flex-shrink: 0;
        }
        
        /* 歌曲项操作按钮 */
        .song-item-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
            flex-shrink: 0;
        }
        
        .song-item:hover .song-item-actions {
            opacity: 1;
        }
        
        .action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            font-size: 0.8rem;
            width: 34px;
            height: 34px;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            transform: scale(1.05);
        }
        
        /* 空播放列表状态 */
        .empty-playlist {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .empty-playlist i {
            font-size: 3.5rem;
            margin-bottom: 22px;
            opacity: 0.3;
        }
        
        .empty-playlist h3 {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .empty-playlist p {
            font-size: 0.95rem;
        }
        
        /* 编辑模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .modal.closing {
            animation: fadeOut 0.3s ease forwards;
        }
        
        .modal-content {
            background: rgba(15, 26, 48, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 22px;
            width: 90%;
            max-width: 380px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .modal.closing .modal-content {
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }
        
        .modal h3 {
            margin-bottom: 18px;
            color: #fff;
            text-align: center;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.3);
            color: white;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #9D4EDD;
            box-shadow: 0 0 0 3px rgba(157, 78, 221, 0.2);
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 18px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 10px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .save-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .save-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(157, 78, 221, 0.3) 0%, 
                rgba(0, 245, 212, 0.3) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .save-btn:hover::before {
            opacity: 1;
        }
        
        .cancel-btn {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        
        /* 封面编辑模态框 */
        .cover-modal-content {
            background: rgba(15, 26, 48, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 22px;
            width: 90%;
            max-width: 420px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: modalAppear 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .cover-preview {
            width: 160px;
            height: 160px;
            margin: 0 auto 18px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .cover-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .cover-upload-area {
            border: 2px dashed rgba(157, 78, 221, 0.3);
            border-radius: 12px;
            padding: 22px;
            text-align: center;
            margin-bottom: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .cover-upload-area:hover {
            border-color: #9D4EDD;
            background: rgba(157, 78, 221, 0.05);
        }
        
        .cover-upload-area i {
            font-size: 2.2rem;
            color: #9D4EDD;
            margin-bottom: 8px;
        }
        
        .cover-upload-area p {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        
        .cover-upload-area small {
            color: rgba(255, 255, 255, 0.5);
            font-size: 0.8rem;
        }
        
        /* 加载指示器 */
        .loader {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        .loader.active {
            display: flex;
        }
        
        .loader-content {
            text-align: center;
            color: white;
        }
        
        .loader-spinner {
            width: 42px;
            height: 42px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: #9D4EDD;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 键盘快捷键提示 */
        .keyboard-shortcuts {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(15, 26, 48, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            z-index: 100;
            max-width: 250px;
            display: none;
        }
        
        .keyboard-shortcuts.active {
            display: block;
            animation: slideUp 0.3s ease;
        }
        
        .keyboard-shortcuts h4 {
            margin-bottom: 10px;
            color: #9D4EDD;
            font-size: 0.9rem;
        }
        
        .keyboard-shortcut-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        
        .keyboard-key {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .toggle-shortcuts-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #9D4EDD;
            color: white;
            border: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 自定义滚动条 */
        .lyrics-container::-webkit-scrollbar,
        .song-list-container::-webkit-scrollbar,
        .playlist-page::-webkit-scrollbar,
        .control-panel::-webkit-scrollbar,
        .settings-page::-webkit-scrollbar,
        .wallpaper-grid::-webkit-scrollbar,
        .settings-content::-webkit-scrollbar,
        .settings-sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        .lyrics-container::-webkit-scrollbar-track,
        .song-list-container::-webkit-scrollbar-track,
        .playlist-page::-webkit-scrollbar-track,
        .control-panel::-webkit-scrollbar-track,
        .settings-page::-webkit-scrollbar-track,
        .wallpaper-grid::-webkit-scrollbar-track,
        .settings-content::-webkit-scrollbar-track,
        .settings-sidebar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
        }
        
        .lyrics-container::-webkit-scrollbar-thumb,
        .song-list-container::-webkit-scrollbar-thumb,
        .playlist-page::-webkit-scrollbar-thumb,
        .control-panel::-webkit-scrollbar-thumb,
        .settings-page::-webkit-scrollbar-thumb,
        .wallpaper-grid::-webkit-scrollbar-thumb,
        .settings-content::-webkit-scrollbar-thumb,
        .settings-sidebar::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #9D4EDD, #00F5D4);
            border-radius: 8px;
        }
        
        /* 响应式设计 */
        @media (max-width: 1200px) {
            .control-panel, .lyrics-panel {
                width: 50%;
            }
            
            .album-art {
                width: 200px;
                height: 200px;
            }
            
            .lyrics-line {
                font-size: 1.1rem;
            }
            
            .lyrics-line.active {
                font-size: 1.25rem;
            }
            
            .settings-container {
                max-width: 800px;
            }
        }
        
        @media (max-width: 992px) {
            .player-container {
                flex-direction: column;
            }
            
            .control-panel, .lyrics-panel {
                width: 100%;
                height: auto;
            }
            
            .control-panel {
                padding: 22px;
                max-height: 65vh;
            }
            
            .lyrics-panel {
                padding: 22px;
                max-height: 35vh;
            }
            
            .album-art {
                width: 180px;
                height: 180px;
            }
            
            .song-title {
                font-size: 1.4rem;
            }
            
            .lyrics-line {
                font-size: 1.05rem;
                margin-bottom: 14px;
            }
            
            .lyrics-line.active {
                font-size: 1.2rem;
            }
            
            .song-item-actions {
                opacity: 1;
            }
            
            .main-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .playback-controls {
                width: 100%;
                justify-content: center;
                margin-bottom: 15px;
            }
            
            .secondary-controls {
                width: 100%;
                justify-content: center;
            }
            
            .volume-slider-container {
                left: 50%;
                bottom: 100%;
                transform: translateX(-50%);
                margin-left: 0;
                margin-top: 0;
                margin-bottom: 10px;
            }
            
            .settings-container {
                flex-direction: column;
                max-width: 600px;
            }
            
            .settings-sidebar {
                width: 100%;
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .settings-nav-item {
                flex: 1;
                min-width: 140px;
                justify-content: center;
            }
            
            .playlist-header {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .playlist-sort-container {
                order: 3;
                width: 100%;
                justify-content: center;
                margin-top: 10px;
            }
            
            .lyrics-actions {
                position: static;
                margin-top: 10px;
                justify-content: center;
            }
            
            .keyboard-shortcuts {
                bottom: 10px;
                right: 10px;
                max-width: 200px;
                font-size: 0.8rem;
            }
        }
        
        @media (max-width: 768px) {
            .welcome-logo h1 {
                font-size: 2.2rem;
            }
            
            .welcome-animation {
                width: 200px;
                height: 200px;
            }
            
            .control-panel {
                padding: 18px;
            }
            
            .lyrics-panel {
                padding: 18px;
            }
            
            .settings-page {
                padding: 18px;
            }
            
            .playlist-page {
                padding: 18px;
            }
            
            .header h1, .lyrics-header h2 {
                font-size: 1.4rem;
            }
            
            .song-title {
                font-size: 1.3rem;
            }
            
            .playback-controls {
                gap: 12px;
            }
            
            .control-btn {
                width: 44px;
                height: 44px;
                font-size: 1.2rem;
            }
            
            .play-pause {
                width: 52px;
                height: 52px;
                font-size: 1.4rem;
            }
            
            .play-mode-btn {
                width: 38px;
                height: 38px;
                font-size: 1rem;
            }
            
            .settings-header h2, .playlist-header h2 {
                font-size: 1.6rem;
            }
            
            .stats-value {
                font-size: 1.4rem;
            }
            
            .settings-sidebar {
                padding: 12px;
            }
            
            .settings-nav-item {
                padding: 12px;
                font-size: 0.9rem;
            }
            
            .song-item {
                padding: 10px;
            }
            
            .song-number {
                width: 25px;
                margin-right: 8px;
                font-size: 0.8rem;
            }
            
            .song-item img {
                width: 50px;
                height: 50px;
                margin-right: 12px;
            }
            
            .song-item-actions {
                opacity: 1;
                gap: 4px;
            }
            
            .action-btn {
                width: 32px;
                height: 32px;
            }
            
            .keyboard-shortcuts {
                display: none !important;
            }
        }
        
        @media (max-width: 480px) {
            .welcome-logo h1 {
                font-size: 2rem;
            }
            
            .welcome-animation {
                width: 160px;
                height: 160px;
            }
            
            .press-any-key h2 {
                font-size: 1.2rem;
            }
            
            .control-panel, .lyrics-panel {
                padding: 15px;
            }
            
            .settings-page {
                padding: 15px;
            }
            
            .playlist-page {
                padding: 15px;
            }
            
            .album-art {
                width: 160px;
                height: 160px;
            }
            
            .playback-controls {
                gap: 10px;
            }
            
            .control-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1rem;
            }
            
            .play-pause {
                width: 48px;
                height: 48px;
                font-size: 1.3rem;
            }
            
            .play-mode-btn {
                width: 36px;
                height: 36px;
                font-size: 0.9rem;
            }
            
            .volume-slider {
                height: 80px;
            }
            
            .playlist-btn {
                width: 38px;
                height: 38px;
                font-size: 1rem;
            }
            
            .lyrics-line {
                font-size: 1rem;
                margin-bottom: 12px;
            }
            
            .lyrics-line.active {
                font-size: 1.15rem;
            }
            
            .settings-nav-item {
                min-width: 120px;
                font-size: 0.85rem;
                padding: 10px;
            }
            
            .background-actions {
                flex-direction: column;
            }
            
            .song-number {
                width: 22px;
                font-size: 0.75rem;
                margin-right: 6px;
            }
            
            .song-item-duration {
                margin-right: 8px;
                font-size: 0.8rem;
            }
            
            .song-item-actions {
                gap: 3px;
            }
            
            .action-btn {
                width: 28px;
                height: 28px;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- 背景遮罩层 -->
    <div class="background-overlay"></div>
    
    <!-- 自定义对话框 -->
    <div class="custom-dialog" id="customDialog">
        <div class="custom-dialog-content">
            <div class="custom-dialog-title" id="dialogTitle">提示</div>
            <div class="custom-dialog-message" id="dialogMessage">消息内容</div>
            <div class="custom-dialog-buttons">
                <button class="custom-dialog-btn primary" id="dialogConfirmBtn">确定</button>
            </div>
        </div>
    </div>
    
    <!-- 确认对话框 -->
    <div class="custom-dialog" id="confirmDialog">
        <div class="custom-dialog-content">
            <div class="custom-dialog-title" id="confirmDialogTitle">确认</div>
            <div class="custom-dialog-message" id="confirmDialogMessage">确认消息内容</div>
            <div class="custom-dialog-buttons">
                <button class="custom-dialog-btn" id="confirmDialogCancelBtn">取消</button>
                <button class="custom-dialog-btn primary" id="confirmDialogConfirmBtn">确定</button>
            </div>
        </div>
    </div>
    
    <!-- 壁纸选择模态框 -->
    <div class="wallpaper-modal" id="wallpaperModal">
        <div class="wallpaper-modal-content">
            <h3><i class="fas fa-image"></i> 管理壁纸</h3>
            <div class="wallpaper-grid" id="wallpaperGrid">
                <!-- 壁纸将通过JavaScript动态生成 -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn save-btn" id="selectWallpaperBtn">应用选中壁纸</button>
                <button class="modal-btn cancel-btn" id="cancelWallpaperBtn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 键盘快捷键提示 -->
    <div class="keyboard-shortcuts" id="keyboardShortcuts">
        <button class="toggle-shortcuts-btn" id="toggleShortcutsBtn">×</button>
        <h4><i class="fas fa-keyboard"></i> 键盘快捷键</h4>
        <div class="keyboard-shortcut-item">
            <span>播放/暂停</span>
            <span class="keyboard-key">空格</span>
        </div>
        <div class="keyboard-shortcut-item">
            <span>下一首</span>
            <span class="keyboard-key">→</span>
        </div>
        <div class="keyboard-shortcut-item">
            <span>上一首</span>
            <span class="keyboard-key">←</span>
        </div>
        <div class="keyboard-shortcut-item">
            <span>音量增加</span>
            <span class="keyboard-key">↑</span>
        </div>
        <div class="keyboard-shortcut-item">
            <span>音量减少</span>
            <span class="keyboard-key">↓</span>
        </div>
        <div class="keyboard-shortcut-item">
            <span>切换播放模式</span>
            <span class="keyboard-key">M</span>
        </div>
        <div class="keyboard-shortcut-item">
            <span>显示/隐藏快捷键</span>
            <span class="keyboard-key">?</span>
        </div>
    </div>
    
    <!-- 欢迎界面 -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-logo">
            <h1><i class="fas fa-music"></i> MelodyBox</h1>
            <p>沉浸式本地音乐播放体验</p>
        </div>
        
        <div class="welcome-animation">
            <div class="music-note"><i class="fas fa-music"></i></div>
            <div class="music-note"><i class="fas fa-music"></i></div>
            <div class="music-note"><i class="fas fa-music"></i></div>
            <div class="music-note"><i class="fas fa-music"></i></div>
            <div class="music-note"><i class="fas fa-music"></i></div>
        </div>
        
        <div class="press-any-key">
            <h2>按任意键以继续</h2>
            <p>准备好进入音乐世界</p>
        </div>
    </div>
    
    <!-- 播放器主容器 -->
    <div class="player-container" id="playerContainer">
        <!-- 左侧控制面板 -->
        <div class="control-panel">
            <div class="header">
                <h1><i class="fas fa-music"></i> MelodyBox</h1>
                <button class="settings-btn" id="settingsBtn" title="设置">
                    <i class="fas fa-sliders-h"></i>
                </button>
            </div>
            
            <!-- 隐藏的文件输入框 -->
            <input type="file" id="fileInput" accept="audio/*" multiple style="display: none;">
            <input type="file" id="importInput" accept=".json" style="display: none;">
            <input type="file" id="lrcInput" accept=".lrc" style="display: none;">
            <input type="file" id="coverInput" accept="image/*" style="display: none;">
            <input type="file" id="backgroundInput" accept="image/*" style="display: none;">
            <input type="file" id="zipInput" accept=".zip" style="display: none;">
            
            <!-- 主要内容区域 -->
            <div class="main-content">
                <!-- 歌曲信息 -->
                <div class="song-info">
                    <div class="song-title-container">
                        <div class="song-title-wrapper">
                            <div class="song-title" id="songTitle">欢迎使用 MelodyBox</div>
                        </div>
                    </div>
                    <div class="song-artist" id="songArtist">点击右上角设置按钮添加音乐文件</div>
                </div>
                
                <!-- 专辑封面 -->
                <div class="album-art-container">
                    <div class="album-art" id="albumArt">
                        <img src="https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80" alt="专辑封面" id="albumImage">
                    </div>
                </div>
                
                <!-- 进度条区域 -->
                <div class="progress-area">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress" id="progress"></div>
                        <!-- 进度条小球 -->
                        <div class="progress-ball" id="progressBall"></div>
                    </div>
                    <div class="time">
                        <span class="current-time" id="currentTime">0:00</span>
                        <span class="duration" id="duration">0:00</span>
                    </div>
                </div>
                
                <!-- 控制按钮区域 -->
                <div class="controls-container">
                    <div class="main-controls">
                        <!-- 左侧：播放控制按钮 -->
                        <div class="playback-controls">
                            <button class="control-btn" id="prevBtn" title="上一首">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button class="control-btn play-pause" id="playPauseBtn" title="播放/暂停">
                                <i class="fas fa-play" id="playIcon"></i>
                            </button>
                            <button class="control-btn" id="nextBtn" title="下一首">
                                <i class="fas fa-step-forward"></i>
                            </button>
                        </div>
                        
                        <!-- 右侧：音量控制、播放模式和播放列表按钮 -->
                        <div class="secondary-controls">
                            <!-- 音量控制 -->
                            <div class="volume-control">
                                <button class="volume-btn" id="volumeMuteBtn" title="音量控制">
                                    <i class="fas fa-volume-up" id="volumeIcon"></i>
                                </button>
                                <div class="volume-slider-container">
                                    <div class="volume-percentage" id="volumePercentage">80%</div>
                                    <input type="range" min="0" max="100" value="80" class="volume-slider" id="volumeSlider">
                                </div>
                            </div>
                            
                            <!-- 播放模式按钮（移动到中间位置） -->
                            <button class="play-mode-btn" id="playModeBtn" title="列表循环">
                                <i class="fas fa-retweet" id="playModeIcon"></i>
                                <div class="play-mode-tooltip" id="playModeTooltip">列表循环</div>
                            </button>
                            
                            <!-- 播放列表按钮 -->
                            <button class="playlist-btn" id="playlistPageBtn" title="播放列表" data-count="0">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 右侧歌词面板 -->
        <div class="lyrics-panel">
            <div class="lyrics-header">
                <h2>歌词</h2>
                <p>支持 LRC 歌词文件</p>
            </div>
            
            <div class="lyrics-container">
                <div class="lyrics-content" id="lyricsContent">
                    <!-- 歌词将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 加载指示器 -->
    <div class="loader" id="loader">
        <div class="loader-content">
            <div class="loader-spinner"></div>
            <p id="loaderText">加载中...</p>
        </div>
    </div>
    
    <!-- 设置页面 -->
    <div class="settings-page" id="settingsPage">
        <div class="settings-container">
            <!-- 左侧导航栏 -->
            <div class="settings-sidebar">
                <button class="settings-nav-item active" id="navBackground" data-section="background">
                    <i class="fas fa-image"></i>
                    <span>背景设置</span>
                </button>
                <button class="settings-nav-item" id="navMusic" data-section="music">
                    <i class="fas fa-music"></i>
                    <span>音乐管理</span>
                </button>
                <button class="settings-nav-item" id="navData" data-section="data">
                    <i class="fas fa-database"></i>
                    <span>数据管理</span>
                </button>
                <button class="settings-nav-item" id="navSystem" data-section="system">
                    <i class="fas fa-info-circle"></i>
                    <span>系统信息</span>
                </button>
            </div>
            
            <!-- 右侧内容区 -->
            <div class="settings-content">
                <!-- 设置头部 - 按照要求布局 -->
                <div class="settings-header">
                    <button class="back-btn" id="backFromSettingsBtn" title="返回播放器">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2><i class="fas fa-sliders-h"></i> 设置</h2>
                    <!-- 右侧占位符，保持对称 -->
                    <div style="width: 42px;"></div>
                </div>
                
                <!-- 背景设置 -->
                <div class="settings-section active" id="sectionBackground">
                    <h3><i class="fas fa-image"></i> 背景设置</h3>
                    <div class="background-settings">
                        <div class="background-preview">
                            <img src="" alt="背景预览" id="backgroundPreview">
                        </div>
                        <div class="background-actions">
                            <button class="settings-action-btn" id="uploadBackgroundBtn">
                                <i class="fas fa-upload"></i>
                                上传背景图片
                            </button>
                            <button class="settings-action-btn" id="changeWallpaperBtn">
                                <i class="fas fa-exchange-alt"></i>
                                切换壁纸
                            </button>
                            <button class="settings-action-btn danger" id="resetBackgroundBtn">
                                <i class="fas fa-undo"></i>
                                重置为默认背景
                            </button>
                        </div>
                        <div class="blur-control">
                            <label for="blurSlider">毛玻璃效果强度</label>
                            <input type="range" min="0" max="30" value="20" class="blur-slider" id="blurSlider">
                            <div class="blur-percentage">
                                <span>0</span>
                                <span class="blur-value" id="blurValue">20px</span>
                                <span>30</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 音乐管理设置 -->
                <div class="settings-section" id="sectionMusic">
                    <h3><i class="fas fa-music"></i> 音乐管理</h3>
                    <div class="music-settings">
                        <div class="settings-action-list">
                            <button class="settings-action-btn" id="addMusicBtn">
                                <i class="fas fa-plus-circle"></i>
                                添加音乐文件
                            </button>
                            <button class="settings-action-btn danger" id="clearPlaylistBtn">
                                <i class="fas fa-trash"></i>
                                清空播放列表
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 数据管理设置 -->
                <div class="settings-section" id="sectionData">
                    <h3><i class="fas fa-database"></i> 数据管理</h3>
                    <div class="data-settings">
                        <div class="settings-action-list">
                            <button class="settings-action-btn" id="exportAudioLyricsBtn">
                                <i class="fas fa-file-archive"></i>
                                导出音频(ZIP)
                            </button>
                            <button class="settings-action-btn" id="exportDataBtn">
                                <i class="fas fa-download"></i>
                                导出元数据(JSON)
                            </button>
                            <button class="settings-action-btn" id="importDataBtn">
                                <i class="fas fa-upload"></i>
                                导入数据(ZIP/JSON)
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- 系统信息 -->
                <div class="settings-section" id="sectionSystem">
                    <h3><i class="fas fa-info-circle"></i> 系统信息</h3>
                    <div class="system-info">
                        <div class="info-item">
                            <div class="info-label">歌曲总数</div>
                            <div class="info-value" id="settingsSongCount">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">总时长</div>
                            <div class="info-value" id="totalDurationInfo">0:00</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">存储使用</div>
                            <div class="info-value" id="storageInfo">0 MB</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">应用版本</div>
                            <div class="info-value">2.5.0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 播放列表页面 -->
    <div class="playlist-page" id="playlistPage">
        <div class="playlist-container">
            <div class="playlist-header">
                <button class="back-btn" id="backToPlayerBtn" title="返回播放器">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <h2><i class="fas fa-list-music"></i> 播放列表</h2>
                <div class="playlist-sort-container">
                    <button class="sort-btn" id="sortBtn" title="切换排序">
                        <i class="fas fa-sort-amount-down"></i>
                        <span id="sortBtnText">正序</span>
                    </button>
                </div>
            </div>
            
            <!-- 播放列表统计 - 只保留当前播放项 -->
            <div class="playlist-stats">
                <div class="stats-item">
                    <div class="stats-value" id="currentPlaying">-</div>
                    <div class="stats-label">当前播放</div>
                </div>
            </div>
            
            <div class="song-list-container">
                <div id="playlistList">
                    <!-- 歌曲列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑歌曲信息模态框 -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3><i class="fas fa-edit"></i> 编辑歌曲信息</h3>
            <div class="form-group">
                <label for="editTitle">歌曲标题</label>
                <input type="text" id="editTitle" placeholder="输入歌曲标题">
            </div>
            <div class="form-group">
                <label for="editArtist">艺术家</label>
                <input type="text" id="editArtist" placeholder="输入艺术家名称">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn save-btn" id="saveEditBtn">保存</button>
                <button class="modal-btn cancel-btn" id="cancelEditBtn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑封面模态框 -->
    <div class="modal" id="coverModal">
        <div class="cover-modal-content">
            <h3><i class="fas fa-image"></i> 设置歌曲封面</h3>
            
            <div class="cover-preview">
                <img src="" alt="封面预览" id="coverPreview">
            </div>
            
            <div class="cover-upload-area" id="coverUploadArea">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>点击或拖拽图片到这里</p>
                <small>支持 JPG, PNG, GIF 格式，建议尺寸 300x300 以上</small>
            </div>
            
            <input type="file" id="coverFileInput" accept="image/*" style="display: none;">
            
            <div class="modal-buttons">
                <button class="modal-btn save-btn" id="saveCoverBtn">保存封面</button>
                <button class="modal-btn cancel-btn" id="cancelCoverBtn">取消</button>
            </div>
        </div>
    </div>

    <script>
        // 数据库配置
        const DB_NAME = 'MusicPlayerDB';
        const DB_VERSION = 10; // 版本号增加以支持新功能
        const STORE_NAME = 'songs';
        const LRC_STORE_NAME = 'lyrics';
        const COVERS_STORE_NAME = 'covers';
        const BACKGROUND_STORE_NAME = 'background';
        const WALLPAPERS_STORE_NAME = 'wallpapers';
        const METADATA_STORE_NAME = 'metadata';
        const SETTINGS_STORE_NAME = 'settings';
        
        // 存储空间限制配置
        const STORAGE_LIMIT_MB = 1024;
        let currentStorageUsage = 0;
        
        // 播放模式常量
        const PLAY_MODES = {
            LIST_LOOP: 'list_loop',    // 列表循环
            SINGLE_LOOP: 'single_loop', // 单曲循环
            RANDOM: 'random',          // 随机播放
            SEQUENTIAL: 'sequential'   // 顺序播放
        };
        
        // 播放模式显示文本
        const PLAY_MODE_TEXTS = {
            [PLAY_MODES.LIST_LOOP]: '列表循环',
            [PLAY_MODES.SINGLE_LOOP]: '单曲循环',
            [PLAY_MODES.RANDOM]: '随机播放',
            [PLAY_MODES.SEQUENTIAL]: '顺序播放'
        };
        
        // 播放模式图标
        const PLAY_MODE_ICONS = {
            [PLAY_MODES.LIST_LOOP]: 'fas fa-retweet',
            [PLAY_MODES.SINGLE_LOOP]: 'fas fa-redo',
            [PLAY_MODES.RANDOM]: 'fas fa-random',
            [PLAY_MODES.SEQUENTIAL]: 'fas fa-step-forward'
        };
        
        // 设置页面常量
        const SETTINGS_SECTIONS = ['background', 'music', 'data', 'system'];
        
        // 全局变量
        let db = null;
        let songs = [];
        let currentSongIndex = 0;
        let isPlaying = false;
        let editingSongIndex = -1;
        let volume = 0.8;
        let currentLyrics = [];
        let currentLyricsIndex = -1;
        let editingCoverSongIndex = -1;
        let currentBackground = '';
        let blurIntensity = 20;
        let wallpapers = [];
        let selectedWallpaperIndex = -1;
        let sortOrder = 'desc';
        let playMode = PLAY_MODES.LIST_LOOP; // 默认列表循环
        let blobUrlCache = new Map(); // 缓存Blob URL，防止泄漏
        let keyboardShortcutsVisible = false;
        let isKeyDown = false; // 防止键盘重复触发
        let currentSettingsSection = 'background'; // 当前设置页面
        let lyricsDelay = 0.2; // 歌词延迟补偿（秒）

        // 获取DOM元素
        const audio = new Audio();
        const welcomeScreen = document.getElementById('welcomeScreen');
        const playerContainer = document.getElementById('playerContainer');
        const songTitle = document.getElementById('songTitle');
        const songArtist = document.getElementById('songArtist');
        const albumImage = document.getElementById('albumImage');
        const albumArt = document.getElementById('albumArt');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const playlistPageBtn = document.getElementById('playlistPageBtn');
        const progressBar = document.getElementById('progressBar');
        const progress = document.getElementById('progress');
        const progressBall = document.getElementById('progressBall');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');
        const settingsBtn = document.getElementById('settingsBtn');
        const fileInput = document.getElementById('fileInput');
        const importInput = document.getElementById('importInput');
        const lrcInput = document.getElementById('lrcInput');
        const coverInput = document.getElementById('coverInput');
        const backgroundInput = document.getElementById('backgroundInput');
        const zipInput = document.getElementById('zipInput');
        const playlistPage = document.getElementById('playlistPage');
        const backToPlayerBtn = document.getElementById('backToPlayerBtn');
        const playlistList = document.getElementById('playlistList');
        const currentPlayingEl = document.getElementById('currentPlaying');
        const editModal = document.getElementById('editModal');
        const editTitleInput = document.getElementById('editTitle');
        const editArtistInput = document.getElementById('editArtist');
        const saveEditBtn = document.getElementById('saveEditBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const coverModal = document.getElementById('coverModal');
        const coverPreview = document.getElementById('coverPreview');
        const coverUploadArea = document.getElementById('coverUploadArea');
        const coverFileInput = document.getElementById('coverFileInput');
        const saveCoverBtn = document.getElementById('saveCoverBtn');
        const cancelCoverBtn = document.getElementById('cancelCoverBtn');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeMuteBtn = document.getElementById('volumeMuteBtn');
        const volumeIcon = document.getElementById('volumeIcon');
        const volumePercentage = document.getElementById('volumePercentage');
        const lyricsContent = document.getElementById('lyricsContent');
        
        // 播放模式相关元素
        const playModeBtn = document.getElementById('playModeBtn');
        const playModeIcon = document.getElementById('playModeIcon');
        const playModeTooltip = document.getElementById('playModeTooltip');
        
        // 键盘快捷键相关元素
        const keyboardShortcuts = document.getElementById('keyboardShortcuts');
        const toggleShortcutsBtn = document.getElementById('toggleShortcutsBtn');
        
        // 设置页面元素
        const settingsPage = document.getElementById('settingsPage');
        const backFromSettingsBtn = document.getElementById('backFromSettingsBtn');
        
        // 设置页面导航元素
        const navBackground = document.getElementById('navBackground');
        const navMusic = document.getElementById('navMusic');
        const navData = document.getElementById('navData');
        const navSystem = document.getElementById('navSystem');
        
        // 设置页面内容区域元素
        const sectionBackground = document.getElementById('sectionBackground');
        const sectionMusic = document.getElementById('sectionMusic');
        const sectionData = document.getElementById('sectionData');
        const sectionSystem = document.getElementById('sectionSystem');
        
        // 设置页面按钮元素
        const addMusicBtn = document.getElementById('addMusicBtn');
        const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');
        const exportAudioLyricsBtn = document.getElementById('exportAudioLyricsBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataBtn = document.getElementById('importDataBtn');
        const settingsSongCount = document.getElementById('settingsSongCount');
        const storageInfo = document.getElementById('storageInfo');
        const totalDurationInfo = document.getElementById('totalDurationInfo'); // 总时长信息
        
        // 背景设置元素
        const uploadBackgroundBtn = document.getElementById('uploadBackgroundBtn');
        const changeWallpaperBtn = document.getElementById('changeWallpaperBtn');
        const resetBackgroundBtn = document.getElementById('resetBackgroundBtn');
        const blurSlider = document.getElementById('blurSlider');
        const blurValue = document.getElementById('blurValue');
        const backgroundPreview = document.getElementById('backgroundPreview');
        
        // 自定义对话框元素
        const customDialog = document.getElementById('customDialog');
        const dialogTitle = document.getElementById('dialogTitle');
        const dialogMessage = document.getElementById('dialogMessage');
        const dialogConfirmBtn = document.getElementById('dialogConfirmBtn');
        
        // 确认对话框元素
        const confirmDialog = document.getElementById('confirmDialog');
        const confirmDialogTitle = document.getElementById('confirmDialogTitle');
        const confirmDialogMessage = document.getElementById('confirmDialogMessage');
        const confirmDialogCancelBtn = document.getElementById('confirmDialogCancelBtn');
        const confirmDialogConfirmBtn = document.getElementById('confirmDialogConfirmBtn');
        
        // 壁纸模态框元素
        const wallpaperModal = document.getElementById('wallpaperModal');
        const wallpaperGrid = document.getElementById('wallpaperGrid');
        const selectWallpaperBtn = document.getElementById('selectWallpaperBtn');
        const cancelWallpaperBtn = document.getElementById('cancelWallpaperBtn');
        
        // 排序按钮元素
        const sortBtn = document.getElementById('sortBtn');
        const sortBtnText = document.getElementById('sortBtnText');

        // ========================================
        // 辅助函数
        // ========================================

        // 辅助函数：格式化文件大小
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 辅助函数：获取文件扩展名
        function getFileExtension(filename) {
            const match = filename.match(/\.([^/.]+)$/);
            return match ? match[1].toLowerCase() : 'mp3';
        }

        // ========================================
        // 原有功能
        // ========================================

        // 初始化播放器
        async function initPlayer() {
            audio.volume = volume;
            
            showLoader('加载音乐库...');
            
            try {
                await initIndexedDB();
                await loadAllSongs();
                await loadBackground();
                await loadWallpapers();
                await loadBlurSetting();
                await loadPlayModeSetting(); // 加载播放模式设置
                applyBlurEffect();
                updateBlurValue();
                updatePlayModeUI(); // 更新播放模式UI
                renderPlaylistList();
                updateStats();
                updateSongCount();
                await updateStorageInfo();
                updateTotalDurationInfo(); // 更新总时长信息
                setupAudioEvents();
                setupUIEvents();
                setupKeyboardShortcuts(); // 设置键盘快捷键
                setupRippleEffects();
                updateVolumePercentage();
                
                if (songs.length > 0) {
                    if (currentSongIndex >= songs.length) {
                        currentSongIndex = 0;
                    }
                    await loadSong(currentSongIndex);
                }
                
                hideLoader();
                console.log("播放器初始化完成，歌曲数:", songs.length);
            } catch (error) {
                console.error("初始化失败:", error);
                hideLoader();
                customAlert("播放器初始化失败，请刷新页面重试");
            }
        }

        // 显示欢迎界面
        function setupWelcomeScreen() {
            document.addEventListener('keydown', (e) => {
                if (!playerContainer.classList.contains('active')) {
                    enterPlayer();
                }
            });
            
            document.addEventListener('click', (e) => {
                if (!playerContainer.classList.contains('active')) {
                    enterPlayer();
                }
            });
            
            document.addEventListener('touchstart', (e) => {
                if (!playerContainer.classList.contains('active')) {
                    enterPlayer();
                }
            });
        }

        // 进入播放器界面
        function enterPlayer() {
            welcomeScreen.classList.add('hidden');
            
            setTimeout(() => {
                playerContainer.classList.add('active');
                initPlayer();
            }, 300);
        }

        // 显示加载指示器
        function showLoader(text = '加载中...') {
            loaderText.textContent = text;
            loader.classList.add('active');
        }

        // 隐藏加载指示器
        function hideLoader() {
            loader.classList.remove('active');
        }

        // 设置键盘快捷键
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // 显示/隐藏快捷键提示
            toggleShortcutsBtn.addEventListener('click', () => {
                keyboardShortcutsVisible = false;
                keyboardShortcuts.classList.remove('active');
            });
            
            // 点击外部关闭快捷键提示
            document.addEventListener('click', (e) => {
                if (keyboardShortcutsVisible && 
                    !keyboardShortcuts.contains(e.target) && 
                    e.target.id !== 'settingsBtn' && 
                    e.target.id !== 'playlistPageBtn') {
                    keyboardShortcutsVisible = false;
                    keyboardShortcuts.classList.remove('active');
                }
            });
        }

        // 处理键盘按下事件
        function handleKeyDown(e) {
            // 防止重复触发
            if (isKeyDown) return;
            isKeyDown = true;
            
            // 检查是否在输入框中，避免冲突
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                return;
            }
            
            // 检查是否在模态框中
            if (editModal.style.display === 'flex' || 
                coverModal.style.display === 'flex' ||
                wallpaperModal.style.display === 'flex' ||
                customDialog.style.display === 'flex' ||
                confirmDialog.style.display === 'flex') {
                return;
            }
            
            switch (e.key) {
                case ' ': // 空格键 - 播放/暂停
                    e.preventDefault(); // 防止页面滚动
                    togglePlay();
                    break;
                    
                case 'ArrowRight': // 右箭头 - 下一首
                    e.preventDefault();
                    nextSong();
                    break;
                    
                case 'ArrowLeft': // 左箭头 - 上一首
                    e.preventDefault();
                    prevSong();
                    break;
                    
                case 'ArrowUp': // 上箭头 - 增加音量
                    e.preventDefault();
                    adjustVolume(0.05);
                    break;
                    
                case 'ArrowDown': // 下箭头 - 减少音量
                    e.preventDefault();
                    adjustVolume(-0.05);
                    break;
                    
                case 'm': // M键 - 切换播放模式
                case 'M':
                    e.preventDefault();
                    togglePlayMode();
                    break;
                    
                case '?': // 问号键 - 显示/隐藏快捷键提示
                    e.preventDefault();
                    toggleKeyboardShortcuts();
                    break;
                    
                case 'l': // L键 - 显示播放列表
                case 'L':
                    if (!playlistPage.classList.contains('active')) {
                        e.preventDefault();
                        showPlaylistPage();
                    }
                    break;
                    
                case 's': // S键 - 显示设置
                case 'S':
                    if (!settingsPage.classList.contains('active')) {
                        e.preventDefault();
                        showSettingsPage();
                    }
                    break;
                    
                case 'Escape': // ESC键 - 关闭打开的页面
                    if (playlistPage.classList.contains('active')) {
                        hidePlaylistPage();
                    } else if (settingsPage.classList.contains('active')) {
                        hideSettingsPage();
                    } else if (keyboardShortcutsVisible) {
                        keyboardShortcutsVisible = false;
                        keyboardShortcuts.classList.remove('active');
                    }
                    break;
            }
        }

        // 处理键盘释放事件
        function handleKeyUp(e) {
            isKeyDown = false;
        }

        // 调整音量
        function adjustVolume(delta) {
            let newVolume = audio.volume + delta;
            newVolume = Math.max(0, Math.min(1, newVolume)); // 限制在0-1之间
            
            audio.volume = newVolume;
            volumeSlider.value = newVolume * 100;
            updateVolumeIcon();
            updateVolumePercentage();
            localStorage.setItem('musicPlayerVolume', newVolume);
            
            // 显示音量提示
            showVolumeFeedback(newVolume);
        }

        // 显示音量反馈
        function showVolumeFeedback(volume) {
            const percentage = Math.round(volume * 100);
            volumePercentage.textContent = `${percentage}%`;
            volumePercentage.style.display = 'block';
            
            setTimeout(() => {
                volumePercentage.style.display = 'none';
            }, 1000);
        }

        // 切换键盘快捷键显示
        function toggleKeyboardShortcuts() {
            keyboardShortcutsVisible = !keyboardShortcutsVisible;
            if (keyboardShortcutsVisible) {
                keyboardShortcuts.classList.add('active');
            } else {
                keyboardShortcuts.classList.remove('active');
            }
        }

        // 设置波纹效果
        function setupRippleEffects() {
            const buttons = document.querySelectorAll('button:not(.custom-dialog-btn)');
            buttons.forEach(button => {
                button.addEventListener('click', createRipple);
            });
            
            const settingsItems = document.querySelectorAll('.settings-nav-item, .settings-action-btn');
            settingsItems.forEach(item => {
                item.addEventListener('click', createRipple);
            });
        }

        // 创建波纹效果
        function createRipple(event) {
            const button = event.currentTarget;
            const circle = document.createElement('span');
            const diameter = Math.max(button.clientWidth, button.clientHeight);
            const radius = diameter / 2;
            
            circle.style.width = circle.style.height = `${diameter}px`;
            circle.style.left = `${event.clientX - button.getBoundingClientRect().left - radius}px`;
            circle.style.top = `${event.clientY - button.getBoundingClientRect().top - radius}px`;
            circle.classList.add('ripple');
            
            const ripple = button.getElementsByClassName('ripple')[0];
            
            if (ripple) {
                ripple.remove();
            }
            
            button.appendChild(circle);
        }

        // 自定义提示框
        function customAlert(message, title = '提示') {
            return new Promise((resolve) => {
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                
                const newConfirmBtn = document.getElementById('dialogConfirmBtn');
                const handleConfirm = () => {
                    closeDialog(customDialog);
                    resolve(true);
                };
                
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter' || e.key === 'Escape') {
                        handleConfirm();
                    }
                };
                
                newConfirmBtn.onclick = handleConfirm;
                document.addEventListener('keydown', handleKeyPress);
                
                const cleanup = () => {
                    document.removeEventListener('keydown', handleKeyPress);
                    newConfirmBtn.onclick = null;
                };
                
                showDialog(customDialog);
                
                window.tempCloseDialog = (dialog) => {
                    cleanup();
                    closeDialogInternal(dialog);
                };
            });
        }

        // 自定义确认框
        function customConfirm(message, title = '确认') {
            return new Promise((resolve) => {
                confirmDialogTitle.textContent = title;
                confirmDialogMessage.textContent = message;
                
                const newConfirmBtn = document.getElementById('confirmDialogConfirmBtn');
                const newCancelBtn = document.getElementById('confirmDialogCancelBtn');
                
                const handleConfirm = () => {
                    closeDialog(confirmDialog);
                    resolve(true);
                };
                
                const handleCancel = () => {
                    closeDialog(confirmDialog);
                    resolve(false);
                };
                
                const handleKeyPress = (e) => {
                    if (e.key === 'Enter') {
                        handleConfirm();
                    } else if (e.key === 'Escape') {
                        handleCancel();
                    }
                };
                
                newConfirmBtn.onclick = handleConfirm;
                newCancelBtn.onclick = handleCancel;
                document.addEventListener('keydown', handleKeyPress);
                
                const cleanup = () => {
                    document.removeEventListener('keydown', handleKeyPress);
                    newConfirmBtn.onclick = null;
                    newCancelBtn.onclick = null;
                };
                
                showDialog(confirmDialog);
                
                window.tempCloseDialog = (dialog) => {
                    cleanup();
                    closeDialogInternal(dialog);
                };
            });
        }

        // 显示对话框
        function showDialog(dialog) {
            dialog.style.display = 'flex';
            setTimeout(() => {
                dialog.classList.remove('closing');
            }, 10);
        }

        // 关闭对话框（内部函数）
        function closeDialogInternal(dialog) {
            dialog.classList.add('closing');
            setTimeout(() => {
                dialog.style.display = 'none';
                dialog.classList.remove('closing');
            }, 300);
        }

        // 关闭对话框（外部调用）
        function closeDialog(dialog) {
            if (window.tempCloseDialog) {
                window.tempCloseDialog(dialog);
                delete window.tempCloseDialog;
            } else {
                closeDialogInternal(dialog);
            }
        }

        // 点击对话框外部关闭
        customDialog.addEventListener('click', (e) => {
            if (e.target === customDialog) {
                closeDialog(customDialog);
            }
        });

        confirmDialog.addEventListener('click', (e) => {
            if (e.target === confirmDialog) {
                closeDialog(confirmDialog);
            }
        });

        // 初始化IndexedDB
        function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    console.error("IndexedDB错误:", event.target.error);
                    reject(event.target.error);
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    
                    db.onerror = (event) => {
                        console.error("数据库错误:", event.target.error);
                    };
                    
                    console.log("IndexedDB初始化成功");
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        
                        store.createIndex('title', 'title', { unique: false });
                        store.createIndex('artist', 'artist', { unique: false });
                        store.createIndex('addedAt', 'addedAt', { unique: false });
                        store.createIndex('fileName', 'fileName', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(LRC_STORE_NAME)) {
                        const lyricsStore = db.createObjectStore(LRC_STORE_NAME, {
                            keyPath: 'songId'
                        });
                        
                        lyricsStore.createIndex('songTitle', 'songTitle', { unique: false });
                        lyricsStore.createIndex('artist', 'artist', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(COVERS_STORE_NAME)) {
                        const coversStore = db.createObjectStore(COVERS_STORE_NAME, {
                            keyPath: 'songId'
                        });
                        
                        coversStore.createIndex('songTitle', 'songTitle', { unique: false });
                        coversStore.createIndex('artist', 'artist', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(BACKGROUND_STORE_NAME)) {
                        const backgroundStore = db.createObjectStore(BACKGROUND_STORE_NAME, {
                            keyPath: 'id'
                        });
                    }
                    
                    if (!db.objectStoreNames.contains(WALLPAPERS_STORE_NAME)) {
                        const wallpapersStore = db.createObjectStore(WALLPAPERS_STORE_NAME, {
                            keyPath: 'id',
                            autoIncrement: true
                        });
                        
                        wallpapersStore.createIndex('addedAt', 'addedAt', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(METADATA_STORE_NAME)) {
                        const metadataStore = db.createObjectStore(METADATA_STORE_NAME, {
                            keyPath: 'songId'
                        });
                        
                        metadataStore.createIndex('title', 'title', { unique: false });
                        metadataStore.createIndex('artist', 'artist', { unique: false });
                        metadataStore.createIndex('album', 'album', { unique: false });
                    }
                    
                    if (!db.objectStoreNames.contains(SETTINGS_STORE_NAME)) {
                        const settingsStore = db.createObjectStore(SETTINGS_STORE_NAME, {
                            keyPath: 'id'
                        });
                    }
                };
                
                request.onblocked = () => {
                    console.warn("数据库被其他标签页阻塞");
                    customAlert("请关闭其他标签页中的音乐播放器，然后刷新页面");
                };
            });
        }

        // 保存播放模式设置
        async function savePlayModeSetting() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                try {
                    const transaction = db.transaction([SETTINGS_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(SETTINGS_STORE_NAME);
                    
                    const settingRecord = {
                        id: 'play_mode',
                        value: playMode,
                        updatedAt: new Date().toISOString()
                    };
                    
                    const request = store.put(settingRecord);
                    
                    request.onsuccess = () => {
                        console.log("播放模式设置保存成功:", playMode);
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        console.error("保存播放模式设置失败:", event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error("播放模式设置保存事务错误:", error);
                    reject(error);
                }
            });
        }

        // 加载播放模式设置
        async function loadPlayModeSetting() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([SETTINGS_STORE_NAME], 'readonly');
                const store = transaction.objectStore(SETTINGS_STORE_NAME);
                const request = store.get('play_mode');
                
                request.onsuccess = (event) => {
                    const settingRecord = event.target.result;
                    if (settingRecord && settingRecord.value) {
                        playMode = settingRecord.value;
                        console.log("加载播放模式设置成功:", playMode);
                    } else {
                        playMode = PLAY_MODES.LIST_LOOP; // 默认列表循环
                    }
                    resolve();
                };
                
                request.onerror = (event) => {
                    console.error("加载播放模式设置失败:", event.target.error);
                    playMode = PLAY_MODES.LIST_LOOP;
                    resolve();
                };
            });
        }

        // 切换播放模式
        function togglePlayMode() {
            const modes = Object.values(PLAY_MODES);
            const currentIndex = modes.indexOf(playMode);
            const nextIndex = (currentIndex + 1) % modes.length;
            playMode = modes[nextIndex];
            
            updatePlayModeUI();
            savePlayModeSetting().catch(error => {
                console.error("保存播放模式设置失败:", error);
            });
            
            // 显示当前播放模式提示
            customAlert(`已切换到 ${PLAY_MODE_TEXTS[playMode]} 模式`, "播放模式");
        }

        // 更新播放模式UI
        function updatePlayModeUI() {
            playModeIcon.className = PLAY_MODE_ICONS[playMode];
            playModeTooltip.textContent = PLAY_MODE_TEXTS[playMode];
            
            // 根据播放模式设置按钮激活状态
            playModeBtn.classList.toggle('active', playMode !== PLAY_MODES.SEQUENTIAL);
        }

        // 保存歌曲到IndexedDB - 修复版本
        async function saveSongToDB(song) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = (event) => {
                    try {
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        
                        // 修复：不要包含id字段，让数据库自动生成
                        const songData = {
                            title: song.title,
                            artist: song.artist,
                            cover: song.cover,
                            duration: "0:00",
                            fileName: song.fileName,
                            fileType: song.fileType,
                            audioData: event.target.result,
                            addedAt: new Date().toISOString(),
                            lastPlayed: null,
                            playCount: 0,
                            hasCustomCover: false,
                            metadataExtracted: false
                        };
                        
                        const request = store.add(songData);
                        
                        request.onsuccess = () => {
                            console.log("歌曲保存成功:", song.title, "ID:", request.result);
                            resolve(request.result);
                        };
                        
                        request.onerror = (event) => {
                            console.error("保存失败:", event.target.error);
                            reject(event.target.error);
                        };
                    } catch (error) {
                        console.error("事务错误:", error);
                        reject(error);
                    }
                };
                
                reader.onerror = (error) => {
                    console.error("读取文件失败:", error);
                    reject(error);
                };
                
                reader.readAsArrayBuffer(song.file);
            });
        }

        // 保存元数据到数据库
        async function saveMetadataToDB(songId, metadata) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                try {
                    const transaction = db.transaction([METADATA_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(METADATA_STORE_NAME);
                    
                    const metadataRecord = {
                        songId: songId,
                        title: metadata.title || '',
                        artist: metadata.artist || '',
                        album: metadata.album || '',
                        year: metadata.year || '',
                        genre: metadata.genre || [],
                        track: metadata.track || {},
                        disk: metadata.disk || {},
                        picture: metadata.picture || [],
                        extractedAt: new Date().toISOString()
                    };
                    
                    const request = store.put(metadataRecord);
                    
                    request.onsuccess = () => {
                        console.log("元数据保存成功，歌曲ID:", songId);
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        console.error("保存元数据失败:", event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error("元数据保存事务错误:", error);
                    reject(error);
                }
            });
        }

        // 从数据库加载元数据
        async function loadMetadataFromDB(songId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([METADATA_STORE_NAME], 'readonly');
                const store = transaction.objectStore(METADATA_STORE_NAME);
                const request = store.get(songId);
                
                request.onsuccess = (event) => {
                    const metadataRecord = event.target.result;
                    if (metadataRecord) {
                        console.log("加载元数据成功，歌曲ID:", songId);
                        resolve(metadataRecord);
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = (event) => {
                    console.error("加载元数据失败:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 保存背景到数据库
        async function saveBackgroundToDB(backgroundData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                try {
                    const transaction = db.transaction([BACKGROUND_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(BACKGROUND_STORE_NAME);
                    
                    const backgroundRecord = {
                        id: 'current_background',
                        backgroundData: backgroundData,
                        updatedAt: new Date().toISOString()
                    };
                    
                    const request = store.put(backgroundRecord);
                    
                    request.onsuccess = () => {
                        console.log("背景保存成功");
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        console.error("保存背景失败:", event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error("背景保存事务错误:", error);
                    reject(error);
                }
            });
        }

        // 保存壁纸到数据库
        async function saveWallpaperToDB(wallpaperData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                try {
                    const transaction = db.transaction([WALLPAPERS_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(WALLPAPERS_STORE_NAME);
                    
                    const wallpaperRecord = {
                        wallpaperData: wallpaperData,
                        addedAt: new Date().toISOString()
                    };
                    
                    const request = store.add(wallpaperRecord);
                    
                    request.onsuccess = () => {
                        console.log("壁纸保存成功，ID:", request.result);
                        resolve(request.result);
                    };
                    
                    request.onerror = (event) => {
                        console.error("保存壁纸失败:", event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error("壁纸保存事务错误:", error);
                    reject(error);
                }
            });
        }

        // 删除壁纸从数据库
        async function deleteWallpaperFromDB(wallpaperId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                try {
                    const transaction = db.transaction([WALLPAPERS_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(WALLPAPERS_STORE_NAME);
                    
                    const request = store.delete(wallpaperId);
                    
                    request.onsuccess = () => {
                        console.log("壁纸删除成功，ID:", wallpaperId);
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        console.error("删除壁纸失败:", event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error("壁纸删除事务错误:", error);
                    reject(error);
                }
            });
        }

        // 从数据库加载壁纸
        async function loadWallpapers() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([WALLPAPERS_STORE_NAME], 'readonly');
                const store = transaction.objectStore(WALLPAPERS_STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = (event) => {
                    const wallpapersFromDB = event.target.result;
                    console.log("从数据库加载壁纸:", wallpapersFromDB.length);
                    
                    wallpapers = wallpapersFromDB.map(wp => ({
                        id: wp.id,
                        data: wp.wallpaperData,
                        addedAt: wp.addedAt
                    }));
                    
                    resolve();
                };
                
                request.onerror = (event) => {
                    console.error("加载壁纸失败:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 保存毛玻璃设置到数据库
        async function saveBlurSettingToDB(blurValue) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                try {
                    const transaction = db.transaction([BACKGROUND_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(BACKGROUND_STORE_NAME);
                    
                    const blurRecord = {
                        id: 'blur_setting',
                        blurIntensity: blurValue,
                        updatedAt: new Date().toISOString()
                    };
                    
                    const request = store.put(blurRecord);
                    
                    request.onsuccess = () => {
                        console.log("毛玻璃设置保存成功:", blurValue);
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        console.error("保存毛玻璃设置失败:", event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error("毛玻璃设置保存事务错误:", error);
                    reject(error);
                }
            });
        }

        // 从数据库加载背景
        async function loadBackground() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([BACKGROUND_STORE_NAME], 'readonly');
                const store = transaction.objectStore(BACKGROUND_STORE_NAME);
                const request = store.get('current_background');
                
                request.onsuccess = (event) => {
                    const backgroundRecord = event.target.result;
                    if (backgroundRecord && backgroundRecord.backgroundData) {
                        currentBackground = backgroundRecord.backgroundData;
                        document.body.style.backgroundImage = `url('${currentBackground}')`;
                        backgroundPreview.src = currentBackground;
                        console.log("加载自定义背景成功");
                    } else {
                        setDefaultBackground();
                    }
                    resolve();
                };
                
                request.onerror = (event) => {
                    console.error("加载背景失败:", event.target.error);
                    setDefaultBackground();
                    resolve();
                };
            });
        }

        // 从数据库加载毛玻璃设置
        async function loadBlurSetting() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([BACKGROUND_STORE_NAME], 'readonly');
                const store = transaction.objectStore(BACKGROUND_STORE_NAME);
                const request = store.get('blur_setting');
                
                request.onsuccess = (event) => {
                    const blurRecord = event.target.result;
                    if (blurRecord && blurRecord.blurIntensity !== undefined) {
                        blurIntensity = blurRecord.blurIntensity;
                        blurSlider.value = blurIntensity;
                        console.log("加载毛玻璃设置成功:", blurIntensity);
                    } else {
                        blurIntensity = 20;
                        blurSlider.value = blurIntensity;
                    }
                    resolve();
                };
                
                request.onerror = (event) => {
                    console.error("加载毛玻璃设置失败:", event.target.error);
                    blurIntensity = 20;
                    blurSlider.value = blurIntensity;
                    resolve();
                };
            });
        }

        // 设置默认背景
        function setDefaultBackground() {
            const defaultBackgrounds = [
                'https://images.unsplash.com/photo-1511379938547-c1f69419868d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
                'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
                'https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80'
            ];
            
            const randomBg = defaultBackgrounds[Math.floor(Math.random() * defaultBackgrounds.length)];
            document.body.style.backgroundImage = `url('${randomBg}')`;
            backgroundPreview.src = randomBg;
            currentBackground = randomBg;
        }

        // 应用毛玻璃效果
        function applyBlurEffect() {
            document.documentElement.style.setProperty('--blur-intensity', `blur(${blurIntensity}px)`);
        }

        // 更新毛玻璃值显示
        function updateBlurValue() {
            const percentage = Math.round((blurIntensity / 30) * 100);
            blurValue.textContent = `${blurIntensity}px (${percentage}%)`;
        }

        // 计算当前存储使用情况
        async function calculateStorageUsage() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                let totalBytes = 0;
                
                songs.forEach(song => {
                    if (song.audioData) {
                        totalBytes += song.audioData.byteLength || 0;
                    }
                });
                
                currentStorageUsage = totalBytes;
                console.log(`当前存储使用: ${(totalBytes / (1024 * 1024)).toFixed(2)} MB`);
                resolve(totalBytes);
            });
        }

        // 计算单个文件的存储空间
        function calculateFileSize(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const arrayBuffer = event.target.result;
                    resolve(arrayBuffer.byteLength);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }

        // 创建或获取缓存的Blob URL
        function getCachedBlobUrl(songId, audioData) {
            // 如果已有缓存，先释放旧URL
            if (blobUrlCache.has(songId)) {
                const oldUrl = blobUrlCache.get(songId);
                if (oldUrl && oldUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(oldUrl);
                }
            }
            
            // 创建新的Blob URL
            const blob = new Blob([audioData], { type: 'audio/mpeg' });
            const url = URL.createObjectURL(blob);
            
            // 缓存新的URL
            blobUrlCache.set(songId, url);
            
            return url;
        }

        // 清理Blob URL缓存
        function cleanupBlobUrlCache() {
            for (const [songId, url] of blobUrlCache.entries()) {
                if (url && url.startsWith('blob:')) {
                    URL.revokeObjectURL(url);
                }
            }
            blobUrlCache.clear();
        }

        // 清理特定歌曲的Blob URL
        function cleanupSongBlobUrl(songId) {
            if (blobUrlCache.has(songId)) {
                const url = blobUrlCache.get(songId);
                if (url && url.startsWith('blob:')) {
                    URL.revokeObjectURL(url);
                }
                blobUrlCache.delete(songId);
            }
        }

        // 从IndexedDB加载所有歌曲
        async function loadAllSongs() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = async (event) => {
                    const songsFromDB = event.target.result;
                    console.log("从数据库加载歌曲:", songsFromDB.length);
                    
                    songs = [];
                    currentStorageUsage = 0;
                    
                    for (const song of songsFromDB) {
                        try {
                            if (!song.audioData) {
                                console.warn("歌曲没有音频数据:", song.title);
                                continue;
                            }
                            
                            // 使用缓存的Blob URL
                            const url = getCachedBlobUrl(song.id, song.audioData);
                            
                            let coverUrl = song.cover || getRandomCover();
                            if (song.hasCustomCover) {
                                try {
                                    const customCover = await loadCoverFromDB(song.id);
                                    if (customCover) {
                                        coverUrl = customCover;
                                    }
                                } catch (error) {
                                    console.error("加载自定义封面失败:", error);
                                }
                            }
                            
                            // 尝试加载元数据
                            let metadata = null;
                            if (song.metadataExtracted) {
                                try {
                                    metadata = await loadMetadataFromDB(song.id);
                                    if (metadata) {
                                        // 如果元数据中有更好的标题和艺术家信息，使用它们
                                        if (metadata.title && metadata.title !== song.title) {
                                            song.title = metadata.title;
                                        }
                                        if (metadata.artist && metadata.artist !== song.artist) {
                                            song.artist = metadata.artist;
                                        }
                                    }
                                } catch (error) {
                                    console.error("加载元数据失败:", song.title, error);
                                }
                            }
                            
                            // 累加存储使用
                            if (song.audioData) {
                                currentStorageUsage += song.audioData.byteLength || 0;
                            }
                            
                            songs.push({
                                id: song.id,
                                title: song.title || "未知歌曲",
                                artist: song.artist || "未知艺术家",
                                cover: coverUrl,
                                duration: song.duration || "0:00",
                                fileName: song.fileName || "未知文件",
                                fileType: song.fileType || "audio/mpeg",
                                src: url,
                                audioData: song.audioData,
                                addedAt: song.addedAt || new Date().toISOString(),
                                lastPlayed: song.lastPlayed,
                                playCount: song.playCount || 0,
                                hasLyrics: false,
                                hasCustomCover: song.hasCustomCover || false,
                                metadataExtracted: song.metadataExtracted || false,
                                metadata: metadata
                            });
                        } catch (error) {
                            console.error("转换歌曲数据失败:", song.title, error);
                        }
                    }
                    
                    const savedIndex = parseInt(localStorage.getItem('musicPlayerCurrentIndex')) || 0;
                    currentSongIndex = Math.min(savedIndex, Math.max(0, songs.length - 1));
                    
                    console.log(`加载完成，总存储使用: ${(currentStorageUsage / (1024 * 1024)).toFixed(2)} MB`);
                    
                    resolve(songs);
                };
                
                request.onerror = (event) => {
                    console.error("加载歌曲失败:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 从IndexedDB删除歌曲
        async function deleteSongFromDB(songId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME, LRC_STORE_NAME, COVERS_STORE_NAME, METADATA_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const lyricsStore = transaction.objectStore(LRC_STORE_NAME);
                const coversStore = transaction.objectStore(COVERS_STORE_NAME);
                const metadataStore = transaction.objectStore(METADATA_STORE_NAME);
                
                const deleteRequest = store.delete(songId);
                
                lyricsStore.delete(songId);
                coversStore.delete(songId);
                metadataStore.delete(songId);
                
                deleteRequest.onsuccess = () => {
                    console.log("歌曲从数据库删除:", songId);
                    resolve();
                };
                
                deleteRequest.onerror = (event) => {
                    console.error("删除歌曲失败:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 更新歌曲信息到IndexedDB
        async function updateSongInDB(song) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                const getRequest = store.get(song.id);
                
                getRequest.onsuccess = (event) => {
                    const existingSong = event.target.result;
                    if (!existingSong) {
                        reject(new Error("歌曲不存在"));
                        return;
                    }
                    
                    const updateData = {
                        ...existingSong,
                        title: song.title,
                        artist: song.artist,
                        cover: song.cover,
                        duration: song.duration,
                        lastPlayed: song.lastPlayed,
                        playCount: song.playCount,
                        hasCustomCover: song.hasCustomCover || false,
                        metadataExtracted: song.metadataExtracted || false
                    };
                    
                    const putRequest = store.put(updateData);
                    
                    putRequest.onsuccess = () => {
                        console.log("歌曲信息更新:", song.title);
                        resolve();
                    };
                    
                    putRequest.onerror = (event) => {
                        console.error("更新歌曲失败:", event.target.error);
                        reject(event.target.error);
                    };
                };
                
                getRequest.onerror = (event) => {
                    console.error("获取歌曲失败:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 保存歌词到数据库
        async function saveLyricsToDB(songId, lyricsData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                try {
                    const transaction = db.transaction([LRC_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(LRC_STORE_NAME);
                    
                    const currentSong = songs.find(s => s.id === songId);
                    const lyricsRecord = {
                        songId: songId,
                        songTitle: currentSong?.title || '',
                        artist: currentSong?.artist || '',
                        lyricsData: lyricsData,
                        addedAt: new Date().toISOString(),
                        source: 'local' // 标记来源
                    };
                    
                    const request = store.put(lyricsRecord);
                    
                    request.onsuccess = () => {
                        console.log("歌词保存成功，歌曲ID:", songId);
                        resolve();
                    };
                    
                    request.onerror = (event) => {
                        console.error("保存歌词失败:", event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error("歌词保存事务错误:", error);
                    reject(error);
                }
            });
        }

        // 从数据库加载歌词
        async function loadLyricsFromDB(songId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([LRC_STORE_NAME], 'readonly');
                const store = transaction.objectStore(LRC_STORE_NAME);
                const request = store.get(songId);
                
                request.onsuccess = (event) => {
                    const lyricsRecord = event.target.result;
                    if (lyricsRecord && lyricsRecord.lyricsData) {
                        console.log("加载歌词成功，歌曲ID:", songId);
                        resolve(lyricsRecord.lyricsData);
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = (event) => {
                    console.error("加载歌词失败:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 保存封面到数据库
        async function saveCoverToDB(songId, coverData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                try {
                    const transaction = db.transaction([COVERS_STORE_NAME, STORE_NAME], 'readwrite');
                    const coversStore = transaction.objectStore(COVERS_STORE_NAME);
                    const songsStore = transaction.objectStore(STORE_NAME);
                    
                    const currentSong = songs.find(s => s.id === songId);
                    const coverRecord = {
                        songId: songId,
                        songTitle: currentSong?.title || '',
                        artist: currentSong?.artist || '',
                        coverData: coverData,
                        addedAt: new Date().toISOString()
                    };
                    
                    const coverRequest = coversStore.put(coverRecord);
                    
                    const getRequest = songsStore.get(songId);
                    
                    getRequest.onsuccess = (event) => {
                        const songData = event.target.result;
                        if (songData) {
                            songData.hasCustomCover = true;
                            songsStore.put(songData);
                        }
                    };
                    
                    coverRequest.onsuccess = () => {
                        console.log("封面保存成功，歌曲ID:", songId);
                        resolve();
                    };
                    
                    coverRequest.onerror = (event) => {
                        console.error("保存封面失败:", event.target.error);
                        reject(event.target.error);
                    };
                } catch (error) {
                    console.error("封面保存事务错误:", error);
                    reject(error);
                }
            });
        }

        // 从数据库加载封面
        async function loadCoverFromDB(songId) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([COVERS_STORE_NAME], 'readonly');
                const store = transaction.objectStore(COVERS_STORE_NAME);
                const request = store.get(songId);
                
                request.onsuccess = (event) => {
                    const coverRecord = event.target.result;
                    if (coverRecord && coverRecord.coverData) {
                        const url = coverRecord.coverData;
                        console.log("加载自定义封面成功，歌曲ID:", songId);
                        resolve(url);
                    } else {
                        resolve(null);
                    }
                };
                
                request.onerror = (event) => {
                    console.error("加载封面失败:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 清空数据库
        async function clearDatabase() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("数据库未初始化"));
                    return;
                }
                
                const transaction = db.transaction([STORE_NAME, LRC_STORE_NAME, COVERS_STORE_NAME, METADATA_STORE_NAME, SETTINGS_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const lyricsStore = transaction.objectStore(LRC_STORE_NAME);
                const coversStore = transaction.objectStore(COVERS_STORE_NAME);
                const metadataStore = transaction.objectStore(METADATA_STORE_NAME);
                const settingsStore = transaction.objectStore(SETTINGS_STORE_NAME);
                
                const clearSongRequest = store.clear();
                const clearLyricsRequest = lyricsStore.clear();
                const clearCoversRequest = coversStore.clear();
                const clearMetadataRequest = metadataStore.clear();
                const clearSettingsRequest = settingsStore.clear();
                
                clearSongRequest.onsuccess = () => {
                    console.log("歌曲数据库已清空");
                };
                
                clearLyricsRequest.onsuccess = () => {
                    console.log("歌词数据库已清空");
                };
                
                clearCoversRequest.onsuccess = () => {
                    console.log("封面数据库已清空");
                };
                
                clearMetadataRequest.onsuccess = () => {
                    console.log("元数据数据库已清空");
                };
                
                clearSettingsRequest.onsuccess = () => {
                    console.log("设置数据库已清空");
                    resolve();
                };
                
                clearSongRequest.onerror = (event) => {
                    console.error("清空歌曲数据库失败:", event.target.error);
                    reject(event.target.error);
                };
                
                clearLyricsRequest.onerror = (event) => {
                    console.error("清空歌词数据库失败:", event.target.error);
                    reject(event.target.error);
                };
                
                clearCoversRequest.onerror = (event) => {
                    console.error("清空封面数据库失败:", event.target.error);
                    reject(event.target.error);
                };
                
                clearMetadataRequest.onerror = (event) => {
                    console.error("清空元数据数据库失败:", event.target.error);
                    reject(event.target.error);
                };
                
                clearSettingsRequest.onerror = (event) => {
                    console.error("清空设置数据库失败:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        // 设置音频事件监听器
        function setupAudioEvents() {
            audio.addEventListener('timeupdate', updateProgress);
            audio.addEventListener('loadedmetadata', updateDuration);
            audio.addEventListener('ended', handleSongEnded);
            audio.addEventListener('error', handleAudioError);
            
            audio.addEventListener('volumechange', updateVolumeIcon);
            audio.addEventListener('timeupdate', updateLyricsDisplay);
        }

        // 处理歌曲结束事件（根据播放模式）
        function handleSongEnded() {
            switch (playMode) {
                case PLAY_MODES.SINGLE_LOOP:
                    // 单曲循环：重新播放当前歌曲
                    audio.currentTime = 0;
                    audio.play();
                    break;
                    
                case PLAY_MODES.LIST_LOOP:
                    // 列表循环：播放下一首，如果到末尾则回到第一首
                    getNextSongIndex();
                    if (currentSongIndex !== -1) {
                        loadSong(currentSongIndex).then(() => {
                            if (isPlaying) {
                                audio.play();
                            }
                        });
                    }
                    break;
                    
                case PLAY_MODES.RANDOM:
                    // 随机播放：随机选择一首歌曲
                    if (songs.length > 0) {
                        currentSongIndex = Math.floor(Math.random() * songs.length);
                        loadSong(currentSongIndex).then(() => {
                            if (isPlaying) {
                                audio.play();
                            }
                        });
                    }
                    break;
                    
                case PLAY_MODES.SEQUENTIAL:
                    // 顺序播放：播放下一首，如果到末尾则停止
                    if (currentSongIndex < songs.length - 1) {
                        currentSongIndex++;
                        loadSong(currentSongIndex).then(() => {
                            if (isPlaying) {
                                audio.play();
                            }
                        });
                    } else {
                        // 播放列表结束，停止播放
                        isPlaying = false;
                        playIcon.className = 'fas fa-play';
                        albumArt.classList.remove('playing');
                    }
                    break;
            }
        }

        // 获取下一首歌曲的索引（根据播放模式）
        function getNextSongIndex() {
            if (songs.length === 0) return -1;
            
            switch (playMode) {
                case PLAY_MODES.LIST_LOOP:
                    return (currentSongIndex + 1) % songs.length;
                    
                case PLAY_MODES.RANDOM:
                    let randomIndex;
                    do {
                        randomIndex = Math.floor(Math.random() * songs.length);
                    } while (songs.length > 1 && randomIndex === currentSongIndex);
                    return randomIndex;
                    
                case PLAY_MODES.SEQUENTIAL:
                    if (currentSongIndex < songs.length - 1) {
                        return currentSongIndex + 1;
                    }
                    return -1; // 没有下一首
                    
                case PLAY_MODES.SINGLE_LOOP:
                    return currentSongIndex; // 单曲循环返回当前索引
                    
                default:
                    return (currentSongIndex + 1) % songs.length;
            }
        }

        // 获取上一首歌曲的索引
        function getPrevSongIndex() {
            if (songs.length === 0) return -1;
            
            switch (playMode) {
                case PLAY_MODES.RANDOM:
                    let randomIndex;
                    do {
                        randomIndex = Math.floor(Math.random() * songs.length);
                    } while (songs.length > 1 && randomIndex === currentSongIndex);
                    return randomIndex;
                    
                case PLAY_MODES.SEQUENTIAL:
                    if (currentSongIndex > 0) {
                        return currentSongIndex - 1;
                    }
                    return -1; // 没有上一首
                    
                default:
                    // 对于列表循环和单曲循环，正常处理
                    return (currentSongIndex - 1 + songs.length) % songs.length;
            }
        }

        // 设置UI事件监听器
        function setupUIEvents() {
            // 播放控制
            playPauseBtn.addEventListener('click', togglePlay);
            prevBtn.addEventListener('click', prevSong);
            nextBtn.addEventListener('click', nextSong);
            progressBar.addEventListener('click', setProgress);
            
            // 播放模式按钮
            playModeBtn.addEventListener('click', togglePlayMode);
            
            // 页面切换
            playlistPageBtn.addEventListener('click', showPlaylistPage);
            backToPlayerBtn.addEventListener('click', hidePlaylistPage);
            settingsBtn.addEventListener('click', showSettingsPage);
            backFromSettingsBtn.addEventListener('click', hideSettingsPage);
            
            // 设置页面导航事件
            setupSettingsNavigation();
            
            // 设置页面按钮事件
            addMusicBtn.addEventListener('click', () => {
                fileInput.click();
                hideSettingsPage();
            });
            
            clearPlaylistBtn.addEventListener('click', handleClearPlaylist);
            
            // ZIP导出导入功能
            exportAudioLyricsBtn.addEventListener('click', exportAudioZip);
            exportDataBtn.addEventListener('click', exportData);
            importDataBtn.addEventListener('click', () => {
                // 先尝试ZIP导入，如果用户取消再尝试JSON
                zipInput.click();
            });
            
            // ZIP文件导入事件
            zipInput.addEventListener('change', handleZipImport);
            
            // 背景设置事件
            uploadBackgroundBtn.addEventListener('click', () => {
                backgroundInput.click();
            });
            
            changeWallpaperBtn.addEventListener('click', showWallpaperModal);
            
            resetBackgroundBtn.addEventListener('click', resetBackground);
            
            blurSlider.addEventListener('input', (e) => {
                blurIntensity = parseInt(e.target.value);
                applyBlurEffect();
                updateBlurValue();
                saveBlurSettingToDB(blurIntensity).catch(error => {
                    console.error("保存毛玻璃设置失败:", error);
                });
            });
            
            backgroundInput.addEventListener('change', handleBackgroundUpload);
            
            // 壁纸模态框事件
            selectWallpaperBtn.addEventListener('click', selectWallpaper);
            cancelWallpaperBtn.addEventListener('click', closeWallpaperModal);
            
            // 点击壁纸模态框外部关闭
            wallpaperModal.addEventListener('click', (e) => {
                if (e.target === wallpaperModal) {
                    closeWallpaperModal();
                }
            });
            
            // 音量控制
            volumeSlider.addEventListener('input', (e) => {
                volume = e.target.value / 100;
                audio.volume = volume;
                localStorage.setItem('musicPlayerVolume', volume);
                updateVolumeIcon();
                updateVolumePercentage();
            });
            
            volumeMuteBtn.addEventListener('click', toggleMute);
            
            // 更新音量百分比显示
            volumeSlider.addEventListener('input', (e) => {
                updateVolumePercentage();
            });
            
            // 排序按钮事件
            sortBtn.addEventListener('click', toggleSortOrder);
            
            // LRC文件上传
            lrcInput.addEventListener('change', handleLrcFileSelect);
            
            // 封面编辑
            coverUploadArea.addEventListener('click', () => {
                coverFileInput.click();
            });
            
            coverUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                coverUploadArea.style.borderColor = '#9D4EDD';
                coverUploadArea.style.background = 'rgba(157, 78, 221, 0.1)';
            });
            
            coverUploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                coverUploadArea.style.borderColor = 'rgba(157, 78, 221, 0.3)';
                coverUploadArea.style.background = 'rgba(0, 0, 0, 0.1)';
            });
            
            coverUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                coverUploadArea.style.borderColor = 'rgba(157, 78, 221, 0.3)';
                coverUploadArea.style.background = 'rgba(0, 0, 0, 0.1)';
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type.startsWith('image/')) {
                        previewCoverImage(file);
                    } else {
                        customAlert('请选择图片文件');
                    }
                }
            });
            
            coverFileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    previewCoverImage(file);
                }
            });
            
            // 封面保存和取消
            saveCoverBtn.addEventListener('click', saveCustomCover);
            cancelCoverBtn.addEventListener('click', () => {
                closeModal(coverModal);
                coverFileInput.value = '';
            });
            
            // 文件选择事件
            fileInput.addEventListener('change', handleFileSelect);
            importInput.addEventListener('change', handleImportData);
            
            // 编辑模态框事件
            saveEditBtn.addEventListener('click', saveSongInfo);
            cancelEditBtn.addEventListener('click', () => {
                closeModal(editModal);
            });
            
            // 点击模态框外部关闭
            editModal.addEventListener('click', (e) => {
                if (e.target === editModal) {
                    closeModal(editModal);
                }
            });
            
            coverModal.addEventListener('click', (e) => {
                if (e.target === coverModal) {
                    closeModal(coverModal);
                    coverFileInput.value = '';
                }
            });
            
            // 页面关闭前保存数据和清理Blob URL
            window.addEventListener('beforeunload', () => {
                localStorage.setItem('musicPlayerCurrentIndex', currentSongIndex.toString());
                localStorage.setItem('musicPlayerVolume', volume.toString());
                cleanupBlobUrlCache();
            });
        }

        // 设置页面导航
        function setupSettingsNavigation() {
            // 导航按钮点击事件
            const navButtons = [navBackground, navMusic, navData, navSystem];
            const sections = [sectionBackground, sectionMusic, sectionData, sectionSystem];
            
            navButtons.forEach((button, index) => {
                button.addEventListener('click', () => {
                    // 移除所有激活状态
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    sections.forEach(section => section.classList.remove('active'));
                    
                    // 设置当前激活状态
                    button.classList.add('active');
                    sections[index].classList.add('active');
                    currentSettingsSection = button.dataset.section;
                    
                    // 如果是系统信息页面，更新总时长信息
                    if (button.dataset.section === 'system') {
                        updateTotalDurationInfo();
                    }
                });
            });
        }

        // ========================================
        // 修改的ZIP导入导出功能（移除歌词相关）
        // ========================================

        // 导出音频为ZIP文件（移除歌词功能）
        async function exportAudioZip() {
            if (songs.length === 0) {
                customAlert('播放列表为空，没有可导出的歌曲');
                return;
            }
            
            showLoader('正在创建ZIP备份文件...');
            
            try {
                const zip = new JSZip();
                
                // 创建清单文件 - 简化版
                const manifest = {
                    version: "2.5",
                    exportDate: new Date().toISOString(),
                    playerVersion: "2.5.0",
                    totalSongs: songs.length,
                    songs: []
                };
                
                // 添加音频文件
                for (let i = 0; i < songs.length; i++) {
                    const song = songs[i];
                    const fileExt = getFileExtension(song.fileName);
                    const audioFileName = `${i + 1}_${song.title.replace(/[^a-z0-9]/gi, '_')}.${fileExt}`;
                    
                    // 添加音频二进制数据
                    const audioBlob = new Blob([song.audioData], { type: song.fileType });
                    zip.file(audioFileName, audioBlob);
                    
                    // 记录到清单
                    const songManifest = {
                        id: song.id,
                        index: i,
                        audioFileName: audioFileName,
                        originalFileName: song.fileName,
                        fileType: song.fileType,
                        title: song.title,
                        artist: song.artist,
                        playCount: song.playCount || 0,
                        lastPlayed: song.lastPlayed,
                        addedAt: song.addedAt,
                        hasCustomCover: song.hasCustomCover,
                        metadataExtracted: song.metadataExtracted
                    };
                    
                    manifest.songs.push(songManifest);
                    
                    // 更新进度
                    if (i % 5 === 0 || i === songs.length - 1) {
                        loaderText.textContent = `正在打包歌曲... (${i + 1}/${songs.length})`;
                    }
                }
                
                // 添加清单文件
                zip.file("manifest.json", JSON.stringify(manifest, null, 2));
                
                // 添加说明文件
                const readmeContent = `MelodyBox 音频备份文件
                
此ZIP文件包含：
1. 所有音频文件（使用序号_歌曲名.扩展名格式）
2. manifest.json - 歌曲元数据清单

恢复说明：
1. 在MelodyBox设置中选择"导入数据"
2. 选择此ZIP文件
3. 系统将自动导入所有歌曲并提取元数据

注意：此备份仅包含音频文件，不包含歌词。歌词需手动重新上传。`;
                zip.file("README.txt", readmeContent);
                
                // 生成ZIP文件
                const content = await zip.generateAsync({
                    type: "blob",
                    compression: "DEFLATE",
                    compressionOptions: {
                        level: 6  // 中等压缩，兼顾速度和大小
                    }
                });
                
                // 提供下载
                const dateStr = new Date().toISOString().split('T')[0].replace(/-/g, '');
                const filename = `melodybox-audio-backup-${dateStr}.zip`;
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => URL.revokeObjectURL(link.href), 100);
                
                hideLoader();
                
                // 显示备份结果
                customAlert(
                    `ZIP备份完成！\n\n` +
                    `✅ 歌曲数量: ${songs.length} 首\n` +
                    `✅ 文件大小: ${formatBytes(content.size)}\n\n` +
                    `文件名: ${filename}\n\n` +
                    `备份文件已保存到您的下载文件夹。`,
                    "ZIP备份成功"
                );
                
            } catch (error) {
                console.error("创建ZIP备份失败:", error);
                hideLoader();
                customAlert("创建备份失败: " + error.message);
            }
        }

        // 处理ZIP文件导入
        async function handleZipImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.zip')) {
                // 如果不是ZIP文件，尝试JSON导入
                importInput.files = event.target.files;
                importInput.dispatchEvent(new Event('change'));
                return;
            }
            
            await importAudioZip(file);
            zipInput.value = '';
        }

        // 导入ZIP文件 - 简化版（移除歌词匹配功能）
        async function importAudioZip(file) {
            if (!file || !file.name.endsWith('.zip')) {
                customAlert('请选择ZIP格式的备份文件');
                return;
            }
            
            // 先计算当前已用存储
            await calculateStorageUsage();
            
            // 预估ZIP文件大小
            const zipSizeMB = file.size / (1024 * 1024);
            const estimatedUncompressedSizeMB = zipSizeMB * 2; // 粗略估计解压后大小
            
            if (currentStorageUsage / (1024 * 1024) + estimatedUncompressedSizeMB > STORAGE_LIMIT_MB) {
                const availableSpaceMB = STORAGE_LIMIT_MB - (currentStorageUsage / (1024 * 1024));
                customAlert(
                    `存储空间不足！\n\n` +
                    `当前已使用: ${(currentStorageUsage / (1024 * 1024)).toFixed(2)} MB\n` +
                    `预估需要: ${estimatedUncompressedSizeMB.toFixed(2)} MB\n` +
                    `存储上限: ${STORAGE_LIMIT_MB} MB\n` +
                    `可用空间: ${availableSpaceMB.toFixed(2)} MB\n\n` +
                    `请先删除一些歌曲以释放空间。`,
                    "存储空间不足"
                );
                return;
            }
            
            const confirmed = await customConfirm(
                `确定要导入ZIP备份文件吗？\n\n` +
                `文件: ${file.name}\n` +
                `大小: ${formatBytes(file.size)}\n\n` +
                `导入将添加新的歌曲，不会覆盖现有歌曲。`,
                '导入ZIP备份'
            );
            
            if (!confirmed) return;
            
            showLoader('正在解析ZIP备份文件...');
            
            try {
                // 1. 读取ZIP文件
                const zip = await JSZip.loadAsync(file);
                
                // 2. 解析manifest.json（如果存在）
                let manifest = null;
                try {
                    const manifestFile = zip.file("manifest.json");
                    if (manifestFile) {
                        const content = await manifestFile.async("text");
                        manifest = JSON.parse(content);
                        console.log("成功解析manifest.json");
                    }
                } catch (error) {
                    console.warn("manifest.json解析失败:", error);
                }
                
                // 3. 处理音频文件
                const audioFiles = [];
                zip.forEach((relativePath, zipEntry) => {
                    if (!zipEntry.dir && 
                        (zipEntry.name.toLowerCase().endsWith('.mp3') || 
                         zipEntry.name.toLowerCase().endsWith('.wav') ||
                         zipEntry.name.toLowerCase().endsWith('.flac') ||
                         zipEntry.name.toLowerCase().endsWith('.ogg') ||
                         zipEntry.name.toLowerCase().endsWith('.m4a'))) {
                        audioFiles.push({
                            name: zipEntry.name,
                            entry: zipEntry
                        });
                    }
                });
                
                if (audioFiles.length === 0) {
                    throw new Error('备份文件中没有音频文件');
                }
                
                console.log(`📁 找到 ${audioFiles.length} 个音频文件`);
                
                // 4. 逐首导入
                let successCount = 0;
                let duplicateCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < audioFiles.length; i++) {
                    const audioFile = audioFiles[i];
                    
                    try {
                        // 4.1 读取音频数据
                        const audioData = await audioFile.entry.async("arraybuffer");
                        
                        // 4.2 检查是否已存在
                        const existingIndex = songs.findIndex(song => 
                            song.fileName === audioFile.name
                        );
                        
                        if (existingIndex >= 0) {
                            console.log(`⏩ 跳过重复文件: ${audioFile.name}`);
                            duplicateCount++;
                            continue; // 跳过重复文件
                        }
                        
                        // 4.3 创建File对象（用于提取元数据）
                        const fileType = getFileExtension(audioFile.name);
                        const mimeType = `audio/${fileType === 'mp3' ? 'mpeg' : fileType}`;
                        const blob = new Blob([audioData], { type: mimeType });
                        const fileObj = new File([blob], audioFile.name, {
                            type: mimeType
                        });
                        
                        // 4.4 提取元数据
                        const metadata = await extractMetadata(fileObj);
                        
                        // 4.5 保存到数据库
                        const newSongId = await saveSongToDB({
                            title: metadata.title || audioFile.name.replace(/\.[^/.]+$/, ""),
                            artist: metadata.artist || "未知艺术家",
                            cover: metadata.picture || getRandomCover(),
                            fileName: audioFile.name,
                            fileType: mimeType,
                            file: fileObj
                        });
                        
                        // 保存元数据
                        if (metadata && (metadata.title || metadata.artist || metadata.album)) {
                            await saveMetadataToDB(newSongId, metadata);
                            
                            // 更新歌曲的元数据提取状态
                            const updateTransaction = db.transaction([STORE_NAME], 'readwrite');
                            const updateStore = updateTransaction.objectStore(STORE_NAME);
                            const getRequest = updateStore.get(newSongId);
                            
                            getRequest.onsuccess = (event) => {
                                const existingSong = event.target.result;
                                if (existingSong) {
                                    existingSong.metadataExtracted = true;
                                    updateStore.put(existingSong);
                                }
                            };
                        }
                        
                        // 4.6 创建歌曲对象并添加到内存列表
                        const url = getCachedBlobUrl(newSongId, audioData);
                        
                        const song = {
                            id: newSongId,
                            title: metadata.title || audioFile.name.replace(/\.[^/.]+$/, ""),
                            artist: metadata.artist || "未知艺术家",
                            cover: metadata.picture || getRandomCover(),
                            duration: "0:00",
                            fileName: audioFile.name,
                            fileType: mimeType,
                            src: url,
                            audioData: audioData,
                            addedAt: new Date().toISOString(),
                            lastPlayed: null,
                            playCount: 0,
                            hasLyrics: false,
                            hasCustomCover: false,
                            metadataExtracted: !!(metadata && (metadata.title || metadata.artist || metadata.album)),
                            metadata: metadata
                        };
                        
                        songs.push(song);
                        successCount++;
                        
                        // 更新存储使用
                        currentStorageUsage += audioData.byteLength || 0;
                        
                        // 更新进度
                        if (i % 3 === 0 || i === audioFiles.length - 1) {
                            loaderText.textContent = `正在导入歌曲... (${i + 1}/${audioFiles.length})`;
                        }
                        
                    } catch (songError) {
                        console.error(`❌ 歌曲导入失败 ${audioFile.name}:`, songError);
                        errorCount++;
                    }
                }
                
                // 5. 重新加载所有歌曲
                await loadAllSongs();
                renderPlaylistList();
                updateStats();
                updateSongCount();
                updateStorageInfo();
                updateTotalDurationInfo();
                
                hideLoader();
                
                // 6. 显示导入结果
                let message = `ZIP导入完成！\n\n`;
                message += `✅ 成功导入: ${successCount} 首歌曲\n`;
                if (duplicateCount > 0) {
                    message += `⏩ 跳过重复: ${duplicateCount} 首\n`;
                }
                if (errorCount > 0) {
                    message += `❌ 失败: ${errorCount} 首\n`;
                }
                message += `\n总歌曲数: ${songs.length}`;
                
                customAlert(message, "ZIP导入完成");
                
            } catch (error) {
                console.error("导入ZIP失败:", error);
                hideLoader();
                customAlert("导入失败: " + error.message);
            }
        }

        // ========================================
        // 原有功能（保持不变）
        // ========================================

        // 处理清空播放列表
        async function handleClearPlaylist() {
            if (songs.length === 0) {
                customAlert('播放列表已经是空的');
                return;
            }
            
            const confirmed = await customConfirm(`确定要清空所有 ${songs.length} 首歌曲吗？此操作不可撤销！`, "清空播放列表");
            if (!confirmed) return;
            
            try {
                showLoader('清空播放列表中...');
                
                await clearDatabase();
                
                // 清理所有Blob URL
                cleanupBlobUrlCache();
                
                songs = [];
                currentSongIndex = 0;
                currentLyrics = [];
                currentStorageUsage = 0;
                
                resetPlayer();
                
                renderPlaylistList();
                
                updateStats();
                updateSongCount();
                updateStorageInfo();
                updateTotalDurationInfo();
                
                hideSettingsPage();
                hidePlaylistPage();
                
                hideLoader();
                customAlert('播放列表已清空');
                
            } catch (error) {
                console.error("清空播放列表失败:", error);
                hideLoader();
                customAlert("清空失败: " + error.message);
            }
        }

        // 关闭模态框
        function closeModal(modal) {
            modal.classList.add('closing');
            setTimeout(() => {
                modal.style.display = 'none';
                modal.classList.remove('closing');
            }, 300);
        }

        // 更新音量百分比显示
        function updateVolumePercentage() {
            const percentage = Math.round(volumeSlider.value);
            volumePercentage.textContent = `${percentage}%`;
        }

        // 切换排序顺序
        function toggleSortOrder() {
            if (sortOrder === 'desc') {
                sortOrder = 'asc';
                sortBtn.innerHTML = '<i class="fas fa-sort-amount-up"></i><span id="sortBtnText">倒序</span>';
                sortBtn.classList.add('active');
            } else {
                sortOrder = 'desc';
                sortBtn.innerHTML = '<i class="fas fa-sort-amount-down"></i><span id="sortBtnText">正序</span>';
                sortBtn.classList.remove('active');
            }
            
            sortBtnText.textContent = sortOrder === 'desc' ? '正序' : '倒序';
            
            renderPlaylistList();
        }

        // 处理背景上传
        async function handleBackgroundUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                customAlert('请选择图片文件');
                backgroundInput.value = '';
                return;
            }
            
            try {
                showLoader('上传背景图片...');
                
                const dataUrl = await readFileAsDataURL(file);
                
                await saveBackgroundToDB(dataUrl);
                await saveWallpaperToDB(dataUrl);
                
                currentBackground = dataUrl;
                document.body.style.backgroundImage = `url('${dataUrl}')`;
                backgroundPreview.src = dataUrl;
                
                await loadWallpapers();
                
                hideLoader();
                customAlert('背景图片设置成功！');
                
            } catch (error) {
                console.error("处理背景图片失败:", error);
                hideLoader();
                customAlert("设置背景失败: " + error.message);
            } finally {
                backgroundInput.value = '';
            }
        }

        // 显示壁纸选择模态框
        async function showWallpaperModal() {
            try {
                await loadWallpapers();
                renderWallpaperGrid();
                wallpaperModal.style.display = 'flex';
                selectedWallpaperIndex = -1;
            } catch (error) {
                console.error("显示壁纸模态框失败:", error);
                customAlert("加载壁纸失败: " + error.message);
            }
        }

        // 关闭壁纸选择模态框
        function closeWallpaperModal() {
            wallpaperModal.classList.add('closing');
            setTimeout(() => {
                wallpaperModal.style.display = 'none';
                wallpaperModal.classList.remove('closing');
            }, 300);
        }

        // 渲染壁纸网格
        function renderWallpaperGrid() {
            wallpaperGrid.innerHTML = '';
            
            // 添加默认壁纸
            const defaultWallpapers = [
                'https://images.unsplash.com/photo-1511379938547-c1f69419868d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
                'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
                'https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80'
            ];
            
            defaultWallpapers.forEach((wallpaper, index) => {
                const wallpaperItem = document.createElement('div');
                wallpaperItem.className = 'wallpaper-item';
                wallpaperItem.dataset.index = `default-${index}`;
                
                wallpaperItem.innerHTML = `
                    <img src="${wallpaper}" alt="默认壁纸 ${index + 1}">
                    <div class="wallpaper-check"><i class="fas fa-check"></i></div>
                    <div class="wallpaper-item-actions">
                        <button class="wallpaper-item-action-btn select-btn" title="选择">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                `;
                
                wallpaperItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.wallpaper-item-actions')) {
                        selectWallpaperItem(wallpaperItem, `default-${index}`);
                    }
                });
                
                const selectBtn = wallpaperItem.querySelector('.select-btn');
                selectBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectWallpaperItem(wallpaperItem, `default-${index}`);
                    selectWallpaper();
                });
                
                if (currentBackground === wallpaper) {
                    wallpaperItem.classList.add('active');
                    selectedWallpaperIndex = `default-${index}`;
                }
                
                wallpaperGrid.appendChild(wallpaperItem);
            });
            
            // 添加用户上传的壁纸
            wallpapers.forEach((wallpaper, index) => {
                const wallpaperItem = document.createElement('div');
                wallpaperItem.className = 'wallpaper-item';
                wallpaperItem.dataset.index = index;
                
                wallpaperItem.innerHTML = `
                    <img src="${wallpaper.data}" alt="壁纸 ${index + 1}">
                    <div class="wallpaper-check"><i class="fas fa-check"></i></div>
                    <div class="wallpaper-item-actions">
                        <button class="wallpaper-item-action-btn select-btn" title="选择">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="wallpaper-item-action-btn delete delete-btn" title="删除">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                wallpaperItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.wallpaper-item-actions')) {
                        selectWallpaperItem(wallpaperItem, index);
                    }
                });
                
                const selectBtn = wallpaperItem.querySelector('.select-btn');
                selectBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectWallpaperItem(wallpaperItem, index);
                    selectWallpaper();
                });
                
                const deleteBtn = wallpaperItem.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const confirmed = await customConfirm('确定要删除这个壁纸吗？', '删除壁纸');
                    if (!confirmed) return;
                    
                    try {
                        await deleteWallpaperFromDB(wallpaper.id);
                        await loadWallpapers();
                        renderWallpaperGrid();
                        customAlert('壁纸删除成功！');
                    } catch (error) {
                        console.error("删除壁纸失败:", error);
                        customAlert("删除壁纸失败: " + error.message);
                    }
                });
                
                if (currentBackground === wallpaper.data) {
                    wallpaperItem.classList.add('active');
                    selectedWallpaperIndex = index;
                }
                
                wallpaperGrid.appendChild(wallpaperItem);
            });
            
            if (wallpapers.length === 0 && defaultWallpapers.length === 0) {
                wallpaperGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                        <i class="fas fa-image" style="font-size: 2rem; margin-bottom: 10px;"></i>
                        <p>还没有壁纸</p>
                        <p style="font-size: 0.8rem;">点击"上传背景图片"添加壁纸</p>
                </div>
                `;
            }
        }

        // 选择壁纸项目
        function selectWallpaperItem(item, index) {
            document.querySelectorAll('.wallpaper-item').forEach(el => {
                el.classList.remove('active');
            });
            
            item.classList.add('active');
            selectedWallpaperIndex = index;
        }

        // 选择壁纸
        async function selectWallpaper() {
            if (selectedWallpaperIndex === -1) {
                customAlert('请先选择一个壁纸');
                return;
            }
            
            try {
                showLoader('设置壁纸中...');
                
                let newBackground = '';
                
                if (typeof selectedWallpaperIndex === 'string' && selectedWallpaperIndex.startsWith('default-')) {
                    const index = parseInt(selectedWallpaperIndex.split('-')[1]);
                    const defaultWallpapers = [
                        'https://images.unsplash.com/photo-1511379938547-c1f69419868d?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
                        'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80',
                        'https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80'
                    ];
                    newBackground = defaultWallpapers[index];
                } else {
                    newBackground = wallpapers[selectedWallpaperIndex].data;
                }
                
                await saveBackgroundToDB(newBackground);
                
                currentBackground = newBackground;
                document.body.style.backgroundImage = `url('${newBackground}')`;
                backgroundPreview.src = newBackground;
                
                closeWallpaperModal();
                hideLoader();
                customAlert('壁纸切换成功！');
                
            } catch (error) {
                console.error("选择壁纸失败:", error);
                hideLoader();
                customAlert("设置壁纸失败: " + error.message);
            }
        }

        // 重置背景
        async function resetBackground() {
            const confirmed = await customConfirm('确定要重置为默认背景吗？', '重置背景');
            if (!confirmed) return;
            
            try {
                showLoader('重置背景...');
                
                if (db) {
                    const transaction = db.transaction([BACKGROUND_STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(BACKGROUND_STORE_NAME);
                    store.delete('current_background');
                }
                
                setDefaultBackground();
                
                hideLoader();
                customAlert('背景已重置为默认背景');
                
            } catch (error) {
                console.error("重置背景失败:", error);
                hideLoader();
                customAlert("重置背景失败: " + error.message);
            }
        }

        // 处理音频错误
        function handleAudioError() {
            console.error("音频播放错误:", audio.error);
            customAlert("音频播放失败，可能文件已损坏或格式不支持");
            isPlaying = false;
            playIcon.className = 'fas fa-play';
            albumArt.classList.remove('playing');
        }

        // 处理文件选择 - 修复版本
        async function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            
            if (files.length === 0) {
                return;
            }
            
            // 先计算当前已用存储
            await calculateStorageUsage();
            
            // 计算新文件的总大小
            let newFilesTotalSize = 0;
            for (const file of files) {
                try {
                    const fileSize = await calculateFileSize(file);
                    newFilesTotalSize += fileSize;
                } catch (error) {
                    console.error("计算文件大小失败:", error);
                }
            }
            
            // 转换为MB
            const currentUsageMB = currentStorageUsage / (1024 * 1024);
            const newFilesSizeMB = newFilesTotalSize / (1024 * 1024);
            const totalAfterAddMB = currentUsageMB + newFilesSizeMB;
            
            // 检查是否超过限制
            if (totalAfterAddMB > STORAGE_LIMIT_MB) {
                const availableSpaceMB = STORAGE_LIMIT_MB - currentUsageMB;
                customAlert(
                    `存储空间不足！\n\n` +
                    `当前已使用: ${currentUsageMB.toFixed(2)} MB\n` +
                    `新增文件需要: ${newFilesSizeMB.toFixed(2)} MB\n` +
                    `存储上限: ${STORAGE_LIMIT_MB} MB\n` +
                    `可用空间: ${availableSpaceMB.toFixed(2)} MB\n\n` +
                    `请删除一些歌曲后再试，或选择较小的文件。`,
                    "存储空间不足"
                );
                fileInput.value = '';
                return;
            }
            
            showLoader(`添加 ${files.length} 个音乐文件中...`);
            
            const validFiles = files.filter(file => file.type.startsWith('audio/'));
            
            if (validFiles.length === 0) {
                hideLoader();
                customAlert("没有找到有效的音频文件");
                fileInput.value = '';
                return;
            }
            
            const newFiles = [];
            const duplicateFiles = [];
            
            validFiles.forEach(file => {
                const existingIndex = songs.findIndex(song => 
                    song.fileName === file.name
                );
                
                if (existingIndex >= 0) {
                    duplicateFiles.push(file.name);
                } else {
                    newFiles.push(file);
                }
            });
            
            if (newFiles.length === 0) {
                hideLoader();
                customAlert("所有文件都已存在");
                fileInput.value = '';
                return;
            }
            
            let addedCount = 0;
            let errors = [];
            
            for (let i = 0; i < newFiles.length; i++) {
                const file = newFiles[i];
                
                try {
                    // 先提取元数据
                    const metadata = await extractMetadata(file);
                    
                    const songData = {
                        title: metadata.title || file.name.replace(/\.[^/.]+$/, ""),
                        artist: metadata.artist || "未知艺术家",
                        cover: metadata.picture || getRandomCover(),
                        duration: "0:00",
                        fileName: file.name,
                        fileType: file.type,
                        file: file,
                        metadata: metadata
                    };
                    
                    // 保存到数据库 - 修复：不要传递id字段
                    const songId = await saveSongToDB(songData);
                    
                    // 保存元数据到数据库
                    if (metadata && (metadata.title || metadata.artist || metadata.album)) {
                        await saveMetadataToDB(songId, metadata);
                        
                        // 更新歌曲的元数据提取状态
                        const updateTransaction = db.transaction([STORE_NAME], 'readwrite');
                        const updateStore = updateTransaction.objectStore(STORE_NAME);
                        const getRequest = updateStore.get(songId);
                        
                        getRequest.onsuccess = (event) => {
                            const existingSong = event.target.result;
                            if (existingSong) {
                                existingSong.metadataExtracted = true;
                                updateStore.put(existingSong);
                            }
                        };
                    }
                    
                    // 使用缓存的Blob URL
                    const url = getCachedBlobUrl(songId, await readFileAsArrayBuffer(file));
                    
                    // 创建歌曲对象
                    const song = {
                        id: songId, // 使用数据库返回的ID
                        title: songData.title,
                        artist: songData.artist,
                        cover: songData.cover,
                        duration: "0:00",
                        fileName: file.name,
                        fileType: file.type,
                        src: url,
                        audioData: await readFileAsArrayBuffer(file),
                        addedAt: new Date().toISOString(),
                        lastPlayed: null,
                        playCount: 0,
                        hasLyrics: false,
                        hasCustomCover: false,
                        metadataExtracted: true,
                        metadata: metadata
                    };
                    
                    songs.push(song);
                    addedCount++;
                    
                    // 更新存储使用
                    currentStorageUsage += song.audioData.byteLength || 0;
                    
                } catch (error) {
                    console.error("保存文件失败:", file.name, error);
                    errors.push(`${file.name}: ${error.message}`);
                }
            }
            
            if (addedCount > 0) {
                renderPlaylistList();
                updateStats();
                updateSongCount();
                updateStorageInfo();
                updateTotalDurationInfo();
                
                if (songs.length === addedCount) {
                    currentSongIndex = 0;
                    await loadSong(currentSongIndex);
                }
                
                showPlaylistPage();
            }
            
            hideLoader();
            
            let message = "";
            if (addedCount > 0) {
                message += `成功添加 ${addedCount} 首歌曲\n`;
                if (addedCount > 0) {
                    message += `已自动提取 ${addedCount} 首歌曲的元数据\n`;
                }
            }
            if (duplicateFiles.length > 0) {
                message += `\n跳过 ${duplicateFiles.length} 个重复文件:\n${duplicateFiles.join('\n')}`;
            }
            if (errors.length > 0) {
                message += `\n\n${errors.length} 个文件添加失败:\n${errors.join('\n')}`;
            }
            
            if (message) {
                customAlert(message, "文件添加结果");
            }
            
            fileInput.value = '';
        }

        // 提取音频文件元数据
        async function extractMetadata(file) {
            return new Promise((resolve, reject) => {
                try {
                    // 使用jsmediatags库提取元数据
                    jsmediatags.read(file, {
                        onSuccess: function(tag) {
                            const metadata = {
                                title: tag.tags.title || '',
                                artist: tag.tags.artist || '',
                                album: tag.tags.album || '',
                                year: tag.tags.year || '',
                                genre: tag.tags.genre || '',
                                track: tag.tags.track || '',
                                picture: null
                            };
                            
                            // 提取专辑封面
                            if (tag.tags.picture) {
                                const base64String = arrayBufferToBase64(tag.tags.picture.data);
                                const mimeType = tag.tags.picture.format || 'image/jpeg';
                                metadata.picture = `data:${mimeType};base64,${base64String}`;
                            }
                            
                            console.log("提取的元数据:", metadata);
                            resolve(metadata);
                        },
                        onError: function(error) {
                            console.warn("使用jsmediatags提取元数据失败:", error);
                            
                            // 如果jsmediatags失败，尝试使用music-metadata-browser
                            extractMetadataWithMusicMetadata(file)
                                .then(resolve)
                                .catch(error => {
                                    console.warn("所有元数据提取方法都失败:", error);
                                    resolve({
                                        title: '',
                                        artist: '',
                                        album: '',
                                        picture: null
                                    });
                                });
                        }
                    });
                } catch (error) {
                    console.error("元数据提取错误:", error);
                    extractMetadataWithMusicMetadata(file)
                        .then(resolve)
                        .catch(err => {
                            console.warn("备用元数据提取方法失败:", err);
                            resolve({
                                title: '',
                                artist: '',
                                album: '',
                                picture: null
                            });
                        });
                }
            });
        }

        // 使用music-metadata-browser提取元数据
        async function extractMetadataWithMusicMetadata(file) {
            try {
                const metadata = await window.musicMetadata.parseBlob(file);
                const result = {
                    title: metadata.common.title || '',
                    artist: metadata.common.artist || '',
                    album: metadata.common.album || '',
                    year: metadata.common.year || '',
                    genre: metadata.common.genre || [],
                    track: metadata.common.track || {},
                    disk: metadata.common.disk || {},
                    picture: null
                };
                
                // 提取专辑封面
                if (metadata.common.picture && metadata.common.picture.length > 0) {
                    const picture = metadata.common.picture[0];
                    const base64String = arrayBufferToBase64(picture.data);
                    const mimeType = picture.format || 'image/jpeg';
                    result.picture = `data:${mimeType};base64,${base64String}`;
                }
                
                console.log("使用music-metadata提取的元数据:", result);
                return result;
            } catch (error) {
                console.error("music-metadata提取失败:", error);
                throw error;
            }
        }

        // ArrayBuffer转Base64
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return window.btoa(binary);
        }

        // 处理LRC文件选择
        async function handleLrcFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.toLowerCase().endsWith('.lrc')) {
                customAlert('请选择LRC格式的歌词文件');
                lrcInput.value = '';
                return;
            }
            
            if (songs.length === 0 || currentSongIndex < 0) {
                customAlert('请先选择一首歌曲');
                lrcInput.value = '';
                return;
            }
            
            try {
                showLoader('解析歌词文件中...');
                
                const text = await readFileAsText(file);
                const parsedLyrics = parseLrcFile(text);
                
                if (parsedLyrics.length === 0) {
                    throw new Error('无法解析LRC文件内容');
                }
                
                const currentSong = songs[currentSongIndex];
                await saveLyricsToDB(currentSong.id, parsedLyrics);
                
                currentSong.hasLyrics = true;
                
                currentLyrics = parsedLyrics;
                currentLyricsIndex = -1;
                
                renderLyrics();
                
                hideLoader();
                customAlert('歌词文件加载成功！');
                
            } catch (error) {
                console.error("处理LRC文件失败:", error);
                hideLoader();
                customAlert("加载歌词文件失败: " + error.message);
            } finally {
                lrcInput.value = '';
            }
        }

        // 解析LRC文件
        function parseLrcFile(lrcText) {
            const lines = lrcText.split('\n');
            const lyrics = [];
            
            const timeTagRegex = /\[(\d+):(\d+)(?:\.(\d+))?\](.*)/;
            
            lines.forEach(line => {
                const match = line.match(timeTagRegex);
                if (match) {
                    const minutes = parseInt(match[1]);
                    const seconds = parseInt(match[2]);
                    const milliseconds = match[3] ? parseInt(match[3].padEnd(3, '0').substring(0, 3)) : 0;
                    const text = match[4].trim();
                    
                    if (text) {
                        const timeInSeconds = minutes * 60 + seconds + milliseconds / 1000;
                        lyrics.push({
                            time: timeInSeconds,
                            text: text
                        });
                    }
                }
            });
            
            lyrics.sort((a, b) => a.time - b.time);
            
            return lyrics;
        }

        // 读取文件为ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsArrayBuffer(file);
            });
        }

        // 读取文件为文本
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsText(file, 'utf-8');
            });
        }

        // 读取图片文件为base64
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (event) => resolve(event.target.result);
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // 预览封面图片
        async function previewCoverImage(file) {
            if (!file.type.startsWith('image/')) {
                customAlert('请选择图片文件');
                return;
            }
            
            try {
                const dataUrl = await readFileAsDataURL(file);
                coverPreview.src = dataUrl;
            } catch (error) {
                console.error("预览图片失败:", error);
                customAlert('图片预览失败');
            }
        }

        // 保存自定义封面
        async function saveCustomCover() {
            if (editingCoverSongIndex < 0) return;
            
            const dataUrl = coverPreview.src;
            if (!dataUrl || dataUrl === '') {
                customAlert('请先选择图片');
                return;
            }
            
            try {
                showLoader('保存封面中...');
                
                const songId = songs[editingCoverSongIndex].id;
                
                await saveCoverToDB(songId, dataUrl);
                
                songs[editingCoverSongIndex].cover = dataUrl;
                songs[editingCoverSongIndex].hasCustomCover = true;
                
                if (editingCoverSongIndex === currentSongIndex) {
                    albumImage.src = dataUrl;
                }
                
                renderPlaylistList();
                
                await updateSongInDB(songs[editingCoverSongIndex]);
                
                hideLoader();
                
                closeModal(coverModal);
                coverFileInput.value = '';
                editingCoverSongIndex = -1;
                
                customAlert('封面设置成功！');
                
            } catch (error) {
                console.error("保存封面失败:", error);
                hideLoader();
                customAlert("保存封面失败: " + error.message);
            }
        }

        // 导出数据（JSON格式，元数据）
        async function exportData() {
            try {
                showLoader('准备导出元数据...');
                
                const exportData = {
                    version: '2.5',
                    exportDate: new Date().toISOString(),
                    songCount: songs.length,
                    songs: songs.map(song => ({
                        id: song.id,
                        title: song.title,
                        artist: song.artist,
                        cover: song.cover,
                        duration: song.duration,
                        fileName: song.fileName,
                        fileType: song.fileType,
                        addedAt: song.addedAt,
                        lastPlayed: song.lastPlayed,
                        playCount: song.playCount,
                        hasCustomCover: song.hasCustomCover,
                        metadataExtracted: song.metadataExtracted,
                        metadata: song.metadata
                    }))
                };
                
                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `melodybox-metadata-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                hideLoader();
                customAlert(`成功导出 ${songs.length} 首歌曲的元数据\n\n注意：此文件仅包含元数据，不包含音频文件本身。`, "元数据导出成功");
                
            } catch (error) {
                console.error("导出数据失败:", error);
                hideLoader();
                customAlert("导出数据失败: " + error.message);
            }
        }

        // 导入数据（JSON格式）
        async function handleImportData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.name.endsWith('.json')) {
                customAlert('请选择JSON格式的备份文件');
                importInput.value = '';
                return;
            }
            
            const confirmed = await customConfirm('导入元数据将覆盖当前的播放列表，确定要继续吗？', '导入元数据');
            if (!confirmed) {
                importInput.value = '';
                return;
            }
            
            try {
                showLoader('导入元数据中...');
                
                const text = await readFileAsText(file);
                const data = JSON.parse(text);
                
                if (!data.version || !data.songs) {
                    throw new Error('无效的备份文件格式');
                }
                
                await clearDatabase();
                
                // 清理所有Blob URL
                cleanupBlobUrlCache();
                
                songs = [];
                currentSongIndex = 0;
                currentLyrics = [];
                
                resetPlayer();
                renderPlaylistList();
                updateStats();
                updateSongCount();
                updateStorageInfo();
                updateTotalDurationInfo();
                
                hideLoader();
                customAlert(`备份文件包含 ${data.songCount} 首歌曲的元数据。\n\n由于音频文件较大，需要您重新选择对应的音频文件。\n\n请确保音频文件的文件名与备份中的文件名匹配。`, "元数据导入完成");
                
                importInput.value = '';
                
            } catch (error) {
                console.error("导入数据失败:", error);
                hideLoader();
                customAlert("导入数据失败: " + error.message);
                importInput.value = '';
            }
        }

        // 获取随机封面
        function getRandomCover() {
            const covers = [
                'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80',
                'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80',
                'https://images.unsplash.com/photo-1520523839897-bd0b52f945a0?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80',
                'https://images.unsplash.com/photo-1439853949127-fa647821eba0?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80',
                'https://images.unsplash.com/photo-1511379938547-c1f69419868d?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80'
            ];
            return covers[Math.floor(Math.random() * covers.length)];
        }

        // 显示播放列表页面
        function showPlaylistPage() {
            playlistPage.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // 隐藏播放列表页面
        function hidePlaylistPage() {
            playlistPage.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // 显示设置页面
        function showSettingsPage() {
            settingsPage.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // 隐藏设置页面
        function hideSettingsPage() {
            settingsPage.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // 更新歌曲计数
        function updateSongCount() {
            const count = songs.length;
            settingsSongCount.textContent = count;
            playlistPageBtn.setAttribute('data-count', count);
        }

        // 更新存储信息
        async function updateStorageInfo() {
            try {
                // 计算实际使用存储
                await calculateStorageUsage();
                
                const usedMB = currentStorageUsage / (1024 * 1024);
                const percentage = (usedMB / STORAGE_LIMIT_MB) * 100;
                
                // 设置显示文本
                storageInfo.textContent = `${usedMB.toFixed(2)} MB / ${STORAGE_LIMIT_MB} MB (${percentage.toFixed(1)}%)`;
                
                // 如果超过80%使用率，添加警告样式
                storageInfo.className = 'info-value';
                if (percentage > 80) {
                    storageInfo.classList.add('storage-warning');
                }
                if (percentage > 95) {
                    storageInfo.classList.add('storage-critical');
                }
                
            } catch (error) {
                console.error("获取存储信息失败:", error);
                storageInfo.textContent = '未知';
            }
        }

        // 更新总时长信息（用于设置页面）
        function updateTotalDurationInfo() {
            let totalSeconds = 0;
            songs.forEach(song => {
                if (song.duration && song.duration !== "0:00") {
                    const [mins, secs] = song.duration.split(':').map(Number);
                    totalSeconds += mins * 60 + secs;
                }
            });
            
            const totalMins = Math.floor(totalSeconds / 60);
            const totalSecs = totalSeconds % 60;
            totalDurationInfo.textContent = `${totalMins}:${totalSecs < 10 ? '0' : ''}${totalSecs}`;
        }

        // 更新统计信息
        function updateStats() {
            // 只更新当前播放信息，移除总时长信息
            if (songs.length > 0 && currentSongIndex < songs.length) {
                currentPlayingEl.textContent = songs[currentSongIndex].title;
            } else {
                currentPlayingEl.textContent = '-';
            }
        }

        // 加载歌曲
        async function loadSong(index) {
            if (songs.length === 0) return;
            
            const song = songs[index];
            
            try {
                // 使用缓存的Blob URL
                audio.src = blobUrlCache.get(song.id) || song.src;
                
                const titleElement = songTitle;
                titleElement.textContent = song.title;
                
                if (song.title.length > 30) {
                    titleElement.classList.add('long');
                } else {
                    titleElement.classList.remove('long');
                }
                
                songArtist.textContent = song.artist;
                
                // 使用元数据中的封面或默认封面
                if (song.cover && song.cover.startsWith('data:image')) {
                    albumImage.src = song.cover;
                } else {
                    albumImage.src = song.cover || getRandomCover();
                }
                
                updateStats();
                
                song.lastPlayed = new Date().toISOString();
                song.playCount = (song.playCount || 0) + 1;
                
                updateSongInDB(song).catch(error => {
                    console.error("更新播放记录失败:", error);
                });
                
                await loadLyricsForSong(song.id);
                
                await tryAutoDetectLrc(song);
                
                if (isPlaying) {
                    await audio.play();
                }
                
                console.log("加载歌曲成功:", song.title);
            } catch (error) {
                console.error("加载歌曲失败:", error);
                customAlert(`无法加载歌曲 "${song.title}"`);
            }
        }

        // 尝试自动检测LRC文件
        async function tryAutoDetectLrc(song) {
            if (song.hasLyrics) return;
            
            const lyricsData = await loadLyricsFromDB(song.id);
            if (lyricsData && lyricsData.length > 0) {
                currentLyrics = lyricsData;
                song.hasLyrics = true;
                renderLyrics();
                return;
            }
        }

        // 加载歌曲歌词
        async function loadLyricsForSong(songId) {
            try {
                const lyricsData = await loadLyricsFromDB(songId);
                
                if (lyricsData && lyricsData.length > 0) {
                    currentLyrics = lyricsData;
                    songs[currentSongIndex].hasLyrics = true;
                    renderLyrics();
                } else {
                    currentLyrics = [];
                    songs[currentSongIndex].hasLyrics = false;
                    renderNoLyrics();
                }
                
                currentLyricsIndex = -1;
                
            } catch (error) {
                console.error("加载歌词失败:", error);
                currentLyrics = [];
                renderNoLyrics();
            }
        }

        // 渲染歌词
        function renderLyrics() {
            if (currentLyrics.length === 0) {
                renderNoLyrics();
                return;
            }
            
            lyricsContent.innerHTML = '';
            
            currentLyrics.forEach((lyric, index) => {
                const lyricLine = document.createElement('div');
                lyricLine.className = 'lyrics-line';
                lyricLine.textContent = lyric.text;
                lyricLine.dataset.index = index;
                lyricLine.dataset.time = lyric.time;
                
                lyricsContent.appendChild(lyricLine);
            });
            
            updateLyricsDisplay();
            
            setTimeout(() => {
                const middleLine = Math.floor(currentLyrics.length / 3);
                if (middleLine > 0 && middleLine < currentLyrics.length) {
                    const lineElement = lyricsContent.querySelector(`[data-index="${middleLine}"]`);
                    if (lineElement) {
                        lineElement.scrollIntoView({
                            behavior: 'auto',
                            block: 'center'
                        });
                    }
                }
            }, 100);
        }

        // 渲染无歌词状态
        function renderNoLyrics() {
            lyricsContent.innerHTML = '';
            
            const noLyricsDiv = document.createElement('div');
            noLyricsDiv.className = 'no-lyrics';
            noLyricsDiv.innerHTML = `
                <i class="fas fa-music"></i>
                <h3>当前音乐暂无歌词</h3>
                <p>当前播放的歌曲没有可用的歌词</p>
            `;
            
            lyricsContent.appendChild(noLyricsDiv);
        }

        // 更新歌词显示（优化同步）
        function updateLyricsDisplay() {
            if (currentLyrics.length === 0 || !audio.currentTime) return;
            
            const currentTime = audio.currentTime + lyricsDelay; // 添加延迟补偿
            let newIndex = -1;
            
            for (let i = 0; i < currentLyrics.length; i++) {
                if (currentTime >= currentLyrics[i].time) {
                    newIndex = i;
                } else {
                    break;
                }
            }
            
            if (newIndex !== currentLyricsIndex) {
                currentLyricsIndex = newIndex;
                
                const allLines = lyricsContent.querySelectorAll('.lyrics-line');
                allLines.forEach(line => {
                    line.classList.remove('active', 'past', 'future');
                });
                
                if (currentLyricsIndex >= 0) {
                    const currentLine = lyricsContent.querySelector(`[data-index="${currentLyricsIndex}"]`);
                    if (currentLine) {
                        currentLine.classList.add('active');
                        
                        currentLine.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                    }
                    
                    for (let i = 0; i < currentLyricsIndex; i++) {
                        const pastLine = lyricsContent.querySelector(`[data-index="${i}"]`);
                        if (pastLine) pastLine.classList.add('past');
                    }
                    
                    for (let i = currentLyricsIndex + 1; i < currentLyrics.length; i++) {
                        const futureLine = lyricsContent.querySelector(`[data-index="${i}"]`);
                        if (futureLine) futureLine.classList.add('future');
                    }
                }
            }
        }

        // 渲染播放列表
        function renderPlaylistList() {
            console.log("渲染播放列表，歌曲数量:", songs.length);
            playlistList.innerHTML = '';
            
            if (songs.length === 0) {
                playlistList.innerHTML = `
                    <div class="empty-playlist">
                        <i class="fas fa-music"></i>
                        <h3>播放列表为空</h3>
                        <p>点击右上角设置按钮添加音乐文件</p>
                    </div>
                `;
                return;
            }
            
            // 根据排序顺序排序歌曲
            let sortedSongs = [...songs];
            if (sortOrder === 'desc') {
                sortedSongs.sort((a, b) => new Date(b.addedAt) - new Date(a.addedAt));
            } else {
                sortedSongs.sort((a, b) => new Date(a.addedAt) - new Date(b.addedAt));
            }
            
            sortedSongs.forEach((song, displayIndex) => {
                const originalIndex = songs.findIndex(s => s.id === song.id);
                const songItem = document.createElement('div');
                songItem.className = `song-item ${originalIndex === currentSongIndex ? 'active' : ''}`;
                songItem.dataset.index = originalIndex;
                
                // 计算显示编号
                const displayNumber = displayIndex + 1;
                
                // 检查是否有元数据
                const hasMetadata = song.metadataExtracted;
                const metadataInfo = hasMetadata ? ' · 有元数据' : '';
                
                songItem.innerHTML = `
                    <div class="song-number">${displayNumber}</div>
                    <img src="${song.cover}" alt="${song.title}" onerror="this.src='https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80'">
                    <div class="song-item-info">
                        <div class="song-item-title">${song.title}</div>
                        <div class="song-item-artist">${song.artist}</div>
                        <div class="song-item-meta">
                            ${song.playCount ? `播放 ${song.playCount} 次` : '未播放'}
                            ${song.hasLyrics ? ' · 有歌词' : ''}
                            ${song.hasCustomCover ? ' · 自定义封面' : ''}
                            ${metadataInfo}
                        </div>
                    </div>
                    <div class="song-item-duration">${song.duration}</div>
                    <div class="song-item-actions">
                        <button class="action-btn lrc-btn" title="上传歌词">
                            <i class="fas fa-file-alt"></i>
                        </button>
                        <button class="action-btn cover-btn" title="设置封面">
                            <i class="fas fa-image"></i>
                        </button>
                        <button class="action-btn edit-btn" title="编辑信息">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" title="删除歌曲">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                songItem.addEventListener('click', (e) => {
                    if (!e.target.closest('.song-item-actions')) {
                        playSong(originalIndex);
                        hidePlaylistPage();
                    }
                });
                
                const lrcBtn = songItem.querySelector('.lrc-btn');
                lrcBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    uploadLrcForSong(originalIndex);
                });
                
                const coverBtn = songItem.querySelector('.cover-btn');
                coverBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openCoverModal(originalIndex);
                });
                
                const editBtn = songItem.querySelector('.edit-btn');
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    openEditModal(originalIndex);
                });
                
                const deleteBtn = songItem.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const confirmed = await customConfirm(`确定要删除 "${song.title}" 吗？`, "删除歌曲");
                    if (!confirmed) return;
                    
                    try {
                        const songId = song.id;
                        
                        await deleteSongFromDB(songId);
                        
                        // 清理该歌曲的Blob URL
                        cleanupSongBlobUrl(songId);
                        
                        // 减少存储使用
                        if (song.audioData) {
                            currentStorageUsage -= song.audioData.byteLength || 0;
                        }
                        
                        if (originalIndex === currentSongIndex) {
                            audio.pause();
                            isPlaying = false;
                            playIcon.className = 'fas fa-play';
                            albumArt.classList.remove('playing');
                            
                            if (songs.length > 1) {
                                currentSongIndex = Math.min(originalIndex, songs.length - 2);
                            } else {
                                currentSongIndex = 0;
                            }
                        } else if (originalIndex < currentSongIndex) {
                            currentSongIndex--;
                        }
                        
                        songs.splice(originalIndex, 1);
                        
                        renderPlaylistList();
                        
                        updateStats();
                        updateSongCount();
                        updateStorageInfo();
                        updateTotalDurationInfo();
                        
                        if (songs.length === 0) {
                            resetPlayer();
                        } else if (currentSongIndex >= 0) {
                            await loadSong(currentSongIndex);
                        }
                        
                        console.log("歌曲已删除，当前歌曲数:", songs.length);
                        
                    } catch (error) {
                        console.error("删除歌曲失败:", error);
                        customAlert("删除失败: " + error.message);
                    }
                });
                
                playlistList.appendChild(songItem);
            });
            
            console.log("播放列表渲染完成");
        }

        // 为指定歌曲上传LRC文件
        function uploadLrcForSong(index) {
            if (index < 0 || index >= songs.length) return;
            
            const originalIndex = currentSongIndex;
            currentSongIndex = index;
            
            lrcInput.click();
            
            setTimeout(() => {
                currentSongIndex = originalIndex;
            }, 100);
        }

        // 打开编辑模态框
        function openEditModal(index) {
            editingSongIndex = index;
            const song = songs[index];
            editTitleInput.value = song.title;
            editArtistInput.value = song.artist;
            editModal.style.display = 'flex';
        }

        // 打开封面编辑模态框
        function openCoverModal(index) {
            editingCoverSongIndex = index;
            const song = songs[index];
            coverPreview.src = song.cover;
            coverModal.style.display = 'flex';
        }

        // 保存歌曲信息
        async function saveSongInfo() {
            if (editingSongIndex < 0) return;
            
            const newTitle = editTitleInput.value.trim();
            const newArtist = editArtistInput.value.trim();
            
            if (newTitle) {
                songs[editingSongIndex].title = newTitle;
            }
            
            if (newArtist) {
                songs[editingSongIndex].artist = newArtist;
            }
            
            try {
                await updateSongInDB(songs[editingSongIndex]);
                
                if (editingSongIndex === currentSongIndex) {
                    const titleElement = songTitle;
                    titleElement.textContent = songs[editingSongIndex].title;
                    
                    if (songs[editingSongIndex].title.length > 30) {
                        titleElement.classList.add('long');
                    } else {
                        titleElement.classList.remove('long');
                    }
                    
                    songArtist.textContent = songs[editingSongIndex].artist;
                }
                
                renderPlaylistList();
                
                closeModal(editModal);
                editingSongIndex = -1;
                
                console.log("歌曲信息已保存");
                
            } catch (error) {
                console.error("保存歌曲信息失败:", error);
                customAlert("保存失败: " + error.message);
            }
        }

        // 重置播放器
        function resetPlayer() {
            audio.pause();
            audio.src = '';
            isPlaying = false;
            playIcon.className = 'fas fa-play';
            albumArt.classList.remove('playing');
            songTitle.textContent = '欢迎使用 MelodyBox';
            songTitle.classList.remove('long');
            songArtist.textContent = '点击右上角设置按钮添加音乐文件';
            albumImage.src = 'https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?ixlib=rb-4.0.3&auto=format&fit=crop&w=300&q=80';
            progress.style.width = '0%';
            progressBall.classList.remove('visible');
            currentTimeEl.textContent = '0:00';
            durationEl.textContent = '0:00';
            
            renderNoLyrics();
            
            // 重置统计信息
            currentPlayingEl.textContent = '-';
        }

        // 播放/暂停
        async function togglePlay() {
            if (songs.length === 0) {
                customAlert('请先添加音乐文件');
                showSettingsPage();
                return;
            }
            
            if (isPlaying) {
                pauseSong();
            } else {
                await playSong(currentSongIndex);
            }
        }

        // 播放歌曲
        async function playSong(index) {
            if (songs.length === 0) return;
            
            if (index !== currentSongIndex) {
                currentSongIndex = index;
                await loadSong(currentSongIndex);
            }
            
            try {
                await audio.play();
                isPlaying = true;
                playIcon.className = 'fas fa-pause';
                albumArt.classList.add('playing');
                updateStats();
            } catch (error) {
                console.error("播放失败:", error);
                isPlaying = false;
                playIcon.className = 'fas fa-play';
                albumArt.classList.remove('playing');
                customAlert("播放失败，请确保音频文件有效！");
            }
        }

        // 暂停歌曲
        function pauseSong() {
            audio.pause();
            isPlaying = false;
            playIcon.className = 'fas fa-play';
            albumArt.classList.remove('playing');
        }

        // 下一首
        async function nextSong() {
            if (songs.length === 0) return;
            
            const nextIndex = getNextSongIndex();
            if (nextIndex !== -1 && nextIndex !== currentSongIndex) {
                currentSongIndex = nextIndex;
                await loadSong(currentSongIndex);
                if (isPlaying) {
                    await audio.play();
                }
            } else if (nextIndex === -1) {
                // 没有下一首（顺序播放模式到达末尾）
                customAlert("已播放到列表末尾", "播放结束");
            }
        }

        // 上一首
        async function prevSong() {
            if (songs.length === 0) return;
            
            const prevIndex = getPrevSongIndex();
            if (prevIndex !== -1 && prevIndex !== currentSongIndex) {
                currentSongIndex = prevIndex;
                await loadSong(currentSongIndex);
                if (isPlaying) {
                    await audio.play();
                }
            } else if (prevIndex === -1) {
                // 没有上一首（顺序播放模式在第一首）
                customAlert("已经是第一首歌曲", "播放开始");
            }
        }

        // 音量控制
        function toggleMute() {
            if (audio.volume > 0) {
                localStorage.setItem('musicPlayerLastVolume', audio.volume);
                audio.volume = 0;
                volumeSlider.value = 0;
            } else {
                const lastVolume = parseFloat(localStorage.getItem('musicPlayerLastVolume')) || 0.8;
                audio.volume = lastVolume;
                volumeSlider.value = lastVolume * 100;
            }
            updateVolumeIcon();
            updateVolumePercentage();
        }

        // 更新音量图标
        function updateVolumeIcon() {
            if (audio.volume === 0) {
                volumeIcon.className = 'fas fa-volume-mute';
            } else if (audio.volume < 0.5) {
                volumeIcon.className = 'fas fa-volume-down';
            } else {
                volumeIcon.className = 'fas fa-volume-up';
            }
        }

        // 更新进度条
        function updateProgress() {
            const { currentTime, duration } = audio;
            
            const progressPercent = (currentTime / duration) * 100;
            progress.style.width = `${progressPercent}%`;
            
            if (!isNaN(duration) && duration > 0) {
                const progressBarWidth = progressBar.clientWidth;
                const ballPosition = (progressPercent / 100) * progressBarWidth;
                progressBall.style.left = `${ballPosition}px`;
                
                if (!progressBall.classList.contains('visible')) {
                    progressBall.classList.add('visible');
                }
            }
            
            currentTimeEl.textContent = formatTime(currentTime);
            
            if (!isNaN(duration) && duration > 0) {
                songs[currentSongIndex].duration = formatTime(duration);
                durationEl.textContent = formatTime(duration);
                
                const durationElement = document.querySelector(`.song-item[data-index="${currentSongIndex}"] .song-item-duration`);
                if (durationElement) {
                    durationElement.textContent = formatTime(duration);
                }
                
                if (songs[currentSongIndex].duration === "0:00") {
                    updateSongInDB(songs[currentSongIndex]).catch(error => {
                        console.error("更新时长失败:", error);
                    });
                }
            }
        }

        // 更新总时长
        function updateDuration() {
            durationEl.textContent = formatTime(audio.duration);
        }

        // 设置进度
        function setProgress(e) {
            const width = this.clientWidth;
            const clickX = e.offsetX;
            const duration = audio.duration;
            
            if (!isNaN(duration)) {
                audio.currentTime = (clickX / width) * duration;
            }
        }

        // 格式化时间
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds === Infinity) return '0:00';
            
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            setupWelcomeScreen();
            
            const savedVolume = parseFloat(localStorage.getItem('musicPlayerVolume'));
            if (savedVolume && !isNaN(savedVolume)) {
                volume = savedVolume;
                audio.volume = volume;
                volumeSlider.value = volume * 100;
                updateVolumeIcon();
                updateVolumePercentage();
            }
        });
    </script>
</body>
</html>